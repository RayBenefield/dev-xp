import { resolve } from 'path';
import describe from 'tape-bdd';
import withBlueTape from 'blue-tape';
import checkPackages from '@kikd/check-packages';

describe(
    'Check Packages',
    it => {
        it('should return empty results when no arguments are given', assert =>
            checkPackages().then(result => assert.deepEqual(result, [])));

        it('should return empty results with empty packages', assert =>
            checkPackages({ packages: [] }).then(result =>
                assert.deepEqual(result, []),
            ));

        it('should return a failing check for a package with no package.json', assert =>
            checkPackages({
                packages: [
                    {
                        dir: resolve(__dirname, 'fixtures/empty-dir'),
                    },
                ],
            }).then(result =>
                assert.deepEqual(result, [
                    {
                        dir: resolve(__dirname, 'fixtures/empty-dir'),
                        publishable: false,
                    },
                ]),
            ));

        it('should return a failing check for a package with no name', assert =>
            checkPackages({
                packages: [
                    {
                        dir: resolve(
                            __dirname,
                            'fixtures/module-empty-package-json',
                        ),
                        // eslint-disable-next-line global-require, import/no-dynamic-require
                        ...require(resolve(
                            __dirname,
                            'fixtures/module-empty-package-json/package.json',
                        )),
                    },
                ],
            }).then(result =>
                assert.deepEqual(result, [
                    {
                        dir: resolve(
                            __dirname,
                            'fixtures/module-empty-package-json',
                        ),
                        publishable: false,
                    },
                ]),
            ));

        it('should return a passing check for a package with main index.js', assert =>
            checkPackages({
                packages: [
                    {
                        dir: resolve(__dirname, 'fixtures/simple-hello-module'),
                        // eslint-disable-next-line global-require, import/no-dynamic-require
                        ...require(resolve(
                            __dirname,
                            'fixtures/simple-hello-module/package.json',
                        )),
                    },
                ],
            }).then(result =>
                assert.deepEqual(result, [
                    {
                        dir: resolve(__dirname, 'fixtures/simple-hello-module'),
                        name: 'simple-hello-module',
                        publishable: true,
                    },
                ]),
            ));
    },
    withBlueTape,
);
