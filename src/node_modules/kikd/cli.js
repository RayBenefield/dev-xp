import 'loud-rejection/register';
import { configure } from 'kli';

import style from '@kikd/cli-style';
import packageListTemplate from '@kikd/template-package-list';
import checkedPackagesTemplate from '@kikd/template-checked-packages';
import updatePackagesTemplate from '@kikd/template-update-packages';

import list from '@kikd/command-list';
import check from '@kikd/command-check';
import build from '@kikd/command-build';
import version from '@kikd/command-version';

import buildPackages from '@kikd/build-packages';
import updatePackages from '@kikd/update-packages';
import setupGit from '@kikd/ci-setup-git';
import deployGit from '@kikd/ci-deploy-git';
import deployNpm from '@kikd/ci-deploy-npm';

const kli = configure({ defaultStyle: process.env.CI ? {} : style });

const cli = kli({
    commands: [
        {
            name: 'list',
            aliases: ['ls'],
            template: packageListTemplate,
            run: list,
        },
        {
            name: 'check',
            template: checkedPackagesTemplate,
            run: check,
        },
        {
            name: 'build',
            renderer: () => {},
            run: build,
            effect: buildPackages,
        },
        {
            name: 'version',
            aliases: ['update'],
            template: updatePackagesTemplate,
            run: version,
            effect: (...args) => {
                const { TRAVIS_BRANCH, TRAVIS_PULL_REQUEST } = process.env;

                if (
                    TRAVIS_BRANCH !== 'master' ||
                    TRAVIS_PULL_REQUEST !== 'false'
                ) {
                    console.log('Not versioning since this is not master.');
                    return null;
                }
                return setupGit()
                    .then(() => updatePackages(...args))
                    .then(() => deployGit());
            },
        },
        {
            name: 'publish',
            aliases: ['deploy'],
            renderer: () => {},
            run: list,
            effect: deployNpm,
        },
    ],
});

cli.execute(process.argv.slice(2));
