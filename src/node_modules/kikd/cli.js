import 'loud-rejection/register';
import style from '@kikd/cli-style';
import findPackages from '@kikd/find-packages';
import findRepoRoot from '@kikd/find-repo-root';
import checkPackages from '@kikd/check-packages';
import buildPackages from '@kikd/build-packages';
import { configure, jsonRenderer } from 'kli';
import { transmute, isolate } from 'transmutation';
import findBaseConfig from '@kikd/find-base-config';
import formatPackageList from '@kikd/format-package-list';
import buildRollupConfigs from '@kikd/build-rollup-configs';

const kli = configure({ defaultStyle: style });

const cli = kli({
    commands: [
        {
            name: 'list',
            aliases: ['ls'],
            template: formatPackageList,
            run: () =>
                transmute({})
                    .extend('root', findRepoRoot)
                    .extend('exclude', ['**/fixtures/**'])
                    .extend('packages', findPackages)
                    .then(isolate('packages')),
        },
        {
            name: 'check',
            renderer: jsonRenderer,
            run: () =>
                transmute({})
                    .extend('root', findRepoRoot)
                    .extend('baseConfig', findBaseConfig)
                    .extend('exclude', ['**/fixtures/**'])
                    .extend('packages', findPackages)
                    .extend('checkedPackages', checkPackages)
                    .then(isolate('checkedPackages')),
        },
        {
            name: 'build',
            renderer: () => {},
            run: () =>
                transmute({})
                    .extend('root', findRepoRoot)
                    .extend('baseConfig', findBaseConfig)
                    .extend('exclude', ['**/fixtures/**'])
                    .extend('unfiltered', findPackages)
                    .extend('packages', ({ unfiltered }) =>
                        unfiltered.filter(p => p.bin),
                    )
                    .extend('configs', buildRollupConfigs)
                    .then(buildPackages),
        },
    ],
});

cli.execute(process.argv.slice(2));
