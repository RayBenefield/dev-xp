import '@dev-xp/config'
import argv from 'argv'
import { from } from 'rxjs'
import { mergeMap, tap } from 'rxjs/operators'
import { logger, db } from '@rampant/ai'
import createWit from '@rampant-wit/plugin'

const { WIT_TOKEN } = process.env

argv.version('v0.0.0')
argv.info('Sync the training from Wit.ai to Rampant')

argv.option([
    {
        name: 'name',
        short: 'n',
        type: 'string',
        description: 'Name of sync to',
        example: '--name=channel-name',
    },
])

const { options: { name } } = argv.run()

if (!name) {
    logger.error('Project required!')
    process.exit(1)
}

const wit = createWit({ token: WIT_TOKEN, projectId: name, db })

from(db.get(`projects/${name}/intents`).then(intents => Object.keys(intents)))
    .pipe(
        mergeMap(intents => from(intents)),
        mergeMap(intent =>
            wit
                .getSamples(intent)
                .then(samples => samples.map(({ text }) => text))
                .then(samples => ({ intent, samples }))
        ),
        tap(({ intent, samples }) =>
            db.set(`projects/${name}/training/${intent}`, { samples })
        )
    )
    .subscribe()
