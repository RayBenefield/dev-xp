local operate = require('rx.operator')
local observer = require('rx.observer')

return function(size)
    return operate(function(source, destination)
        local buffer = {}
        local seen = 0

        local next = function(val)
            table.insert(buffer, val)
            if (#buffer >= size) then
                destination.next(buffer)
                buffer = {}
            end
        end

        local complete = function()
            if (#buffer > 0) then
                destination.next(buffer)
            end

            buffer = nil
            destination.complete()
        end

        source.subscribe(
            observer(
                destination,
                next,
                nil,
                complete
            )
        )
    end)
end
