local create = require('rx.observable.create')

return function(projection)
    if (not projection) then
        return false
    end

    return function(source)
        return create(function(destination)
            local active = 0
            local isComplete = false
            local checkComplete = function()
                if (active <= 0 and isComplete) then
                    destination.complete()
                end
            end

            source.subscribe(
                function(...)
                    local inner = projection(...)
                    active = active + 1
                    inner.subscribe(
                        destination.next,
                        destination.err,
                        function()
                            active = active - 1
                            checkComplete()
                        end
                    )
                end,
                nil,
                function()
                    isComplete = true
                    checkComplete()
                end
            )
        end)
    end
end
