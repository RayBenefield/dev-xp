local util = require('util')
local operate = require('rx.operators.operate')
local create = require('rx.observable.create')
local createObserver = require('rx.observer.create')

return function(...)
    local sources = {...}
    sources = not util.isObservable(sources[1])
        and sources[1] or sources

    local base = sources[#sources]

    return operate(function(source, destination)
        local completed = 0
        local subscriptions = {}

        local complete = function()
            completed = completed + 1

            if (completed == #sources) then
                destination.complete()
            end
        end

        local newDestination = createObserver(destination, nil, nil, complete)

        for i = 1, #sources - 1 do
            newDestination.add(sources[i].subscribe(destination.next, destination.err, complete))
        end

        source.subscribe(newDestination)
    end)(base)
end
