local create = require('rx.observable.create')
local createObserver = require('rx.observer.create')

return function(...)
    local sources = {...}
    local base = sources[#sources]

    return base.lift(function(destination)
        local completed = 0
        local subscriptions = {}

        local next = function(...)
            return destination.next(...)
        end

        local err = function(...)
            return destination.err(...)
        end

        local complete = function(i)
            return function()
                completed = completed + 1

                if (completed == #sources) then
                    destination.complete()
                end
            end
        end

        local newDestination = createObserver(next, err, complete(1))

        for i = 1, #sources - 1 do
            newDestination.add(sources[i].subscribe(next, err, complete(i)))
        end

        return newDestination
    end)
end
