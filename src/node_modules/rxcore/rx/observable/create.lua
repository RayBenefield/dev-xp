local util = require('util')
local createObserver = require('rx.observer.create')

local isObserver = util.isObserver
local isFunction = util.isFunction

local create

create = function(thisSubscribe, parentSource)
    local observable
    local operator

    local subscribe = function(observerOrNext, err, complete)
        local destination

        if (isObserver(observerOrNext)) then
            destination = observerOrNext
        else
            destination = createObserver(observerOrNext, err, complete)
        end

        if (isFunction(thisSubscribe)) then
            destination.add(thisSubscribe(destination, parentSource))
        end

        return destination
    end

    local pipe = function(...)
        local args = {...}
        args = type(args[1]) == 'table' and args[1] or args
        local operators = util.onlyFunctions(args)
        local operatorCount = #operators

        if (operatorCount <= 0) then
            return observable
        end

        if (operatorCount == 1) then
            return operators[1](observable)
        end

        return util.reduce(operators, function(source, operator)
            return operator(source)
        end, observable)
    end

    local lift = function(operator)
        return create(operator, observable)
    end

    observable = { subscribe = subscribe, lift = lift, pipe = pipe }

    return observable
end

return create
