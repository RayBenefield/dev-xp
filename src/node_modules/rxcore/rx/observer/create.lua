local util = require('util')
local createSubscription = require('rx.subscription.create')

local isObserver = util.isObserver
local isSubscription = util.isSubscription
local isFunction = util.isFunction

return function(destination, maybeNext, maybeErr, maybeComplete)
    local next
    local err
    local complete

    if (isObserver(destination)) then
        next = maybeNext or util.noop
        err = maybeErr or util.printError
        complete = maybeComplete or util.noop
    else
        next = destination or util.noop
        err = maybeNext or util.printError
        complete = maybeErr or util.noop
    end

    local stopped = false
    local subscription = createSubscription()

    local observer = {
        next = function(...)
            if (not stopped) then
                next(...)
                if (isObserver(destination)) then
                    destination.next(...)
                end
            end
        end,
        err = function(...)
            if (not stopped) then
                stopped = true
                err(...)
                if (isObserver(destination)) then
                    destination.err(...)
                end
                subscription.unsubscribe()
            end
        end,
        complete = function()
            if (not stopped) then
                stopped = true
                complete()
                if (isObserver(destination)) then
                    destination.complete()
                end
                subscription.unsubscribe()
            end
        end,
        add = subscription.add,
        unsubscribe = subscription.unsubscribe,
    }

    if (isSubscription(destination)) then
        destination.add(observer)
    end

    return observer
end
