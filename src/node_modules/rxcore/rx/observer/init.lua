local util = require('util')
local subscription = require('rx.subscription')

return function(destination, maybeNext, maybeErr, maybeComplete)
    local next
    local err
    local complete

    if (util.isObserver(destination)) then
        next = maybeNext or util.noop
        err = maybeErr or util.printError
        complete = maybeComplete or util.noop
    else
        next = destination or util.noop
        err = maybeNext or util.printError
        complete = maybeErr or util.noop
    end

    local stopped = false
    local subscription = subscription()

    local observer = {
        next = function(...)
            if (not stopped) then
                next(...)
                if (util.isObserver(destination) and not maybeNext) then
                    destination.next(...)
                end
            end
        end,
        err = function(...)
            if (not stopped) then
                stopped = true
                err(...)
                if (util.isObserver(destination) and not maybeErr) then
                    destination.err(...)
                end
                subscription.unsubscribe()
            end
        end,
        complete = function()
            if (not stopped) then
                stopped = true
                complete()
                if (util.isObserver(destination) and not maybeComplete) then
                    destination.complete()
                end
                subscription.unsubscribe()
            end
        end,
        add = subscription.add,
        unsubscribe = subscription.unsubscribe,
    }

    if (util.isSubscription(destination)) then
        destination.add(observer)
    end

    return observer
end
