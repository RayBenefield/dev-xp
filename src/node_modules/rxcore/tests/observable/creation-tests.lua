local Task = require('task')
local global = require('global')
local assert = require('luassert')
local assertAll = require('assert-all')

local rx = require('rx')
local of = require('rx.observable.of')
local from = require('rx.observable.from')
local timer = require('rx.observable.timer')
local EMPTY = require('rx.observable.empty')
local create = require('rx.observable.create')

describe('Observable Creation', function()
    describe('create()', function()
        it('is included in rx object', function()
            assert.no.is_nil(rx.observable.create)
        end)

        it('imitates of() operator', function()
            local test_ = create(function(subscriber)
                subscriber.next('hello')
                subscriber.complete()
            end)

            test_.subscribe(function(val)
                assert.are.equal('hello', val)
            end)
        end)

        it('imitates timer() operator', function()
            local test_ = create(function(subscriber)
                Task.Spawn(function()
                    Task.Wait(500)
                    subscriber.next('hello')
                    Task.Wait(500)
                    subscriber.complete()
                end)
            end)

            local next = function(val) assert.are.equal('hello', val) end
            local complete = function() assert.are.equal(true, true) end
            test_.subscribe(next, nil, complete)
        end)
    end)

    describe('of()', function()
        it('is included in rx object', function()
            assert.no.is_nil(rx.observable.of)
        end)

        it('works with a basic string', function()
            local test_ = of('hello')

            test_.subscribe(function(val)
                assert.are.equal('hello', val)
            end)
        end)
    end)

    describe('from()', function()
        it('is included in rx object', function()
            assert.no.is_nil(rx.observable.from)
        end)

        it('works with a basic array', function()
            local test_ = from({'hello', 'world'})

            local assertNext = assertAll({'hello', 'world'})
            test_.subscribe(assertNext)
        end)

        it('works with a hashtable', function()
            local test_ = from({
                hello = 'world',
                goodbye = 'world',
            })

            local assertNext = assertAll({
                hello = 'world',
                goodbye = 'world'
            })
            test_.subscribe(assertNext)
        end)
    end)

    describe('timer()', function()
        setup(function() global('Task', Task) end)

        it('is included in rx object', function()
            assert.no.is_nil(rx.observable.timer)
        end)

        it('works with a delay', function()
            local test_ = timer(500)

            test_.subscribe(function(val)
                assert.are.equal(0, val)
            end)
        end)

        teardown(function() global('Task', nil) end)
    end)

    describe('empty()', function()
        it('is included in rx object', function()
            assert.no.is_nil(rx.observable.EMPTY)
        end)

        it('does not call next', function()
            local test_ = EMPTY
            local seen = 0

            test_.subscribe(
                function(val)
                    seen = seen + 1
                end,
                nil,
                function()
                    assert.are.equal(0, seen)
                end
            )
        end)
    end)
end)
