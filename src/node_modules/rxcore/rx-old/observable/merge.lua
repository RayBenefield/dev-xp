local util = require('util')
local from = require('rx.observable.from')
local EMPTY = require('rx.observable.empty')
local create = require('rx.observable.create')
local mergeMap = require('rx.operators.mergeMap')

local isObservable = util.isObservable
local onlyObservables = util.onlyObservables

return function(...)
    local sources = {...}
    if (#sources == 1) then
        if (isObservable(sources[1])) then
            print('►►►solo')
            return sources[1]
        end

        if (isTable(sources[1])) then
            sources = sources[1]
        end
    end

    sources = onlyObservables(sources)

    if (#sources <= 0) then
        print('►►►empty')
        return EMPTY
    end

    local base = sources[1]

    print('►►►merge')
    return base.lift(function(destination)
        local completed = 0

        local complete = function()
            completed = completed + 1

            if (completed == #sources) then
                destination.complete()
            end
        end

        for _, source in pairs(sources) do
            source.subscribe(
                destination.next,
                destination.err,
                complete
            )
        end
    end)
end
