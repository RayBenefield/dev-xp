local assert = require('luassert.assert')
local spy = require('luassert.spy')
local util = require('util')
local createObserver = require('rx.observer.create')

local OBSERVABLE_KEY = '__stream_state'
local NULL = '__nil__'

local is = function(state) return state end

local observable = function(state, args, level)
    rawset(state, OBSERVABLE_KEY, args[1])
    return state
end

local observableSpy = function(observable)
    local onNextSpy = spy.new(function() end)
    local onErrorSpy = spy.new(function() end)
    local onCompletedSpy = spy.new(function() end)
    local observer = createObserver(
        function (...) onNextSpy(...) end,
        function (...) onErrorSpy(...) end,
        function () onCompletedSpy() end
    )
    observable.subscribe(observer)
    return onNextSpy, onErrorSpy, onCompletedSpy
end

local produce = function(state, args, level)
    local _ = rawget(state, OBSERVABLE_KEY)

    local onNext, onError, onComplete = observableSpy(_)
    local nextCalls = onNext.calls
    local received = {}
    local expected = {}

    for key, val in pairs(nextCalls) do
        table.insert(received, val.vals[1])
    end

    for i = 1, args['n'] do
        if (args[i]) then
            table.insert(expected, args[i])
        else
            table.insert(expected, NULL)
        end
    end

    local assertCalls = #received == #expected
    if (not assertCalls)then
        util.printTable(received, 'Received')
        util.printTable(expected, 'Expected')
    end
    assert(assertCalls, 'expected '..#expected..' calls, received '..#received..' calls')

    for key, val in pairs(received) do
        if (expected[key] == NULL) then
            assert.to.equal(expected[key], nil)
        else
            assert.to.equal(expected[key], val)
        end
    end

    assert.spy(onComplete).was.called(1)

    return true
end

assert:register('modifier', 'expect', observable)
assert:register('modifier', 'to', util.identity)
assert:register('assertion', 'produce', produce)

return function(...) return assert.expect(...) end
