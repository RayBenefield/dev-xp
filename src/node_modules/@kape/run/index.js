import sha from 'sha.js';
import transmute from 'transmutation';
import { obj as stream } from 'through2';
import isFunction from 'lodash.isfunction';
import { render as serialize } from 'prettyjson';

const runTest = subject =>
    transmute()
        .extend('actual', ({ input }) => Promise.resolve(subject(...input)))
        .extend('snapshot', ({ actual }) =>
            serialize(actual, { noColor: true }),
        );

const collectTests = examples => {
    const tests = [];
    const skipped = [];
    const it = (...args) => {
        const [test, setup] = args;

        // TODO: Needs testing for sure
        // Support major variations:
        // it('should string', given => given())
        // it(given => given())
        // it('has snapshots', [[], [], []])
        // snapshot([], [], [])

        const { testName, testSetup } =
            typeof test === 'string' && isFunction(setup) // eslint-disable-line no-nested-ternary
                ? { testName: test, testSetup: setup }
                : typeof test === 'string' && Array.isArray(setup) // eslint-disable-line no-nested-ternary
                  ? { testName: test, testSetup: given => given(setup) }
                  : isFunction(test)
                    ? { testName: 'snapshot', testSetup: test }
                    : /* eslint-disable indent */
                      {
                          testName: 'snapshot',
                          testSetup: given => given(...args),
                      };

        testSetup((...inputs) => {
            inputs.forEach((input, index) => {
                if (input)
                    tests.push({
                        id: sha('sha256')
                            .update(serialize(input, { noColor: true }))
                            .digest('hex'),
                        test: testName,
                        index: index + 1,
                        input,
                    });
                else skipped.push({ test: testName, index });
            });
        });
    };
    examples(it);
    return tests;
};

export default (suite, subject, examples) => {
    const testStream = stream();
    const tests = collectTests(examples);
    Promise.all(
        tests.map(test =>
            runTest(subject)(test).then(result => testStream.push(result)),
        ),
    ).then(() => testStream.push(null));
    return testStream;
};
