import sha from 'sha.js';
import serialize from 'pretty-format';
import transmute from 'transmutation';
import { obj as stream } from 'through2';

const testStream = stream();
const suitesCompleted = {};

const runTest = subject =>
    transmute()
        .extend('actual', ({ input }) => Promise.resolve(subject(...input)))
        .extend('snapshot', ({ actual }) => serialize(actual))
        .do(result => testStream.push(result));

const collectTests = examples => {
    const tests = [];
    const it = (test, setup) => {
        let inputs = [];
        const given = args => {
            inputs = [...inputs, ...args];
        };
        setup(given);
        inputs.forEach((input, index) =>
            tests.push({
                id: sha('sha256')
                    .update(serialize(input))
                    .digest('hex'),
                test,
                index,
                input,
            }),
        );
    };
    examples(it);
    return tests;
};

export default (suite, subject, examples) => {
    const tests = collectTests(examples);
    suitesCompleted[suite] = false;
    Promise.all(tests.map(runTest(subject))).then(() => {
        suitesCompleted[suite] = true;
        const weAreDone = Object.values(suitesCompleted).every(
            status => status === true,
        );
        if (weAreDone) testStream.push(null);
    });
    return testStream;
};
