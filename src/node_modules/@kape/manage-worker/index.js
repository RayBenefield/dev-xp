import print from '@kape/print';
import child from 'child_process';
import sortBy from 'lodash.sortby';
import { obj as stream } from 'through2';
import updateSnapshots from '@kape/update-snapshots';
import sequentialPromises from '@kape/sequential-promises';

const testStream = stream();
const workersCompleted = {};

export default ({ file }) => {
    if (file in workersCompleted) return Promise.resolve();
    const fileProcess = child.fork(file);
    workersCompleted[file] = false;
    fileProcess.on('message', msg => {
        if (!msg.kape) return;

        switch (msg.type) {
            case 'result': {
                testStream.push(msg.payload);
                break;
            }
            case 'end': {
                workersCompleted[file] = true;
                const weAreDone = Object.values(workersCompleted).every(
                    status => status === true,
                );
                if (weAreDone) testStream.push(null);
                break;
            }
            default:
        }
    });
    return Promise.resolve();
};

const allResults = [];
testStream.on('data', result => allResults.push(result));
testStream.on('end', () =>
    print(sortBy(allResults, 'suite', 'test', 'index')).then(files =>
        sequentialPromises(
            Object.entries(files).map(([suite, results]) => () =>
                updateSnapshots({ file: results[0].file, suite, results }),
            ),
        ).then(() => process.exit()),
    ),
);
