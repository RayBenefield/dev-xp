import chalk from 'chalk'
import log from '@dev-xp/log'
import diff from '@kape/diff'
import prompt from '@kape/prompt'
import { render as prettyPrint } from 'prettyjson'

export default result => {
    const { index, suite, test, actual, snapshot } = result
    const { snapshotMatched, previousSnapshot } = result

    if (snapshotMatched) return Promise.resolve(result)

    log(
        previousSnapshot
            ? chalk`
{green.bold ────────────────────────────────────────────────────────────────────────────────}
{green.bold test:} {cyan ${test} #${index}}
{green.bold ────────────────────────────────────────────────────────────────────────────────}
${diff(previousSnapshot, snapshot)}
{green.bold ────────────────────────────────────────────────────────────────────────────────}`
            : chalk`
{green.bold ────────────────────────────────────────────────────────────────────────────────}
{green.bold NEW SNAPSHOT:} {cyan ${test} #${index}}
{green.bold ────────────────────────────────────────────────────────────────────────────────}
${prettyPrint(actual)}
{green.bold ────────────────────────────────────────────────────────────────────────────────}`
    )

    return prompt({
        type: 'confirm',
        default: false,
        message: chalk`${
            previousSnapshot ? 'Update' : 'ADD'
        } [{reset.cyan ${suite}}{white.bold ] [}{reset.cyan ${test} #${index}}{white.bold ]?}`,
    }).then(answer => {
        if (answer === 'n' && !previousSnapshot) return undefined
        return answer === 'y'
            ? /* eslint-disable indent */
              {
                  ...result,
                  finalSnapshot: snapshot,
              }
            : /* eslint-disable indent */
              {
                  ...result,
                  finalSnapshot: previousSnapshot || snapshot,
              }
    })
}
