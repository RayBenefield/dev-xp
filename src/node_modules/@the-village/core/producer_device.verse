
using. /Verse.org/Assets
using. /Fortnite.com/Devices
using. /Verse.org/Simulation
using. /Fortnite.com/Devices/CreativeAnimation
using. /UnrealEngine.com/Temporary/SpatialMath

using. Anima
using. Tableau
using. TableauDevice
using. TableauResource
using. Vertex

producer_device<public> := class(creative_device, config_device, side_effect_device):
    @editable Settings<public>:producer_settings = producer_settings{}
    GetResources<override>():[]resource= array. CreateProducerResource(Settings)

    @editable Building:creative_prop = creative_prop{}
    @editable VFXRef:creative_prop = creative_prop{}
    @editable BarProp:creative_prop_asset = DefaultCreativePropAsset
    var Bar:?creative_prop = false

    Hologram:material = TableauAssets.UI.MI_BlueHologram
    Summer:material = ResizedKayKitMedieval.Materials.MI_Summer
    BuildVFX:?particle_system = option. TycoonPack.Particles.Smoke.P_Building
    ProduceVFXs:[]particle_system = array:
        TycoonPack.Particles.Money.P_CoinBurst_1
        TycoonPack.Particles.Money.P_CoinBurst_5
        TycoonPack.Particles.Money.P_CoinBurst_10
        TycoonPack.Particles.Money.P_CoinBurst_25
        TycoonPack.Particles.Money.P_CoinBurst_50
        TycoonPack.Particles.Money.P_CoinBurst_100

    GetResourceID<override>()<computes>:?string= option. Settings.ID
    GetPerType<override>()<computes>:?string= false
    GetPerSubType<override>()<computes>:?string= option. "Player"
    GetSideEffects<override>(GameState:game_state, ProducerID:string, PlayerID:string)<suspends>:[]side_effect=
        Building.Hide()
        Building.SetMaterial(Hologram)

        Loc := GetTransform().Translation
        BuildingLoc := Building.GetTransform().Translation
        VFXLoc := VFXRef.GetTransform().Translation

        set Bar = SpawnProp(BarProp, Loc, IdentityRotation())(0)
        Duration := GameState.GetFloatProp(ProducerID, "Production Rate", PlayerID).Latest
        if (Anim := Bar?.GetAnimationController[]):
            Invisible := frame. Transformers := array. ScaleXBy(-1.0)
            Anim.SetAnimation(array. Invisible.Delta(), ?Mode:=animation_mode.OneShot)
            Anim.Play()
            Sleep(0.0)
            Frames:[]frame = array:
                frame. Transformers := array. ScaleXBy(-1.0)
                frame{ Time := Duration, Transformers := array. ScaleXBy(2.0) }
                frame. Transformers := array. ScaleXBy(-0.5)
            Anim.SetAnimation(Frames.Deltas(), ?Mode:=animation_mode.OneShot)

        Tier := GameState.GetFloatProp(ProducerID, "Tier", PlayerID).Latest.ToInt()
        ProduceVFX := ProduceVFXs[Tier-1] or TycoonPack.Particles.Money.P_CoinBurst_1

        array:
            play_animation{ Focus := Path(ProducerID, "Start Produced Count"), Prop := Bar }
            toggle_prop{ Focus := Path("Exists"), Prop := option. Building }
            toggle_material{ Focus := Path("Has Some"), Prop := option. Building, True := Summer, False := Hologram }
            spawn_vfx{ Focus := Path("Count"), Location := BuildingLoc, VFX := BuildVFX }
            spawn_vfx{ Focus := Path("Produced Count"), Location := VFXLoc, VFX := option. ProduceVFX }

    UpdateAnimation(Duration:float):void=
        if (Anim := Bar?.GetAnimationController[]):
            KeyFrames:[]keyframe_delta = array:
                keyframe_delta:
                    DeltaLocation := vector3{}
                    DeltaRotation := IdentityRotation()
                    DeltaScale := vector3{X:=-1.0, Y:=1.0, Z:=1.0}
                    Time := 0.0
                keyframe_delta:
                    DeltaLocation := vector3{}
                    DeltaRotation := IdentityRotation()
                    DeltaScale := vector3{X:=2.0, Y:=1.0, Z:=1.0}
                    Time := Duration
                keyframe_delta:
                    DeltaLocation := vector3{}
                    DeltaRotation := IdentityRotation()
                    DeltaScale := vector3{X:=-0.5, Y:=1.0, Z:=1.0}
                    Time := 0.0
            Anim.SetAnimation(KeyFrames, ?Mode:=animation_mode.OneShot)
