
using { /Fortnite.com/Devices }
using { /Verse.org/Simulation }
using { /Fortnite.com/Devices/CreativeAnimation }
using { /UnrealEngine.com/Temporary/SpatialMath }

using { Tableau }

play_anim_fn := class():
    Prop:creative_prop
    FN<public>():void= if (Anim := Prop.GetAnimationController[]). Anim.Play()

producer_progress_device<public> := class(creative_device, tableau_device):
    @editable ResourceID:string = ""
    @editable StartPropertyID:string = ""
    @editable DurationPropertyID:string = ""
    @editable GuardPropertyID:?string = false
    @editable ProgressBar:creative_prop = creative_prop{}

    Init<override>(GameState:game_state)<suspends>:void=
        Watcher := participant_watcher{ GameState := GameState, OnPossessed := HandleProgress }
        spawn. Watcher.Start()

    HandleProgress(GameState:game_state, ParticipantID:string, Agent:agent)<suspends>:void=
        if (G := GuardPropertyID?). GameState.AfterTrue(ResourceID, G, ParticipantID)

        PlayAnim := play_anim_fn. Prop := ProgressBar

        spawn. GameState.SyncFloat(ResourceID, DurationPropertyID, ParticipantID, UpdateAnimation)
        GameState.OnUpdated(ResourceID, StartPropertyID, ParticipantID, PlayAnim.FN)

    UpdateAnimation(Duration:float):void=
        if (Anim := ProgressBar.GetAnimationController[]):
            KeyFrames:[]keyframe_delta = array:
                keyframe_delta:
                    DeltaLocation := vector3{}
                    DeltaRotation := IdentityRotation()
                    DeltaScale := vector3{X:=-1.0, Y:=1.0, Z:=1.0}
                    Time := 0.0
                keyframe_delta:
                    DeltaLocation := vector3{}
                    DeltaRotation := IdentityRotation()
                    DeltaScale := vector3{X:=2.0, Y:=1.0, Z:=1.0}
                    Time := Duration
                keyframe_delta:
                    DeltaLocation := vector3{}
                    DeltaRotation := IdentityRotation()
                    DeltaScale := vector3{X:=-0.5, Y:=1.0, Z:=1.0}
                    Time := 0.0
            Anim.SetAnimation(KeyFrames, ?Mode:=animation_mode.OneShot)
