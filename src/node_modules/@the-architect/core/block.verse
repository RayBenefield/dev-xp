
using. /Fortnite.com/Devices
using. /Verse.org/Simulation
using. /UnrealEngine.com/Temporary/SpatialMath

using. Tableau
using. Vertex

block_type_entry := class<public><concrete>():
    @editable Type<public>:string = ""
    @editable Prop<public>:creative_prop_asset = DefaultCreativePropAsset

# TODO: Replace with generic asset map
AddEntry(Entry:block_type_entry, All:[string]creative_prop_asset)<transacts>:[string]creative_prop_asset=
    var NewEntry:[string]creative_prop_asset = map{}
    if. set NewEntry[Entry.Type] = Entry.Prop
    ConcatenateMaps(All, NewEntry)

block_device<public> := class(tableau_device):
    @editable ResourceID<override>:string = "Block"
    @editable DefaultBlock:creative_prop_asset = DefaultCreativePropAsset
    @editable BlockTypes:[]block_type_entry = array{}

    GetResources<override>():[]resource= array:
        resource:
            Type := ResourceID
            Props := map:
                "Height" => Integer of (Path(Path("CREATOR ID"), "Blocks"), "Find", Path("ID"))
                "Height Increment" => Float of 64.0
                "Z Coord" => Float of (Path("Height"), "*", Path("Height Increment"))
                "Location" => Vec3 of (Path(Path("CREATOR ID"), "XY Location"), "Append", Path("Z Coord") )
                "Block Type" => prop_str. DefaultFrom := option. (Path(Path("Type Selector", "Selection"), "Selection"))

    GetSideEffects<override>(State:scoped_state)<suspends>:[]side_effect=
        BlockMap := BlockTypes.Reduce(AddEntry, map{})
        # Replace with `set_mesh`
        BlockType := State.GetStr("Block Type").Get()
        BlockProp := Spawn(BlockMap[BlockType] or DefaultBlock)
        array:
            PushVec3("Location", SetLocation(BlockProp).FN)
