<template>
    <div class="altar" ref="altar">
        <slot></slot>
    </div>
</template>

<script>
import '@babel/polyfill'
import * as _ from '@dev-xp/utils'
import { NOOBJ } from '@dev-xp/noop'
import { Component as Tile } from 'rete'
import { NodeEditor, Engine } from 'rete'

export default {
    methods: {
        init({
            version,
            system,
            family,
            runes,
            alterations,
            hooks = NOOBJ,
            autoRefresh = true,
        }) {
            const altar = new NodeEditor(version, this.$refs.altar)
            const engine = new Engine(version)

            const materialize = (rune, path) => {
                const tile = new Tile()
                tile.path = path
                tile.data = { render: 'vue', component: system.tile }

                return _.$extend(tile, rune(tile))
            }

            const finalRunes = _.mapObjIndexed(materialize, {
                ...(system.runes || {}),
                ...runes,
            })

            _.callForEach('use', altar, {
                ...(system.alterations || {}),
                ...alterations,
            })
            _.callForEach('register', altar, finalRunes)
            _.callForEach('register', engine, finalRunes)

            if (autoRefresh)
                altar.on(
                    'process nodecreated noderemoved connectionremoved connectioncreated',
                    e =>
                        engine
                            .abort()
                            .then(() => engine.process(altar.toJSON()))
                )

            return altar
                .fromJSON(_.isString(family) ? JSON.parse(family) : family)
                .then(() => ({ altar, runes: finalRunes }))
        },
    },
}
</script>

<style lang="sass" scoped>
.altar
    height: 100%
    width: 100%
</style>
