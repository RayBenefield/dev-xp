import pick from 'lodash.pick'
import omit from 'lodash.omit'
import { firestore } from 'firebase-admin'

const tokens = {
    twitch: ['access_token', 'refresh_token'],
    twitter: ['access_token_key', 'access_token_secret'],
}

const createExpires = credentials => {
    if (credentials['expires']) return credentials['expires']
    if (credentials['expires_in']) {
        const expires = new Date()
        expires.setSeconds(expires.getSeconds() + credentials['expires_in'])
        return expires
    }
    return new Date()
}

export default ({ db, crypto: { encrypt, decrypt } }) => ({
    updateUser: ({ userId, data }) => db.update(`users/${userId}`, data),
    saveToken: ({ credentials, userId, platform }) => {
        db.upsert(`users/${userId}/auth/${platform}`, {
            ...omit(credentials, ['expires', ...tokens[platform]]),
            tokens: encrypt(pick(credentials, tokens[platform])),
            expires: firestore.Timestamp.fromDate(createExpires(credentials)),
        })
    },
    getToken: ({ userId, platform }) =>
        db.get(`users/${userId}/auth/${platform}`).then(creds => ({
            ...decrypt(creds.tokens),
            expires: creds.expires.toDate(),
        })),
})
