import get from '@rampant/get'
import { tap } from 'rxjs/operators'
import createMixerChat from '@rampant-mixer/chat'

export default ({ clientId, db }) => {
    const mixerChat = createMixerChat({ clientId, db })

    return {
        sources: {
            'mixer-chat': ({ channelId, userId }) =>
                mixerChat({ channelId, userId }),
        },
        effects: {
            message: ({ text, userId, channelId }) =>
                tap(() => {
                    mixerChat({ channelId, userId }).then(chat =>
                        chat.message(text)
                    )
                }),
            whisper: ({ text, userId, channelId }) =>
                tap(({ params }) => {
                    mixerChat({ channelId, userId }).then(chat =>
                        chat.whisper(params.user_name, text)
                    )
                }),
            'mixer-delete': ({ userId, channelId, messageId }) =>
                tap(payload => {
                    mixerChat({ channelId, userId }).then(chat => {
                        const id = get({ $: payload }, messageId)
                        chat.erase(id)
                    })
                }),
        },
    }
}
