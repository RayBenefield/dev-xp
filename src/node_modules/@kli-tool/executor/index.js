import parse from 'minimist'
import RenderKid from 'renderkid'
import { isolate } from 'transmutation'
import cleanser from '@kli-tool/cleanser'
import convertArgs from '@kli-tool/convert-args'
import { render as prettyJson } from 'prettyjson'
import getKeys from '@kli-tool/get-keys-with-path'

const jsonRender = render => prop => results =>
    render(prettyJson(isolate(prop)(results)))

const keyRenderer = render => prop => results =>
    render(prettyJson(getKeys(results, prop)))

export default ({
    config,
    cleanse,
    defaultRenderer,
    defaultStyle,
    decider,
} = {}) =>
    // eslint-disable-next-line complexity
    (unparsed = ['']) => {
        const parsed = parse(unparsed, { boolean: true })
        const { _: [request, ...commandArgs], commit, json, dry, keys } = parsed

        const command = decider(request)

        const args = { ...parsed, _: commandArgs }
        const newArgs = convertArgs({ args, conversions: command.args })
        const finalConfig = cleanser(cleanse)({ ...config, ...newArgs })

        const formatter = new RenderKid()
        formatter.style(defaultStyle)
        const run = () => command.run(finalConfig)
        const template = command.template
            ? data => formatter.render(command.template(finalConfig)(data))
            : _ => _
        const effect = command.effect
            ? data => command.effect(finalConfig)(data)
            : _ => _

        const result = Promise.resolve(run())

        const renderer = command.renderer || defaultRenderer

        if (keys) return result.then(keyRenderer(renderer)(keys))
        if (json) {
            const jsonRenderer = jsonRender(renderer)
            return result.then(
                jsonRenderer(json.indexOf(',') >= 0 ? json.split(',') : json)
            )
        }
        return result.then(data => {
            renderer(template(data))

            if (commit || (command.autoCommit && !dry)) effect(data)
        })
    }
