import log from '@dev-xp/log'
import { red, yellow } from 'chalk'
import createSearcher from '@kli-tool/searcher'

export default ({ proposedDefault, commands }) => {
    const commandArray = Object.values(commands)
    const onlyCommand = commandArray.length === 1 ? commandArray[0] : null

    const resolvedDefault =
        typeof proposedDefault === 'string'
            ? commands[proposedDefault]
            : proposedDefault

    const defaultCommand = resolvedDefault || onlyCommand
    const searcher = createSearcher({ commands: commandArray })

    return request => {
        if (!request) return defaultCommand

        const results = searcher.get(request)
        if (results.length > 0) return results[0]

        if (defaultCommand) {
            log()
            log(yellow(` ► No command associated with \`${request}\``))
            log(yellow(` ► Running default command \`${defaultCommand.name}\``))
            log()
            return defaultCommand
        }

        log(red(` ► No command associated with \`${request}\``))
        return process.exit(127)
    }
}
