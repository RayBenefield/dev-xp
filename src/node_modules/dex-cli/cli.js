import argv from 'argv'
import { prompt } from 'inquirer'
import defaults from 'lodash.defaults'
import { cosmiconfig, defaultLoaders } from 'cosmiconfig'
import { prettify, createLogger } from '@dexterity/logger'

argv.version('0.0.17')
argv.info('Dex is a Pomodoro inspired worklog system.')

argv.option([
    {
        name: 'log',
        short: 'l',
        type: 'string',
        description:
            'Level of logging to print [error, warn, info, verbose, debug, silly]',
        example: '--log=level-name',
    },
])

const { options: { log: level = 'info' } } = argv.run()
const logger = createLogger({ level })

logger.info('Dex CLI')

const explorer = cosmiconfig('dex', {
    searchPlaces: ['.dexrc'],
    loaders: { noExt: defaultLoaders['.json'] },
})

explorer
    .search()
    .then(results => {
        const configDefaults = { session: 0, subprojects: [] }

        if (!results) {
            logger.warn('No Dex config file found')
            return configDefaults
        }

        logger.info('Config file loaded')
        logger.debug(prettify(results))
        return defaults(results.config, configDefaults)
    })
    .then(config => {
        logger.info(`${config.session} sessions currently logged.`)
        return config
    })
    .then(() =>
        prompt([
            {
                type: 'number',
                name: 'newSessions',
                message: 'How many sessions are we logging?',
                default: 1,
                validate: value => value > 0,
            },
            {
                type: 'editor',
                name: 'entry',
                message: 'What did you do during this session?',
            },
        ])
    )
    .then(answers => {
        logger.debug(prettify(answers))
        return answers
    })
    .catch(err => {
        logger.error('Error loading config file')
        logger.error(prettify(err))
    })
