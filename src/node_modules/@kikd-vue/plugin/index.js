import { resolve } from 'path'

import { copy } from '@dev-xp/fs'
import build from '@kikd/build-rollup'
import postBuild from '@kikd/post-build'
import vuePlugin from 'rollup-plugin-vue'
import commonjs from 'rollup-plugin-commonjs'
import globals from 'rollup-plugin-node-globals'
import getJsDetails from '@kikd/package-details-js'
import rollup, { commonPlugins } from '@kikd/rollup-utils'
import postcss from 'rollup-plugin-postcss'

const type = 'vue-site'
const plugins = [
    vuePlugin({ preprocessStyles: true }),
    postcss(),
    commonjs(),
    globals(),
    ...commonPlugins,
]
const rollupConfig = { type, plugins, file: 'app.js', format: 'iife' }

export default {
    type,
    details: () => ({ main: 'app.js' }),
    filter: ({ files = [] }) =>
        files.includes('index.html') && files.includes('app.js'),
    manifest: getJsDetails,
    config: snowball => [
        rollup({ ...rollupConfig, ...snowball, format: 'iife' }),
    ],
    build,
    postBuild: ({ root, rootManifest, config }) =>
        postBuild({ root, rootManifest, config }).then(() =>
            copy(
                resolve(root, config.srcDir, 'index.html'),
                resolve(root, config.destDir, 'index.html')
            )
        ),
}
