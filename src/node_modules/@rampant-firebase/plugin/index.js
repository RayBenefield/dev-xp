import get from '@rampant/get'
import createDb from '@rampant/db'
import { tap, filter } from 'rxjs/operators'

export default ({ databaseId, projectId }) => {
    const db = createDb(databaseId)
    return {
        db,
        projectSettings: () => db.get(`projects/${projectId}`),
        intentStream: () =>
            db.onCollectionChange(`projects/${projectId}/intents`),
        sources: {
            db: ({ name }) =>
                db
                    .onDocumentChange(`projects/${projectId}/custom-db/${name}`)
                    .pipe(filter(_ => _)),
        },
        effects: {
            db: ({ action = 'upsert', doc, data }) =>
                tap(payload => {
                    const key = get({ $: payload }, doc)
                    const value = get({ $: payload }, data)

                    db[action](`projects/${projectId}/custom-db/${key}`, value)
                }),
        },
    }
}
