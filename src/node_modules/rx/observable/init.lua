local _ = require('ludash')
local observer = require('rx.observer')

local create

create = function(start, parentSource)
    local observable
    local destination = nil
    local listeners = {}

    local destNext = function(...)
        for index, listener in pairs(listeners) do
            listener.next(...)
        end
    end

    local destErr = function(...)
        for index, listener in pairs(listeners) do
            listener.err(...)
        end
    end

    local destComplete = function(...)
        for index, listener in pairs(listeners) do
            listener.complete(...)
        end
    end

    local subscribe = function(observerOrNext, err, complete)
        local listener

        if (_.isObserver(observerOrNext)) then
            listener = observerOrNext
        elseif (type(observerOrNext) == 'table') then
            listener = observer(observerOrNext[1], observerOrNext[2], observerOrNext[3])
        else
            listener = observer(observerOrNext, err, complete)
        end

        if (not _.isFunction(start)) then
            return observer()
        end

        if (destination) then
            table.insert(listeners, listener)
            return destination
        end

        destination = observer(listener, destNext, destErr, destComplete)

        table.insert(listeners, listener)
        local stop = start(destination, parentSource)

        destination.add(function(...)
            destination = nil
            if (_.isFunction(stop)) then
                stop(...)
            end
        end)
        return destination
    end

    local pipe = function(...)
        local args = {...}
        args = type(args[1]) == 'table' and args[1] or args
        local operators = _.onlyFunctions(args)
        local operatorCount = #operators

        if (operatorCount <= 0) then
            return observable
        end

        if (operatorCount == 1) then
            return operators[1](observable)
        end

        return _.reduce(operators, function(source, operator)
            return operator(source)
        end, observable)
    end

    local lift = function(operator)
        return create(operator, observable)
    end

    observable = {
        subscribe = subscribe,
        lift = lift,
        pipe = pipe,
        shamefullySendNext = function(...) destination.next(...) end,
        shamefullySendError = function(...) destination.err(...) end,
        shamefullySendComplete = function(...) destination.complete(...) end,
    }

    return observable
end

return create
