local _ = require('ludash')
local operate = require('rx.operator')
local observable = require('rx.observable')
local observer = require('rx.observer')

return function(...)
    local sources = {...}
    sources = not _.isObservable(sources[1])
        and sources[1] or sources

    local base = sources[#sources]

    return operate(function(source, destination)
        local completed = 0
        local subscriptions = {}

        local complete = function()
            completed = completed + 1

            if (completed == #sources) then
                destination.complete()
            end
        end

        local newDestination = observer(destination, nil, nil, complete)

        for i = 1, #sources - 1 do
            newDestination.add(sources[i].subscribe({
                destination.next,
                destination.err,
                complete,
            }))
        end

        source.subscribe(newDestination)
    end)(base)
end
