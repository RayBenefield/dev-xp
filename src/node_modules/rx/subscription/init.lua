local _ = require('ludash')

local create

create = function(baseTeardown)
    baseTeardown = baseTeardown or _.noop

    local unsubscribed = false
    local subscriptions = {}

    local unsubscribe = function()
        if (unsubscribed) then return end

        local currentSubscriptions = subscriptions

        unsubscribed = true
        subscriptions = nil

        baseTeardown()
        for index, subscription in pairs(currentSubscriptions) do
            if (_.isSubscription(subscription)) then
                subscription.unsubscribe()
            end
        end
    end

    local add = function(teardown)
        if (not teardown) then
            return { unsubscribe = _.noop }
        end

        local newSubscription = teardown

        if (type(teardown) == 'function') then
            newSubscription = create(teardown)
        end

        if (unsubscribed) then
            newSubscription.unsubscribe()
            return newSubscription
        end

        table.insert(subscriptions, newSubscription)

        return newSubscription
    end

    local subscription = {
        unsubscribe = unsubscribe,
        add = add,
    }

    return subscription
end

return create
