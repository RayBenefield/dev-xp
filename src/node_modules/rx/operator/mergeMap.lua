local operate = require('rx.operator')
local observer = require('rx.observer')

--TODO
-- Include concurrency handling
return function(projection)
    return operate(function(source, destination)
        if (not projection) then
            return source.subscribe(destination)
        end

        local active = 0
        local isComplete = false

        local checkComplete = function()
            if (isComplete and active <= 0) then
                destination.complete()
            end
        end

        local innerComplete = function()
            active = active - 1
            checkComplete()
        end

        local outerNext = function(...)
            local inner = projection(...)
            inner.subscribe(observer(destination, nil, nil, innerComplete))
        end

        local outerComplete = function()
            isComplete = true
            checkComplete()
        end

        source.subscribe(
            observer(destination, outerNext, nil, outerComplete)
        )
    end)
end
