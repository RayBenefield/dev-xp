local _ = require('ludash')
local subscription = require('rx.subscription')

return function(destination, maybeNext, maybeErr, maybeComplete)
    local next
    local err
    local complete

    if (_.isObserver(destination)) then
        next = maybeNext or _.noop
        err = maybeErr or _.printError
        complete = maybeComplete or _.noop
    else
        next = destination or _.noop
        err = maybeNext or _.printError
        complete = maybeErr or _.noop
    end

    local stopped = false
    local subscription = subscription()

    local observer = {
        next = function(...)
            if (not stopped) then
                next(...)
                if (_.isObserver(destination) and not maybeNext) then
                    destination.next(...)
                end
            end
        end,
        err = function(...)
            if (not stopped) then
                stopped = true
                err(...)
                if (_.isObserver(destination) and not maybeErr) then
                    destination.err(...)
                end
                subscription.unsubscribe()
            end
        end,
        complete = function()
            if (not stopped) then
                stopped = true
                complete()
                if (_.isObserver(destination) and not maybeComplete) then
                    destination.complete()
                end
                subscription.unsubscribe()
            end
        end,
        add = subscription.add,
        unsubscribe = subscription.unsubscribe,
    }

    if (_.isSubscription(destination)) then
        destination.add(observer)
    end

    return observer
end
