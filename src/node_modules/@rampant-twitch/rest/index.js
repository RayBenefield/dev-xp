import twitch from 'twitch'
import { classToPlain } from 'class-transformer'

const helixData = obj => classToPlain(obj)['_data']

export const createRestClient = ({ id, secret, authRepo }) => ({
    credentials: creds,
    userId,
}) => {
    const update = credentials =>
        authRepo.saveToken({
            userId,
            platform: 'twitch',
            credentials: helixData(credentials),
        })

    const client = twitch.withCredentials(
        id,
        creds['access_token'],
        creds['scope'],
        {
            clientSecret: secret,
            expiry: creds['expires'],
            onRefresh: update,
            refreshToken: creds['refresh_token'],
        }
    )
    client.credentials = creds

    return client.helix.users
        .getMe(true)
        .then(details => ({
            id: details.id,
            ...helixData(details),
        }))
        .then(user => {
            client.user = user
            return client
        })
}

export default ({ id, secret, authRepo }) => {
    const creator = createRestClient({ id, secret, authRepo })
    const cache = {}

    return userId => {
        if (userId in cache) return Promise.resolve(cache[userId])

        return authRepo
            .getToken({ userId, platform: 'twitch' })
            .then(credentials => creator({ userId, credentials }))
            .then(client => {
                cache[userId] = client
                return client
            })
    }
}
