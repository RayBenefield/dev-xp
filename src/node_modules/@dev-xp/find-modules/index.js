/* eslint-disable indent */
import { resolve } from 'path'

import { exists, readDir } from '@dev-xp/fs'

export default ({ namespace } = {}) => {
    const resolvePaths = require.main.paths
    const getDirectories = check => path =>
        readDir(path, { withFileTypes: true })
            .filter(item => item.isDirectory())
            .filter(item => (check ? item.name === check : true))
            .map(item => ({
                name: item.name,
                path,
            }))

    const topLevel = [].concat(
        ...resolvePaths
            .filter(path => exists(path))
            .map(getDirectories(namespace))
    )
    const allModules = topLevel.reduce(
        (all, { name, path }) =>
            name.charAt(0) === '@'
                ? [
                      ...all,
                      ...getDirectories()(resolve(path, name)).map(
                          child => `${name}/${child.name}`
                      ),
                  ]
                : [...all, name],
        []
    )
    return allModules
}
