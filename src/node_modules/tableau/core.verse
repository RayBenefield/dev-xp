
using. /Verse.org/Simulation

using. Numb
using. TableauResource

controller<public> := interface():
    Triage<public>()<suspends>:void

command<public> := class():
    Subject<public>:string = ""
    Property<public>:string = ""
    Target<public>:string = ""
    Pay<public>:load = load{}
    AfterEffects<public>:[]effect = array{}

commander<public> := class():
    FiredEvent<public>:event(command) = event(command){}
    CreatedEvent<public>:event(resource) = event(resource){}
    Fire<public>(Command:command):void = FiredEvent.Signal(Command)
    Create<public>(Resource:resource):void = CreatedEvent.Signal(Resource)

CopyCommand<public><constructor>(Old:command) := command:
    Subject := Old.Subject
    Property := Old.Property
    Target := Old.Target
    Pay := Old.Pay

CopyEvent<constructor><public>(Old:domain_event) := domain_event:
    Event := Old.Event
    SubjectType := Old.SubjectType
    Subject := Old.Subject
    TargetType := Old.TargetType
    Target := Old.Target
    Property := Old.Property

domain_event<public> := class:
    Event<public>:ev
    SubjectType<public>:entity
    Subject<public>:string
    TargetType<public>:?entity = false
    Target<public>:string = ""
    Property<public>:string = ""

    Equals<public>(Other:domain_event)<decides><transacts>:void=
        SubjectType.Name() = Other.SubjectType.Name()
        Subject = Other.Subject
        Event.Name() = Other.Event.Name()
        if (TargetType?):
            TargetType?.Name() = Other.TargetType?.Name()
            Target = Other.Target
        Property = Other.Property

(List:[]domain_event).Includes<public>(Target:domain_event)<decides><transacts>:void=
    Equals := for(Ev:List, Ev.Equals[Target]). Ev
    Equals.Length > 0

dispatcher<public> := class():
    DomainEventTriggered:event([]domain_event) := event([]domain_event){}
    DomainEvents<public>():event([]domain_event)=DomainEventTriggered

    Dispatch<public>(Event:domain_event):void = DomainEventTriggered.Signal(array. Event)
    Dispatch<public>(Events:[]domain_event):void = DomainEventTriggered.Signal(Events)

Path<public><constructor>(PropertyID:string)<transacts> := prop_path. PropertyID := PropertyID
Path<public><constructor>(ResourceID:string, PropertyID:string)<transacts> := prop_path:
    ResourceID := option. ResourceID
    PropertyID := PropertyID

prop_path<public> := class<concrete>():
    @editable ResourceID<public>:?string = false
    @editable PropertyID<public>:string = ""

Load<public><constructor>(PropPath:prop_path) := load. Prop := option. PropPath

load<public> := class<concrete>():
    @editable Prop<public>:?prop_path = false
    @editable Str<public>:string = ""
    @editable Float<public>:float = 1.0
    @editable Num<public>:num = num{}
    @editable Bool<public>:logic = false

THIS<public>:string = ""
effect<public> := class<concrete>():
    @editable FN<public>:string = ""
    @editable FocusSubject<public>:string = ""
    @editable FocusTarget<public>:string = ""
    @editable Pay<public>:load = load{}
    Focus<public>:prop_path = prop_path{}

effector<public> := interface():
    Play<public>(Source:string, Activator:string, Focus:prop_path, Pay:load)<suspends>:?[]command

entity<public> := interface:
    Name<public>()<computes>:string

ev<public> := interface:
    Name<public>()<computes>:string

service<public> := interface() {}

mutator<public> := interface():
    ApplyEvents<public>(Events:[]domain_event):void

comp_float<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    @editable Focus<public>:prop_path = prop_path{}
    @editable FN<public>:string = ""
    @editable Pay<public>:load = load{}
    GetType<override>()<computes>:prop_type = prop_type.Float

comp_num<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    @editable Focus<public>:prop_path = prop_path{}
    @editable FN<public>:string = ""
    @editable Pay<public>:load = load{}
    GetType<override>()<computes>:prop_type = prop_type.Num

comp_str<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    @editable Focus<public>:prop_path = prop_path{}
    @editable FN<public>:string = ""
    @editable Pay<public>:load = load{}
    GetType<override>()<computes>:prop_type = prop_type.Str

comp_bool<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    @editable Focus<public>:prop_path = prop_path{}
    @editable FN<public>:string = ""
    @editable Pay<public>:load = load{}
    GetType<override>()<computes>:prop_type = prop_type.Bool

prop_type<public> := enum:
    Num
    Str
    Bool
    Float
    Agent
    StatNum
    StatStr
    StatBool
    StatFloat
    StatAgent
    CompNum
    CompStr
    CompBool
    CompFloat
    Unknown

prop<public> := interface. GetType<public>()<computes>:prop_type

prop_agent<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    Default<public>:?agent = false
    GetType<override>()<computes>:prop_type = prop_type.Agent

prop_str<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    @editable Default<public>:string = ""
    GetType<override>()<computes>:prop_type = prop_type.Str

prop_num<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    @editable Default<public>:num = num{}
    GetType<override>()<computes>:prop_type = prop_type.Num

prop_float<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    @editable Default<public>:float = 0.0
    GetType<override>()<computes>:prop_type = prop_type.Float

prop_bool<public> := class<concrete>(prop):
    @editable ID<public>:string = ""
    @editable Default<public>:logic = false
    GetType<override>()<computes>:prop_type = prop_type.Bool

ToString<public>(Type:prop_type):string = case(Type):
    prop_type.Num => "Num"
    prop_type.Str => "Str"
    prop_type.Bool => "Bool"
    prop_type.Float => "Float"
    prop_type.Agent => "Agent"
    prop_type.StatNum => "StatNum"
    prop_type.StatStr => "StatStr"
    prop_type.StatBool => "StatBool"
    prop_type.StatFloat => "StatFloat"
    prop_type.StatAgent => "StatAgent"
    prop_type.CompNum => "CompNum"
    prop_type.CompStr => "CompStr"
    prop_type.CompBool => "CompBool"
    prop_type.CompFloat => "CompFloat"
    prop_type.Unknown => "Unknown"
