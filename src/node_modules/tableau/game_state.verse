
using. /Verse.org/Simulation
using. /UnrealEngine.com/Temporary/UI

using. TableauResource

game_state<public> := class():
    ResourceRepository<public>:resource_repository
    EffectorProvider<public>:effector_provider
    Commander<public>:commander
    var InteractiveCanvas<public>:?canvas = false

    var Resources<public>:[string]resource_vm = map{}
    var ResourceTemplates<public>:[string]resource = map{}
    var ResourceTypeAdded:[string]event(string) = map{}
    ResourceAdded<public>:event(string) = event(string){}
    ResourceRemoved<public>:event(string) = event(string){}

    AddResource<public>(InitialResource:resource)<suspends>:?resource_vm=
        if (InitialResource.Type <> ""):
            Type := InitialResource.Type
            if (not ResourceTemplates[Type]):
                if. set ResourceTemplates[Type] = InitialResource

        if (InitialResource.ID <> ""):
            ID := InitialResource.ID
            VM := resource_vm{ GameState := Self, ID := ID }
            spawn. VM.Init(InitialResource)
            if. set Resources[ID] = VM
            Sleep(0.0)
            ResourceAdded.Signal(ID)

            if (InitialResource.Type <> ""):
                if (AddedEvent := ResourceTypeAdded[InitialResource.Type]):
                    AddedEvent.Signal(ID)
                else:
                    AddedEvent := event(string){}
                    if. set ResourceTypeAdded[InitialResource.Type] = AddedEvent
                    AddedEvent.Signal(ID)

            return option. VM

        return false
    CreateResource<public>(ID:string, Type:string):void=
        if (not Resources[ID], Template := ResourceTemplates[Type]):
            Resource := CreateFromTemplate(ID, Template)
            Commander.Create(Resource)
    AwaitResource<public>(ID:string)<suspends>:resource_vm=
        if (Res := Resources[ID]). return Res
        loop:
            IncomingID := ResourceAdded.Await()
            if (ID = IncomingID, Res:= Resources[ID]). return Res
    ResourceAddedEvent<public>(Type:string):event(string)=
        if (AddedEvent := ResourceTypeAdded[Type]):
            return AddedEvent
        else:
            NewEvent:event(string) = event(string){}
            if. set ResourceTypeAdded[Type] = NewEvent
            return NewEvent

    # TODO: Using `Latest` will cause bugs with props that are not natively a string in GetStrProp
    ResolvePath<public>(Source:string, HalfPath:half_path, PlayerID:string):prop_path=
        PropertyID := if (ID := HalfPath.PropertyID?). ID
        else if (Unresolved := HalfPath.PropertyPath?):
            Ready := ResolvePath(Source, Unresolved, PlayerID)
            GetStrProp(Ready, PlayerID).Latest
        else. ""
        ResourceID := if (ID := HalfPath.ResourceID?). ID
        else if (Unresolved := HalfPath.ResourcePath?):
            Ready := ResolvePath(Source, Unresolved, PlayerID)
            Resolved := GetStrProp(Ready, PlayerID).Latest
            Resolved
        else. Source

        prop_path{ ResourceID := ResourceID, PropertyID := PropertyID }
