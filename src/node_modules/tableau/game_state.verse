
using { /UnrealEngine.com/Temporary/UI }

using { TableauResource }

game_state<public> := class():
    ResourceRepository<public>:resource_repository
    EffectorProvider<public>:effector_provider
    NumComputerProvider<public>:num_computer_provider
    Commander<public>:commander
    var InteractiveCanvas<public>:?canvas = false

    var Resources<public>:[string]resource_vm = map{}
    var ResourceTypeAdded:[string]event(string) = map{}
    ResourceAdded<public>:event(string) = event(string){}
    ResourceRemoved<public>:event(string) = event(string){}
    AddResource<public>(InitialResource:resource)<suspends>:resource_vm=
        ID := InitialResource.ID
        VM := resource_vm{ GameState := Self, ID := ID }
        spawn. VM.Init(InitialResource)
        if (set Resources[ID] = VM):
            ResourceAdded.Signal(ID)
            if (InitialResource.Type <> ""):
                if (AddedEvent := ResourceTypeAdded[InitialResource.Type]):
                    AddedEvent.Signal(ID)
                else:
                    AddedEvent := event(string){}
                    if. set ResourceTypeAdded[InitialResource.Type] = AddedEvent
                    AddedEvent.Signal(ID)
        return VM
    AwaitResource<public>(ID:string)<suspends>:resource_vm=
        if (Res := Resources[ID]). return Res
        loop:
            IncomingID := ResourceAdded.Await()
            if (ID = IncomingID, Res:= Resources[ID]). return Res
    ResourceAddedEvent(Type:string):event(string)=
        if (AddedEvent := ResourceTypeAdded[Type]). AddedEvent
        ResourceAdded
