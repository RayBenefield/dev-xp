using { TableauResource }
using { TableauParticipant }
using { TableauProducer }

game_state<public> := class():
    EffectorProvider<public>:effector_provider
    NumComputerProvider<public>:num_computer_provider
    Commander<public>:commander

    var Participants<public>:[string]participant_vm = map{}
    ParticipantAdded<public>:event(string) = event(string){}
    ParticipantRemoved<public>:event(string) = event(string){}
    AddParticipant<public>(InitialParticipant:participant)<suspends>:participant_vm=
        ID := InitialParticipant.ID
        VM := participant_vm. ID := ID
        spawn. VM.Init(InitialParticipant)
        if (set Participants[ID] = VM). ParticipantAdded.Signal(ID)
        return VM
    AwaitParticipant<public>(ID:string)<suspends>:participant_vm=
        if (Part := Participants[ID]). return Part
        loop:
            IncomingID := ParticipantAdded.Await()
            if (ID = IncomingID, Part := Participants[ID]). return Part

    var Resources<public>:[string]resource_vm = map{}
    ResourceAdded<public>:event(string) = event(string){}
    ResourceRemoved<public>:event(string) = event(string){}
    AddResource<public>(InitialResource:resource)<suspends>:resource_vm=
        ID := InitialResource.ID
        VM := resource_vm{ GameState := Self, ID := ID }
        spawn. VM.Init(InitialResource)
        if (set Resources[ID] = VM). ResourceAdded.Signal(ID)
        return VM
    AwaitResource<public>(ID:string)<suspends>:resource_vm=
        if (Res := Resources[ID]). return Res
        loop:
            IncomingID := ResourceAdded.Await()
            if (ID = IncomingID, Res:= Resources[ID]). return Res

    var Producers<public>:[string]producer_vm = map{}
    ProducerAdded<public>:event(string) = event(string){}
    ProducerRemoved<public>:event(string) = event(string){}
    AddProducer<public>(InitialProducer:producer, Buy:oldeffector)<suspends>:producer_vm=
        ID := InitialProducer.ID
        VM := producer_vm{ ID := ID, BuyEffector := Buy }
        spawn. VM.Init(InitialProducer)
        if (set Producers[ID] = VM). ProducerAdded.Signal(ID)
        return VM
    AwaitProducer<public>(ID:string)<suspends>:producer_vm=
        if (Res := Producers[ID]). return Res
        loop:
            IncomingID := ProducerAdded.Await()
            if (ID = IncomingID, Res:= Producers[ID]). return Res
