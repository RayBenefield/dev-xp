
using { /Verse.org/Simulation }

participant_watcher<public> := class():
    GameState<public>:game_state
    OnPossessed<public>:type{_(:game_state, :string, :agent)<suspends>:void}

    Start<public>()<suspends>:void=
        loop:
            ID := GameState.ResourceAddedEvent("Participant").Await()
            spawn. WaitForPossession(ID)

    WaitForPossession(ParticipantID:string)<suspends>:void=
        # TODO: Support later possession and abandonment
        if (AgentProp := GameState.Resources[ParticipantID].StatProps.Agents["Possessed By"]):
            # loop:
                # MaybeAgent := AgentProp.UpdatedEvent().Await()
                MaybeAgent := AgentProp.Get()
                if (Agent := MaybeAgent?):
                    spawn. OnPossessed(GameState, ParticipantID, Agent)
