
using { /Fortnite.com/Devices }
using { /Verse.org/Simulation }
using { /Verse.org/Simulation/Tags }
using { /UnrealEngine.com/Temporary/Diagnostics }

using { TableauWork }
using { TableauAgent }
using { TableauGenerator }
using { TableauParticipant }

game_factory_device := class(creative_device):

    OnBegin<override>()<suspends>:void=
        # Load all Devices
        GeneratorDevices := LoadGeneratorDevices()
        GeneratorLocationDevices := LoadGeneratorLocationDevices()
        CollectionDevices := LoadCollectionDevices()
        PossessionDevices:= LoadPossessionDevices()
        ParticipantUIDevices := LoadParticipantUIDevices()
        ResourceUIDevices := LoadResourceUIDevices()
        ParticipantBoardDevices := LoadParticipantBoardDevices()
        WorkDevices := LoadWorkDevices()
        Print("Generator Devices: {GeneratorDevices.Length}")
        Print("Generator Location Devices: {GeneratorLocationDevices.Length}")
        Print("Collection Devices: {CollectionDevices.Length}")
        Print("Possession Devices: {PossessionDevices.Length}")
        Print("Participant UI Devices: {ParticipantUIDevices.Length}")
        Print("Resource UI Devices: {ResourceUIDevices.Length}")
        Print("Participant Board Devices: {ParticipantBoardDevices.Length}")
        Print("Work Devices: {WorkDevices.Length}")

        GrantResourcesEffect := grant_resources_effect{}
        EffectProvider := effect_provider{}
        EffectProvider.Register(effect_type.AddResources, GrantResourcesEffect)

        # Setup all Repositories
        AgentRepository:agent_repository = agent_repository{}

        InitialGenerators := for(Gen:GeneratorDevices). Gen.InitialState
        GeneratorRepository:generator_repository = generator_repository:
            Initial := InitialGenerators

        ParticipantRepository:participant_repository = participant_repository:
            Initial := array:
                participant{ID := 1}
                participant{ID := 2}
                participant{ID := 3}

        InitialWork := for(Work:WorkDevices). Work.InitialState
        WorkRepository:work_repository = work_repository:
            Initial := InitialWork

        # Setup all Services
        GeneratorService:generator_service = generator_service:
            Repo := GeneratorRepository
            EffectProvider := EffectProvider
        AgentService:agent_service = agent_service:
            Repo := AgentRepository
        ParticipantService:participant_service = participant_service:
            Repo := ParticipantRepository
        WorkService:work_service= work_service:
            Repo := WorkRepository

        Services:[]service = array:
            GeneratorService
            AgentService
            ParticipantService
            WorkService

        Dispatcher := dispatcher{}

        # Setup all Controllers
        GeneratorController:generator_controller = generator_controller:
            Dispatcher := Dispatcher
            GeneratorService := GeneratorService
            Devices := GeneratorLocationDevices
            CollectionDevices := CollectionDevices
        AgentController:agent_controller = agent_controller:
            Dispatcher := Dispatcher
            AgentService := AgentService
            Devices := PossessionDevices
        ParticipantController:participant_controller = participant_controller:
            Dispatcher := Dispatcher
            ParticipantService := ParticipantService
            Effect := GrantResourcesEffect
        WorkController:work_controller = work_controller:
            Dispatcher := Dispatcher
            Service := WorkService
            Devices := WorkDevices

        Controllers:[]controller = array:
            GeneratorController
            AgentController
            ParticipantController
            WorkController

        # Setup all Devices
        var Updatables:[]updatable := array{}
        for(Device:GeneratorLocationDevices):
            spawn. Device.Initialize(GeneratorRepository, AgentRepository)
            set Updatables += array. Device
        for(Device:CollectionDevices):
            spawn. Device.Initialize()
            # set Updatables += array. Device
        for(Device:PossessionDevices):
            spawn. Device.Initialize(AgentRepository)
            set Updatables += array. Device
        for(Device:ParticipantUIDevices):
            spawn. Device.Initialize(GeneratorRepository, AgentRepository)
            set Updatables += array. Device
        for(Device:ResourceUIDevices):
            spawn. Device.Initialize(AgentRepository, ParticipantRepository)
            set Updatables += array. Device
        for(Device:ParticipantBoardDevices):
            spawn. Device.Initialize(GeneratorRepository, ParticipantRepository)
            set Updatables += array. Device
        for(Device:WorkDevices):
            spawn. Device.Initialize(WorkRepository)
            set Updatables += array. Device

        # Start Game
        Updater:updater = updater:
            Dispatcher := Dispatcher
            Updatables := Updatables

        spawn. Updater.SetupUpdates()
        MapSync(Controllers, TriageController)

    TriageController(Controller:controller)<suspends>:void=
        Controller.Triage()

# # Usage: DeviceArray := GatherWithTag(device_tag{}, device_type)
# GatherWithTag<public>(Tag:tag, t:type):[]t =
#     TaggedObjects := GetCreativeObjectsWithTag(Tag)
#     for(Tagged : TaggedObjects, Casted := t[Tagged]). Casted