import { merge } from 'rxjs'
import { filter, map, catchError } from 'rxjs/operators'
import createPipeline from '@rampant/pipeline-creator'
import createEffects from '@rampant/effect-creator'

import reportBroken from './report'

export default ({ plugins }) => ({
    sourcePool: pool,
    intent: { name, defaults = {}, sources = [], pipeline = [], effects = [] },
}) => {
    const fromPool = ({ name: sourceName = 'empty' }) => pool[sourceName]
    const intentSources = sources.map(fromPool)
    const extenders = pipeline.map(createPipeline({ plugins }))
    const sideEffects = effects.map(createEffects({ plugins }))

    return merge(...intentSources).pipe(
        filter(({ intent }) => intent === name),
        map(({ intent, source, params = {} }) => ({
            intent,
            source,
            params: {
                ...defaults,
                ...params,
            },
        })),
        ...extenders,
        ...sideEffects,
        catchError(reportBroken(name))
    )
}
