import { merge } from 'rxjs'
import { catchError } from 'rxjs/operators'
import createSources from '@rampant/source-creator'
import createPipeline from '@rampant/pipeline-creator'
import createEffects from '@rampant/effect-creator'

import reportBroken from './report'

export default ({ db }) => intent => {
    const sources = intent.sources.map(createSources({ intent, db }))
    const pipeline = intent.pipeline
        ? intent.pipeline.map(createPipeline())
        : []
    const effects = intent.effects.map(createEffects({ db }))

    return merge(...sources).pipe(
        ...pipeline,
        ...effects,
        catchError(reportBroken(intent))
    )
}
