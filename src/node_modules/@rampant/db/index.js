import firebase from 'firebase-admin'
import { Observable, from } from 'rxjs'
import { mergeMap } from 'rxjs/operators'

// eslint-disable-next-line import/no-unresolved
import serviceAccount from './firebase-key.json'

const onSnapshot = ref =>
    Observable.create(observer => {
        ref.onSnapshot(snapshot => observer.next(snapshot))
    })

export default id => {
    firebase.initializeApp({
        credential: firebase.credential.cert(serviceAccount),
        databaseURL: `https://${id}.firebaseio.com`,
    })
    const db = firebase.firestore()

    return {
        onCollectionChange: collectionId =>
            onSnapshot(db.collection(collectionId)).pipe(
                mergeMap(snapshot => from(snapshot.docChanges()))
            ),
    }
}
