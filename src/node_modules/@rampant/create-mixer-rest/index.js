import createRestClient from './client-creator'

const cache = {}

export default ({ clientId, db }) => {
    const creator = createRestClient(clientId)

    return userId => {
        const update = token =>
            db.update(`users/${userId}/auth/mixer`, {
                'access-token': token.token.access_token,
                'refresh-token': token.token.refresh_token,
                expires: token.token.expires_at,
            })

        if (userId in cache) return Promise.resolve(cache[userId])

        return db.get(`users/${userId}/auth/mixer`).then(creds => {
            const client = creator({ ...creds, update })
            cache[userId] = client
            return client
        })
    }
}
