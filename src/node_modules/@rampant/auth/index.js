import express from 'express'
import functions from 'firebase-functions'
import { encrypt, decrypt } from '@dev-xp/crypto'
import { getOAuthRequestToken } from '@rampant-twitter/auth'

const auth = express()
const authRouter = express.Router()

authRouter.get('/twitter', async (req, res) => {
    const state = encrypt({ id: 'monorepo' })
    const { oauthRequestToken } = await getOAuthRequestToken(state)
    const authorizationUrl = `https://api.twitter.com/oauth/authorize?oauth_token=${oauthRequestToken}`
    res.redirect(authorizationUrl)
})

auth.use('/auth', authRouter)
exports.auth = functions.https.onRequest(auth)

const cb = express()
const cbRouter = express.Router()

cbRouter.get('/twitter', async (req, res) => {
    const { state } = req.query
    console.log(decrypt(state))
    res.redirect('/')
})

cb.use('/callback', cbRouter)
exports.callback = functions.https.onRequest(cb)
