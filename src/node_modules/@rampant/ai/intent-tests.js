import log from '@dev-xp/log'
import { start, db } from '@rampant/ai'
import { white, underline } from 'chalk'
import serial from '@rampant/serial-promise'
import { testCount, intents, cleanupDocs } from '@rampant/ai/test-intents.js'

start({ projectId: 'testing' })

const createIntents = () => {
    log()
    log(`  ${white(underline('Intent Tests'))}`)
    log()

    return Promise.all(
        intents.map(intent =>
            db.set(`projects/testing/intents/${intent.name}`, intent)
        )
    )
}

const cleanup = () => {
    log()
    log(white.bold(`    ${testCount} tests run`))
    log()

    return Promise.all([
        ...intents.map(({ name }) =>
            db.remove(`projects/testing/intents/${name}`)
        ),
        ...cleanupDocs.map(doc =>
            db.remove(`projects/testing/custom-db/${doc}`)
        ),
    ])
}

serial([createIntents, cleanup], 2000).then(() => process.exit(0))
