import createDb from '@rampant/db'
import { tap, map } from 'rxjs/operators'
import createIntentEngine from '@rampant/engine'

export const db = createDb('rampant-ai')
export const intentEngine = createIntentEngine({ db })

export const stream = db
    // TODO: Replace `testing` with Project ID
    .onCollectionChange('projects/testing/intents')
    .pipe(
        map(change => ({
            id: change.doc.id,
            type: change.type,
            new: change.doc.data(),
        })),
        tap(({ id, type, new: newValue }) => {
            if (type === 'added') intentEngine.addIntent(id, newValue)
            if (type === 'removed') intentEngine.removeIntent(id)
        })
    )
    .subscribe()
