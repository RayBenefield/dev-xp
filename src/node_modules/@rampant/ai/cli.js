/* eslint-disable import/no-dynamic-require, global-require */
import { writeSync } from '@dev-xp/fs'
import argv from 'argv'
import { start, db } from '@rampant/ai'
import { stringify } from 'javascript-stringify'

argv.version('v0.0.0')
argv.info('Create and run a Rampant AI project directly.')

argv.mod({
    mod: 'export',
    description: "Export the current project's intents and sources",
    options: [
        {
            name: 'path',
            short: 'p',
            type: 'path',
            description:
                'Where the intents.js and sources.js files should be stored',
            example: '--path=/path/to/folder',
        },
        {
            name: 'name',
            short: 'n',
            type: 'string',
            description: 'Name of the project to export intents/sources from',
            example: '--name=channel-name',
        },
    ],
})

argv.option([
    {
        name: 'path',
        short: 'p',
        type: 'path',
        description:
            'Where the intents.js and sources.js files exist to load for the project',
        example: '--path=/path/to/folder',
    },
    {
        name: 'name',
        short: 'n',
        type: 'string',
        description: 'Name of project to save intents/sources under',
        example: '--name=channel-name',
    },
    {
        name: 'log',
        short: 'l',
        type: 'string',
        description:
            'Level of logging to print [error, warning, platform, plugin, intent, extend, detail, debug]',
        example: '--log=level-name',
    },
])

const { mod = 'run', options: { path, name, log = 'platform' } } = argv.run()
process.env.PROJECT_ID = name

if (mod === 'run') {
    const sources = require(`${path}/sources.js`)
    const intents = require(`${path}/intents.js`)

    Promise.all([
        db.upsert(`projects/${name}`, { sources }),
        ...intents.map(intent =>
            db.set(`projects/${name}/intents/${intent.name}`, intent)
        ),
    ]).then(() => start({ projectId: name, level: log }))
}

if (mod === 'export') {
    Promise.all([
        db.get(`projects/${name}`).then(({ sources }) => sources),
        db.get(`projects/${name}/intents`),
    ])
        .then(([sources, intents]) => [
            {
                path: `${path}/intents.js`,
                contents: stringify(Object.values(intents), null, '    '),
            },
            {
                path: `${path}/sources.js`,
                contents: stringify(sources, null, '    '),
            },
        ])
        .then(files =>
            files.forEach(({ path: filePath, contents }) =>
                writeSync(filePath, `module.exports = ${contents}`, 'utf-8')
            )
        )
}
