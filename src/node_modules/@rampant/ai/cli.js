import { config } from 'dotenv'
import createDb from '@rampant/db'
import { tap, map } from 'rxjs/operators'
import createIntentEngine from '@rampant/engine'
import createMixerChat from '@rampant/create-mixer-chat'

config()

const { MIXER_CLIENT_ID } = process.env

export const db = createDb('rampant-ai')
export const mixerChat = createMixerChat({ clientId: MIXER_CLIENT_ID, db })
export const intentEngine = createIntentEngine({ db, mixerChat })

export const stream = db
    // TODO: Replace `testing` with Project ID
    .onCollectionChange('projects/testing/intents')
    .pipe(
        map(change => ({
            id: change.doc.id,
            type: change.type,
            new: change.doc.data(),
        })),
        tap(({ id, type, new: newValue }) => {
            if (type === 'added') intentEngine.addIntent(id, newValue)
            if (type === 'removed') intentEngine.removeIntent(id)
        })
    )
    .subscribe()
