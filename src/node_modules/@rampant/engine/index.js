import { Subject } from 'rxjs'
import sourceCreator from '@rampant/source-creator'
import configureIntentStreamCreator from '@rampant/create-intent-stream'

export default ({ db, mixerChat }) => {
    const engine = new Subject()
    const createSource = sourceCreator({ db })
    const intentStreams = {}
    const intentSubscriptions = {}
    const createIntentStream = configureIntentStreamCreator({ db, mixerChat })

    const sourcePool = {}
    const addSource = sourceSettings => {
        const { type = 'blank', name = 'empty' } = sourceSettings
        if (type in sourcePool && name in sourcePool[type]) return

        const source = createSource(sourceSettings)
        if (!(type in sourcePool)) sourcePool[type] = {}
        sourcePool[type][name] = source
    }

    engine.addIntent = (id, intent) => {
        intent.sources.forEach(addSource)
        const intentStream = createIntentStream({ sourcePool, intent })
        const intentSubscription = intentStream.subscribe(engine)

        intentStreams[id] = intentStream
        intentSubscriptions[id] = intentSubscription
    }

    engine.removeIntent = id => {
        delete intentStreams[id]
        const intentSubscription = intentSubscriptions[id]
        intentSubscription.unsubscribe()
        delete intentSubscriptions[id]
    }

    return engine
}
