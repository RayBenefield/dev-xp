import { Subject } from 'rxjs'
import configureIntentStreamCreator from '@rampant/create-intent-stream'

export default ({ db }) => {
    const engine = new Subject()
    const intentStreams = {}
    const intentSubscriptions = {}
    const createIntentStream = configureIntentStreamCreator({ db })

    engine.addIntent = (id, intent) => {
        const intentStream = createIntentStream(intent)
        const intentSubscription = intentStream.subscribe(engine)

        intentStreams[id] = intentStream
        intentSubscriptions[id] = intentSubscription
    }

    engine.removeIntent = id => {
        delete intentStreams[id]
        const intentSubscription = intentSubscriptions[id]
        intentSubscription.unsubscribe()
        delete intentSubscriptions[id]
    }

    return engine
}
