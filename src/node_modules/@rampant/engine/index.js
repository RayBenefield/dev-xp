import { Subject } from 'rxjs'
import sourceCreator from '@rampant/source-creator'
import configureIntentStreamCreator from '@rampant/create-intent-stream'

export default ({ db, plugins }) => {
    const engine = new Subject()
    const createSource = sourceCreator({ db, plugins })
    const intentStreams = {}
    const intentSubscriptions = {}
    const createIntentStream = configureIntentStreamCreator({ db, plugins })

    const sourcePool = {}
    const addSource = async sourceSettings => {
        const { name = 'empty' } = sourceSettings
        if (name in sourcePool) return

        const source = await createSource(sourceSettings, sourcePool)
        sourcePool[name] = source
    }

    engine.addSource = addSource

    engine.addIntent = (id, intent) =>
        Promise.all(intent.sources.map(addSource)).then(() => {
            const intentStream = createIntentStream({ sourcePool, intent })
            const intentSubscription = intentStream.subscribe(engine)

            intentStreams[id] = intentStream
            intentSubscriptions[id] = intentSubscription
        })

    engine.removeIntent = id => {
        delete intentStreams[id]
        const intentSubscription = intentSubscriptions[id]
        intentSubscription.unsubscribe()
        delete intentSubscriptions[id]
    }

    return engine
}
