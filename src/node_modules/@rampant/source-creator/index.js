import { of } from 'rxjs'
import { filter, map } from 'rxjs/operators'

export default ({ intent, db }) => source => {
    const payload = { intent: intent.name }

    if (source.db)
        return (
            db
                // TODO: Replace `testing` with Project ID
                .onDocumentChange(`projects/testing/custom-db/${source.db}`)
                .pipe(
                    filter(_ => _),
                    map(dbContext => ({
                        ...payload,
                        context: {
                            params: {
                                ...intent.defaults,
                                ...dbContext,
                            },
                            source,
                        },
                    }))
                )
        )

    return of({
        ...payload,
        context: {
            params: intent.defaults,
            source: { type: 'blank' },
        },
    })
}
