import { of, from, merge } from 'rxjs'
import { get, isTemplate } from '@rampant/get'
import { map, share } from 'rxjs/operators'
import createPipeline from '@rampant/pipeline-creator'

export default ({ plugins }) => async (source, sourcePool) => {
    const pluginSources = Object.values(plugins).reduce(
        (all, { sources }) => ({
            ...all,
            ...sources,
        }),
        {}
    )
    const sourceTypes = {
        ...pluginSources,
        from: ({ items = [] }) => from(items),
        merge: ({ dependencies }) =>
            merge(
                ...dependencies.map(dependency => sourcePool[dependency])
            ).pipe(map(({ params }) => params)),
        blank: () => of({}),
    }

    const { type = 'blank', extensions = [], intent } = source
    const typeCreator = sourceTypes[type]
    const stream = await typeCreator(source)
    const extenders = extensions.map(createPipeline())

    return stream.pipe(
        ...extenders,
        map(params => ({
            intent: isTemplate(intent) ? get({ $: params }, intent) : intent,
            params,
            source,
        })),
        share()
    )
}
