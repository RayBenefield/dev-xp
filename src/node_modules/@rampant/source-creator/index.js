import { of, from } from 'rxjs'
import createPipeline from '@rampant/pipeline-creator'
import { filter, map, share } from 'rxjs/operators'

export default ({ db, mixerChat }) => async source => {
    const sourceTypes = {
        from: ({ items = [] }) => from(items),
        db: ({ name }) =>
            db
                // TODO: Replace `testing` with Project ID
                .onDocumentChange(`projects/testing/custom-db/${name}`)
                .pipe(filter(_ => _)),
        'mixer-chat': ({ channelId, userId }) =>
            mixerChat({ channelId, userId }),
        blank: () => of({}),
    }

    const { type = 'blank', extensions = [] } = source
    const typeCreator = sourceTypes[type]
    const stream = await typeCreator(source)
    const extenders = extensions.map(createPipeline())

    return stream.pipe(
        ...extenders,
        map(params => ({ params, source })),
        share()
    )
}
