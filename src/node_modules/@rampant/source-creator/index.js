import { get, isTemplate } from '@rampant/get'
import { map, share } from 'rxjs/operators'
import createPipeline from '@rampant/pipeline-creator'

export default ({ plugins }) => async (source, sourcePool) => {
    const sourceTypes = Object.values(plugins).reduce(
        (all, { sources = {} }) => ({
            ...all,
            ...sources,
        }),
        {}
    )

    const { type = 'blank', extensions = [], intent } = source
    const typeCreator = sourceTypes[type]
    const stream = await typeCreator(source, sourcePool)
    const extenders = extensions.map(createPipeline({ plugins }))

    return stream.pipe(
        ...extenders,
        map(params => ({
            intent: isTemplate(intent) ? get({ $: params }, intent) : intent,
            params,
            source,
        })),
        share()
    )
}
