import { of } from 'rxjs'
import { filter, map, share } from 'rxjs/operators'

export default ({ db, mixerChat }) => async source => {
    const { type, name } = source
    if (type === 'db')
        return (
            db
                // TODO: Replace `testing` with Project ID
                .onDocumentChange(`projects/testing/custom-db/${name}`)
                .pipe(
                    filter(_ => _),
                    map(params => ({ params, source })),
                    share()
                )
        )

    if (type === 'mixer-chat') {
        const { channelId, userId } = source
        const chat = await mixerChat({ channelId, userId })

        return chat.pipe(map(params => ({ params, source })), share())
    }

    return of({ source: { type: 'blank' } }).pipe(share())
}
