import { of } from 'rxjs'
import { filter, map, share } from 'rxjs/operators'

export default ({ db, mixerChat }) => async source => {
    const sourceTypes = {
        db: ({ name }) =>
            db
                // TODO: Replace `testing` with Project ID
                .onDocumentChange(`projects/testing/custom-db/${name}`)
                .pipe(filter(_ => _)),
        'mixer-chat': ({ channelId, userId }) =>
            mixerChat({ channelId, userId }),
        blank: () => of({}),
    }

    const { type = 'blank' } = source
    const typeCreator = sourceTypes[type]
    const stream = await typeCreator(source)

    return stream.pipe(map(params => ({ params, source })), share())
}
