import mapKeys from 'lodash.mapkeys'
import capitalize from 'lodash.capitalize'

export default ({ platforms, authRepo, crypto }) => {
    const setCookies = (res, state) => user => {
        const oldCookies = crypto.decrypt(state)
        const cookies = { ...oldCookies, ...user }
        res.cookie('__session', JSON.stringify(cookies))
    }
    return {
        authorize: (platform, scopes = []) => (req, res) =>
            platforms[platform]
                .getAuthUrl({ scopes, state: req.cookies })
                .then(url => res.redirect(url)),
        callback: platform => (req, res) =>
            platforms[platform]
                .getAccessToken(req.query)
                .then(({ credentials, user }) => {
                    const userId = 'raybenefield'
                    const data = mapKeys(
                        user,
                        (_, key) => `${platform}${capitalize(key)}`
                    )

                    return Promise.all([
                        authRepo.updateUser({ userId, data }),
                        authRepo.saveToken({ credentials, userId, platform }),
                    ]).then(() => data)
                })
                .then(setCookies(res, req.query.state, platform))
                .then(() => res.redirect('/')),
    }
}
