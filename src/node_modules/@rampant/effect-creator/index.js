import get from '@rampant/get'
import { tap } from 'rxjs/operators'

export default ({ db, plugins }) => {
    const pluginEffects = Object.values(plugins).reduce(
        (all, { effects }) => ({
            ...all,
            ...effects,
        }),
        {}
    )

    const effectTypes = {
        ...pluginEffects,
        log: ({ message }) =>
            tap(payload =>
                // eslint-disable-next-line no-console
                console.log(get({ $: payload }, message))
            ),
        db: ({ action = 'upsert', doc, data }) =>
            tap(payload => {
                const key = get({ $: payload }, doc)
                const value = get({ $: payload }, data)

                db[action](`projects/testing/custom-db/${key}`, value)
            }),
        empty: tap(() => {}),
    }

    return effect => {
        const { type = 'empty' } = effect
        const effectCreator = effectTypes[type]
        return effectCreator(effect)
    }
}
