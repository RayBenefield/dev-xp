import get from '@rampant/get'
import { map, tap, filter } from 'rxjs/operators'
import templating from '@rampant/templating'

export default () => pipe => {
    const parseTypes = {
        number: val => parseInt(val, 10),
        object: val => JSON.parse(val),
        string: val => val,
    }
    const extensionTypes = {
        static: ({ key, value, parse = 'string' }) => {
            const render = templating.template(value)

            return map(payload => {
                const preprocessed = render(payload)
                const processor = parseTypes[parse]
                const processed = processor(preprocessed)

                return {
                    ...payload,
                    [key]: processed,
                }
            })
        },
        'filter-regex': ({ regex, field }) => {
            const reg = new RegExp(regex)
            return filter(payload => {
                const value = get({ $: payload }, field)
                return reg.test(value)
            })
        },
        blank: () => tap(() => {}),
    }

    const { type } = pipe
    const extensionCreator = extensionTypes[type]
    return extensionCreator(pipe)
}
