import { map, tap } from 'rxjs/operators'
import templating from '@rampant/templating'

export default () => pipe => {
    if (pipe.type === 'static') {
        const render = templating.template(pipe.value)

        return map(payload => {
            const preprocessed = render(payload.context)
            const processed = pipe.parse
                ? pipe.parse === 'number'
                    ? parseInt(preprocessed, 10)
                    : JSON.parse(preprocessed)
                : preprocessed

            return {
                ...payload,
                context: {
                    ...payload.context,
                    [pipe.key]: processed,
                },
            }
        })
    }
    return tap(() => {})
}
