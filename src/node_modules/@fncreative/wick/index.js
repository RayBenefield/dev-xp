import * as R from 'ramda'
import log from '@dev-xp/log'
import { Package } from 'node-wick'
import camelCaseKeys from '@dev-xp/camel-case-keys'
import { WickDownloader } from 'wick-downloader'

const downloader = R.memoizeWith(
    R.identity,
    R.pipe(R.constructN(0, WickDownloader), dl =>
        R.pipe(R.invoker(0, 'startService'), R.andThen(() => dl))(dl)
    )
)
const getPakNames = R.andThen(R.invoker(0, 'getPakNames'))
const shutdown = R.andThen(R.invoker(0, 'shutdown'))

const pkg = R.constructN(1, Package)
const getData = R.invoker(0, 'get_data')

const wick = {
    getPakNames: R.pipe(downloader, getPakNames),
    shutdown: R.pipe(downloader, shutdown),
    parse: R.pipe(pkg, getData, camelCaseKeys),
}

export default wick
