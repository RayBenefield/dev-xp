const babel = require('babel-core')

const babelConfig = require('./babel-config')

require('pirates').addHook(
    function hook(markdown) {
        // test whether a fenced code block specifies JavaScript
        const isJavaScript = chunk => /^(js|javascript)\s*\n/.test(chunk)

        // split along backtick fences
        const chunks = markdown.split(/^```/gm)

        // filter down to only code blocks
        const code = chunks.map((chunk, i) => {
            const odd = i % 2
            if (odd && isJavaScript(chunk)) {
                return chunk.replace(/^.+/, '')
            }
            return chunk.replace(/^.+$/gm, '')
        })

        return babel.transform(code.join(''), babelConfig).code
    },
    { exts: ['.md'], ignoreNodeModules: false }
)
