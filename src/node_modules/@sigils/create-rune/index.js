import log from '@dev-xp/log'
import * as _ from '@dev-xp/utils'

export default ({
    name,
    symbol,
    in: ins,
    out: outs,
    components,
    magic,
}) => tile => ({
    name,
    worker: (rune, inputs, outputs) => {
        magic({ rune, inputs, outputs, altar: tile.editor })
        _.forEachObjIndexed((value, key) => {
            outputs[key] = { rune, value }
        }, outputs)
    },
    builder: n => {
        n.symbol = symbol
        const addInputs = _.values(
            _.mapObjIndexed((val, key) =>
                _.invoker(1, 'addInput')(val(tile.editor, key))
            )(ins)
        )
        const addOutputs = _.values(
            _.mapObjIndexed((val, key) => _.invoker(1, 'addOutput')(val(key)))(
                outs
            )
        )
        const addControls = _.values(
            _.mapObjIndexed((val, key) =>
                _.invoker(1, 'addControl')(val(tile.editor, key))
            )(components)
        )

        return _.$(n).pipe([
            _.pipe(...(addInputs.length > 0 ? addInputs : [_.identity])),
            _.pipe(...(addOutputs.length > 0 ? addOutputs : [_.identity])),
            _.pipe(...(addControls.length > 0 ? addControls : [_.identity])),
        ])
    },
})
