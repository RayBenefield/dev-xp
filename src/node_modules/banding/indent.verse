
using. /Verse.org/Simulation

var IndentLevel:weak_map(session, int) = map{}

Tab<public>(S:string)<transacts>:string=
    if (not IndentLevel[GetSession()]):
        if. set IndentLevel[GetSession()] = 0

    Result := "\n{WithIndent(S)}"

    if (Level := IndentLevel[GetSession()]):
        if. set IndentLevel[GetSession()] = Level + 1
    Result

EndTab<public>()<transacts>:string= EndTabWith("")
EndTabWith<public>(Ending:string)<transacts>:string=
    if (Level := IndentLevel[GetSession()]):
        if. set IndentLevel[GetSession()] = Level - 1
    "\n{Ending}"

WithIndent<public>(S:string)<reads>:string= "\n" + AddIndent() + S
(S:string).WithIndent<public>()<reads>:string= WithIndent(S)
(Ss:[]string).IndentedJoin<public>()<reads>:string= (for(S:Ss). WithIndent(S)).Join("\n")

AddIndent()<reads>:string= if (Level := IndentLevel[GetSession()]):
    Count := Level*4
    Indents := if(Count > 0). for(I := 1..Count). array. ' ' else. array{}
    Concatenate(Indents)
else. ""

IndentedKeys<public>(MapWithStringKeys:[string]t where t:type)<transacts>:string=
    (for(ID->Value:MapWithStringKeys). WithIndent("- {ID}")).Join("\n")