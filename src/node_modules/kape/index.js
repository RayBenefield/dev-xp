import fs from 'fs';
import slugify from 'slugify';
import unmkdirp from 'mkdirp';
import callsite from 'callsite';
import { promisify } from 'util';
import serialize from 'pretty-format';
import transmute from 'transmutation';
import { resolve, dirname } from 'path';

const mkdirp = promisify(unmkdirp);
const writeFile = promisify(fs.writeFile);

const runTest = subject =>
    transmute()
        .extend('result', ({ input }) => Promise.resolve(subject(...input)))
        .extend('snapshot', ({ result }) => serialize(result));

const collectTests = examples => {
    const tests = [];
    const it = (test, setup) => {
        let inputs = [];
        const given = args => {
            inputs = [...inputs, ...args];
        };
        setup(given);
        inputs.forEach((input, index) =>
            tests.push({
                test,
                index,
                input,
            }),
        );
    };
    examples(it);
    return tests;
};

export const run = (suite, subject, examples) => {
    const tests = collectTests(examples);
    return transmute({ suite }).extend(
        'results',
        Promise.all(tests.map(runTest(subject))),
    );
};

const generateFileContents = ({ results }) =>
    results.reduce(
        (all, { test, index, snapshot }) => `
${all}
exports[\`${test} ${index}\`] = \`
${snapshot}
\`;
`,
        '',
    );

const ensureSnapshotsDirectoryExists = ({ snapshotDir }) => mkdirp(snapshotDir);

const saveSnapshotFile = ({ snapshotDir, suite, fileContents }) =>
    writeFile(
        resolve(snapshotDir, `${slugify(suite, { lower: true })}.js.snap`),
        fileContents,
    );

const getSnapshotDir = ({ testFile }) =>
    resolve(dirname(testFile), '__snapshots__');

export default (...args) =>
    run(...args)
        .extend('testFile', callsite()[1].getFileName())
        .extend('snapshotDir', getSnapshotDir)
        .log('Tests from: ', 'testFile')
        .log('results')
        .extend('fileContents', generateFileContents)
        .do(ensureSnapshotsDirectoryExists)
        .then(saveSnapshotFile);
