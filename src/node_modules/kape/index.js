import callsite from 'callsite';
import serialize from 'pretty-format';

export const run = (suite, subject, examples) => {
    const tests = [];
    const it = (test, setup) => {
        let inputs = [];
        const given = args => {
            inputs = [...inputs, ...args];
        };
        setup(given);
        inputs.forEach((input, index) =>
            tests.push({
                test,
                index,
                input,
            }),
        );
    };
    examples(it);
    const results = tests.map(test => {
        const result = subject(...test.input);
        return {
            ...test,
            result,
            snapshot: serialize(result),
        };
    });
    return {
        suite,
        results,
    };
};

export default (...args) => {
    const results = run(...args);
    const stack = callsite();
    const testFile = stack[1].getFileName();
    console.log('Tests from: ', testFile);
    console.log(results.results);

    const fileContents = results.results.reduce(
        (all, { test, index, snapshot }) => `
${all}
exports[\`${test} ${index}\`] = \`
${snapshot}
\`;
`,
        '',
    );
    console.log(fileContents);
};
