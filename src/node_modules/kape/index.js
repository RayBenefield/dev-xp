import fs from 'fs';
import slugify from 'slugify';
import unmkdirp from 'mkdirp';
import kapeRun from '@kape/run';
import callsite from 'callsite';
import { promisify } from 'util';
import sortBy from 'lodash.sortby';
import { resolve, dirname } from 'path';
import { white, green, grey } from 'chalk';

const mkdirp = promisify(unmkdirp);
const writeFile = promisify(fs.writeFile);

export const run = kapeRun;

const generateFileContents = ({ results }) =>
    sortBy(results, 'test', 'id').reduce(
        (all, { id, test, snapshot }) => `${all}

exports[\`${test} ${id}\`] = \`
${snapshot}
\`;`,
        '// Kape Snapshot v1',
    );

const ensureSnapshotsDirectoryExists = ({ snapshotDir }) => mkdirp(snapshotDir);

const saveSnapshotFile = ({ suiteFile, fileContents }) =>
    writeFile(suiteFile, fileContents);

const getSnapshotDir = ({ testFile }) =>
    resolve(dirname(testFile), '__snapshots__');

const getSuiteFile = ({ snapshotDir, suite }) =>
    resolve(snapshotDir, `${slugify(suite, { lower: true })}.js.snap`);

const printPass = ({ test, index }) =>
    `    ${green('âœ”')} ${grey(test)} ${white('#')}${white(index)}`;

const withResultPrinter = results =>
    console.log(results.map(printPass).join('\n'));

export default (...args) =>
    run(...args)
        .extend('testFile', callsite()[1].getFileName())
        .extend('snapshotDir', getSnapshotDir)
        .extend('suiteFile', getSuiteFile)
        .extend('previousSnapshots')
        .log('Tests from: ', 'testFile')
        .log('results', withResultPrinter)
        .extend('fileContents', generateFileContents)
        .do(ensureSnapshotsDirectoryExists)
        .then(saveSnapshotFile);
