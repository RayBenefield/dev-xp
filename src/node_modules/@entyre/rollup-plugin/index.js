import fs from 'fs'
import { extname } from 'path'

import promisify from 'es6-promisify'
import parse from '@entyre/parse-sfp'

const writeFile = promisify(fs.writeFile)

export default ({
    readmePath = './readme.md',
    packageJsonPath = './package.json',
    config = {},
    readme = '',
} = {}) => ({
    name: 'entyre',
    transform(content, id) {
        if (extname(id) !== '.md') return { code: content }

        const { body, code, attributes = {} } = parse({ content })
        readme = body
        config = attributes
        return { code }
    },
    async onwrite() {
        return Promise.all([
            writeFile(
                packageJsonPath,
                JSON.stringify(config, null, 4),
                'utf-8'
            ),
            writeFile(readmePath, readme, 'utf-8'),
        ])
    },
})
