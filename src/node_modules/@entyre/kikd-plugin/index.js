import { resolve, extname } from 'path'

import { read } from '@dev-xp/fs'
import frontMatter from 'front-matter'
import build from '@kikd/build-rollup'
import check from '@entyre/check-package'
import entyre from '@entyre/rollup-plugin'
import getJsDetails from '@kikd/package-details-js'
import rollup, { commonPlugins } from '@kikd/rollup-utils'

const type = 'entyre-package'
const rollupConfig = { type, outFile: 'index.js', format: 'cjs' }

export default {
    type,
    filter: ({ root, name, srcDir = '.', files = [] }) => {
        if (files.includes('package.json')) {
            const { main = false } = getJsDetails({
                root,
                name,
                structure: { srcDir },
            })
            return main && extname(main) === '.md'
        }
        return files.includes('index.md')
    },
    manifest: ({ root, structure: { srcDir } }) =>
        read(resolve(root, srcDir, 'index.md'), 'utf-8')
            .then(frontMatter)
            .then(({ attributes }) => attributes),
    config: snowball => [
        rollup({
            ...rollupConfig,
            file: snowball.manifest.main || 'index.md',
            plugins: [
                entyre({
                    readmePath: resolve(
                        snowball.structure.destDir,
                        'readme.md'
                    ),
                    packageJsonPath: resolve(
                        snowball.structure.destDir,
                        'package.json'
                    ),
                }),
                ...commonPlugins,
            ],
        }),
    ],
    build,
    postBuild: () => {},
    check,
}
