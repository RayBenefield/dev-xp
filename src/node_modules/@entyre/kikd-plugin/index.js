import { resolve, extname } from 'path'

import build from '@kikd/build-rollup'
import entyre from '@entyre/rollup-plugin'
import { input, output, postInfo, commonPlugins } from '@kikd/rollup-utils'

const type = 'entyre-package'

export default {
    type,
    filter: ({ srcDir = '.', files = [] }) => {
        if (files.includes('package.json')) {
            // eslint-disable-next-line global-require, import/no-dynamic-require
            const manifest = require(resolve(srcDir, 'package.json'))
            return manifest.main && extname(manifest.main) === '.md'
        }
        return files.includes('index.md')
    },
    config: ({ baseConfig, dependencies, structure, manifest }) => {
        const file = manifest.main || 'index.md'
        const entyreConfig = {
            readmePath: resolve(structure.destDir, 'readme.md'),
            packageJsonPath: resolve(structure.destDir, 'package.json'),
        }
        return {
            type,
            in: input({
                file,
                dependencies,
                structure,
                plugins: [entyre(entyreConfig), ...commonPlugins],
            }),
            out: [output({ structure, file: 'index.js', format: 'cjs' })],
            post: postInfo({ structure, manifest, dependencies, baseConfig }),
        }
    },
    build,
    postBuild: () => {},
}
