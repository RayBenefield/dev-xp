import { join } from 'path'

import pkgDir from 'pkg-dir'
import range from 'node-range'
import insertLine from 'insert-line'
import { exists, writeSync } from '@dev-xp/fs'

export default ({ logger }) => {
    const root = pkgDir.sync()
    const worklogFile = join(root, 'docs', 'worklog.md')

    return {
        path: () => worklogFile,
        write: ({ next, last, entry }) => {
            logger.debug(`Project Root: ${root}`)
            logger.debug(`Worklog File Path: ${worklogFile}`)

            const sessions = range(next, last + 1)
                .map(number => `#${number}`)
                .join(', ')
            logger.info(`Writing worklog for sessions ${sessions}`)

            const content = `## ${sessions}\n\n${entry}`
            logger.debug('Worklog Entry:')
            logger.debug(`\n${content}`)

            if (!exists(worklogFile)) {
                logger.warn('Worklog does not exist yet, creating one.')
                const initialContent = `# Worklog\n\n${content}`
                return writeSync(worklogFile, initialContent)
            }

            return insertLine(worklogFile).contentSync(content).at(3)
        },
    }
}
