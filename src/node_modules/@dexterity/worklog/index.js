import { join } from 'path'
import { existsSync, writeFileSync } from 'fs'

import pkgDir from 'pkg-dir'
import range from 'node-range'
import insertLine from 'insert-line'

export default ({ logger }) => ({
    write: ({ next, last, entry }) => {
        const root = pkgDir.sync()
        logger.debug(`Project Root: ${root}`)
        const worklogFile = join(root, 'docs', 'worklog.md')
        logger.debug(`Worklog File Path: ${worklogFile}`)

        const sessions = range(next, last + 1)
            .map(number => `#${number}`)
            .join(', ')
        logger.info(`Writing worklog for sessions ${sessions}`)

        const content = `## ${sessions}\n\n${entry}`
        logger.debug('Worklog Entry:')
        logger.debug(`\n${content}`)

        if (!existsSync(worklogFile)) {
            logger.warn('Worklog does not exist yet, creating one.')
            const initialContent = `# Worklog\n\n${content}`
            return writeFileSync(worklogFile, initialContent)
        }

        return insertLine(worklogFile)
            .contentSync(content)
            .at(3)
    },
})
