import { join } from 'path'
import { existsSync, writeFileSync } from 'fs'

import pkgDir from 'pkg-dir'
import range from 'node-range'
import insertLine from 'insert-line'

export default ({ logger }) => ({ config, answers }) => {
    const root = pkgDir.sync()
    const worklogFile = join(root, 'docs', 'worklog.md')

    const nextSession = config.session + 1
    const lastSession = nextSession + answers.newSessions - 1
    logger.debug(`Next Session: ${nextSession}`)
    logger.debug(`Last Session: ${lastSession}`)
    const sessions = range(nextSession, lastSession + 1)
        .map(number => `#${number}`)
        .join(', ')
    logger.info(`Writing worklog for sessions ${sessions}`)
    const content = `## ${sessions}\n\n${answers.entry}`
    logger.debug('Worklog Entry:')
    logger.debug(`\n${content}`)

    if (!existsSync(worklogFile)) {
        logger.warn('Worklog does not exist yet, creating one.')
        const initialContent = `# Worklog\n\n${content}`
        return writeFileSync(worklogFile, initialContent)
    }

    return insertLine(worklogFile)
        .content(content)
        .at(3)
}
