import defaults from 'lodash.defaults'
import { prettify } from '@dexterity/logger'
import { cosmiconfig, defaultLoaders } from 'cosmiconfig'

export default ({ logger }) => {
    const explorer = cosmiconfig('dex', {
        searchPlaces: ['.dexrc'],
        loaders: { noExt: defaultLoaders['.json'] },
    })

    return {
        get: () =>
            explorer.search().then(results => {
                const configDefaults = { session: 0, subprojects: [] }

                if (!results) {
                    logger.warn('No Dex config file found')
                    return configDefaults
                }

                logger.info('Config file loaded')
                logger.debug(prettify(results))
                return defaults(results.config, configDefaults)
            }),
    }
}
