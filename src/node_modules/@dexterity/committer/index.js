import wrap from 'word-wrap'
import git from '@dev-xp/git'
import range from 'node-range'
import toText from 'markdown-to-text'

export default ({ logger }) => ({
    commit: ({ next, last, entry, configPath, worklogPath }) => {
        const sessions = range(next, last + 1)
            .map(_ => _)
            .join('/')
        const headerMessage = `docs(worklog): Log work for session${
            next !== last ? 's' : ''
        } ${sessions}.`
        logger.debug('Commmit Header:')
        logger.debug(`\n${headerMessage}`)

        const sanitizedEntry = toText(entry.replace(/\n/g, ' '))
        const entryMessage = wrap(sanitizedEntry, { width: 80 })
        logger.debug('Commit Entry:')
        logger.debug(`\n${entryMessage}`)

        return git
            .add([worklogPath, configPath])
            .then(() => git.commit([headerMessage, entryMessage]))
            .then(() => logger.info(`Committed sessions: ${sessions}`))
    },
})
