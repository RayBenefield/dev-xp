import repoCreator from '@fever/giveaway-repo'
import { tap, map, withLatestFrom } from 'rxjs/operators'

export default ({ moderator, db, logger: baseLogger }) => {
    const logger = baseLogger.child({ plugin: '@fever/cancel-giveaway' })
    const currentGiveaway$ = db.onDocumentChange('giveaways/current')
    const createRepo = repoCreator({ db, logger })

    moderator
        .command$('cancel-giveaway', { streamer: true })
        .pipe(
            withLatestFrom(currentGiveaway$),
            map(([, { entryPool, giveaway }]) =>
                createRepo({ entryPool, giveaway })
            ),
            tap(repo => repo.removeGiveaway()),
            tap(repo => repo.clearCurrentGiveaway()),
            tap(repo =>
                moderator.whisperStreamer(`Cancelled giveaway: [${repo.key()}]`)
            ),
            tap(repo => logger.extend(`Cancelled giveaway: [${repo.key()}]`))
        )
        .subscribe()
}
