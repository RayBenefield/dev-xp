import { tap, map } from 'rxjs/operators'

export default ({ moderator, logger, giveawayRepo }) =>
    moderator
        .command$('cancel-giveaway', { streamer: true })
        .pipe(
            moderator.currentGiveaway(),
            map(([, { entryPool, giveaway }]) =>
                giveawayRepo.with({ entryPool, giveaway })
            ),
            tap(giveaway => giveaway.removeGiveaway()),
            tap(giveaway => giveaway.clearCurrentGiveaway()),
            tap(giveaway =>
                moderator.whisperStreamer(
                    `Cancelled giveaway: [${giveaway.key()}]`
                )
            ),
            tap(giveaway =>
                logger.extend(`Cancelled giveaway: [${giveaway.key()}]`)
            )
        )
