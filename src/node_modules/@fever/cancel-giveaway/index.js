import repoCreator from '@rampant-giveaway/repo'
import { tap, map } from 'rxjs/operators'

export default ({ moderator, db, logger }) => {
    const createRepo = repoCreator({ db, logger })

    moderator
        .command$('cancel-giveaway', { streamer: true })
        .pipe(
            moderator.currentGiveaway(),
            map(([, { entryPool, giveaway }]) =>
                createRepo({ entryPool, giveaway })
            ),
            tap(repo => repo.removeGiveaway()),
            tap(repo => repo.clearCurrentGiveaway()),
            tap(repo =>
                moderator.whisperStreamer(`Cancelled giveaway: [${repo.key()}]`)
            ),
            tap(repo => logger.extend(`Cancelled giveaway: [${repo.key()}]`))
        )
        .subscribe()
}
