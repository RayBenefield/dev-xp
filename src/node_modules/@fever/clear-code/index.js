import { tap, withLatestFrom } from 'rxjs/operators'

export default ({ moderator, db, logger: baseLogger }) => {
    const logger = baseLogger.child({ plugin: '@fever/clear-code' })
    const currentCode$ = db.onDocumentChange('codes/current')

    moderator
        .command$('clear-code', { streamer: true, mod: true })
        .pipe(
            withLatestFrom(currentCode$),
            moderator.gate(
                ([, { code }]) => code,
                'There is currently no active code.'
            ),
            tap(() =>
                db.set('codes/current', { code: '', mode: '', server: '' })
            ),
            tap(([{ userName }]) => {
                moderator.whisperStreamer(
                    `[${userName}] just cleared the code.`
                )
                moderator.whisper({
                    userName,
                    message: 'Cleared the current code.',
                })
                logger.extend(`[${userName}] just cleared the code.`)
            })
        )
        .subscribe()
}
