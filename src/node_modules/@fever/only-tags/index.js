import find from 'lodash.find'
import { tap, delay, filter } from 'rxjs/operators'

export default ({ moderator }) => {
    const onlyMessagesThatContainTags = entry =>
        find(entry.message.message, { type: 'tag' })
    const withTags$ = moderator.chat$.pipe(filter(onlyMessagesThatContainTags))
    const onlyMessagesWithTextType = ({ type }) => type === 'text'
    const onlyMessagesWithEmojis = ({ type }) => type === 'emoticon'
    const onlyMessagesWithActualText = ({ text = '' }) => text.trim().length > 0
    const onlyMessagesWithExclusivelyTags = entry =>
        entry.message.message
            .filter(onlyMessagesWithTextType)
            .filter(onlyMessagesWithActualText).length === 0 &&
        entry.message.message.filter(onlyMessagesWithEmojis).length === 0
    return withTags$.pipe(
        filter(onlyMessagesWithExclusivelyTags),
        delay(3000),
        tap(moderator.erase)
    )
}
