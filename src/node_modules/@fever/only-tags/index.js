import find from 'lodash.find'
import { tap, delay, filter } from 'rxjs/operators'

export default ({ moderator, logger: baseLogger }) => {
    const logger = baseLogger.child({ plugin: '@fever/only-tags' })

    const onlyMessagesThatContainTags = entry =>
        find(entry.message.message, { type: 'tag' })
    const withTags$ = moderator.chat$.pipe(filter(onlyMessagesThatContainTags))
    const onlyMessagesWithTextType = ({ type }) => type === 'text'
    const onlyMessagesWithActualText = ({ text = '' }) => text.trim().length > 0
    const onlyMessagesWithExclusivelyTags = entry =>
        entry.message.message
            .filter(onlyMessagesWithTextType)
            .filter(onlyMessagesWithActualText).length === 0
    withTags$
        .pipe(
            filter(onlyMessagesWithExclusivelyTags),
            delay(3000),
            tap(moderator.erase)
        )
        .subscribe()
    logger.platform('Tag only message stream setup.')
}
