import { tap, map } from 'rxjs/operators'

export default ({ moderator, logger, giveawayRepo }) =>
    moderator.command$('enter').pipe(
        moderator.currentGiveaway(),
        moderator.gate(
            ([, { giveaway }]) => giveaway,
            'There is currently no giveaway happening.'
        ),
        moderator.gate(
            ([{ userId }, { entrants = [] }]) => !entrants.includes(userId),
            'You are already in the giveaway.'
        ),
        map(([msg, current]) => ({
            giveaway: giveawayRepo.with(current),
            msg,
        })),
        tap(({ giveaway, msg: { userId } }) => giveaway.addEntrant(userId)),
        tap(({ msg: { userName } }) =>
            logger.extend(`${userName} entered the giveaway.`)
        ),
        map(({ msg: { userName } }) => ({
            userName,
            message: 'You have been entered into the giveaway.',
        })),
        tap(moderator.whisper)
    )
