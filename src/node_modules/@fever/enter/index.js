import repoCreator from '@rampant-giveaway/repo'
import { tap, map } from 'rxjs/operators'

export default ({ moderator, db, logger }) => {
    const createRepo = repoCreator({ db, logger })

    moderator
        .command$('enter')
        .pipe(
            moderator.currentGiveaway(),
            moderator.gate(
                ([, { giveaway }]) => giveaway,
                'There is currently no giveaway happening.'
            ),
            moderator.gate(
                ([{ userId }, { entrants = [] }]) => !entrants.includes(userId),
                'You are already in the giveaway.'
            ),
            map(([msg, current]) => ({ repo: createRepo(current), msg })),
            tap(({ repo, msg: { userId } }) => repo.addEntrant(userId)),
            tap(({ msg: { userName } }) =>
                logger.extend(`${userName} entered the giveaway.`)
            ),
            map(({ msg: { userName } }) => ({
                userName,
                message: 'You have been entered into the giveaway.',
            }))
        )
        .subscribe(moderator.whisper)
}
