import createCommandStream from '@rampant-giveaway/commands'
import { tap, filter, map, withLatestFrom } from 'rxjs/operators'

export default ({ moderator, db, logger: baseLogger }) => {
    const logger = baseLogger.child({ plugin: '@fever/code' })
    const command$ = createCommandStream(moderator)
    const currentCode$ = db.onDocumentChange('codes/current')

    command$
        .pipe(
            filter(({ command }) => command === 'code'),
            withLatestFrom(currentCode$),
            map(([{ user_name: userName }, { code, server, mode } = {}]) => {
                const serverMsg = `server: ${server || 'NAE'}`
                const modeMsg = mode || 'Duos Fill - SOLO QUEUE ONLY'
                const codeMsg = `code: ${code}`
                const message = code
                    ? `${serverMsg} :: ${modeMsg} :: ${codeMsg}`
                    : 'Code changes every game wait until we get back to lobby for a new code'

                return { message: `@${userName} ${message}`, userName }
            }),
            tap(({ userName }) =>
                logger.extend(`${userName} requested a code.`)
            )
        )
        .subscribe(({ userName, message }) => {
            moderator.whisper(userName, message)
        })
}
