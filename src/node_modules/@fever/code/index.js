import { tap, map, withLatestFrom } from 'rxjs/operators'

export default ({ moderator, db, logger: baseLogger }) => {
    const logger = baseLogger.child({ plugin: '@fever/code' })
    const currentCode$ = db.onDocumentChange('codes/current')

    moderator
        .command$('code')
        .pipe(
            withLatestFrom(currentCode$),
            moderator.gate(
                ([, { code } = {}]) => code,
                ([{ userName }]) =>
                    `@${userName} the code changes every game, so wait until we get back to lobby for a new code`
            ),
            map(([{ userName }, { code, server, mode } = {}]) => {
                const serverMsg = `server: ${server || 'NAE'}`
                const modeMsg = mode || 'Duos Fill - SOLO QUEUE ONLY'
                const codeMsg = `code: ${code}`
                const message = `${serverMsg} :: ${modeMsg} :: ${codeMsg}`

                return { message: `@${userName} ${message}`, userName }
            }),
            tap(({ userName }) =>
                logger.extend(`${userName} requested a code.`)
            )
        )
        .subscribe(moderator.whisper)
}
