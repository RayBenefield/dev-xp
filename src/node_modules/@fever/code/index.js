import { tap, map } from 'rxjs/operators'

export default ({ moderator, logger }) =>
    moderator
        .command$('code')
        .pipe(
            moderator.currentCode(),
            moderator.gate(
                ([, { code } = {}]) => code,
                ([{ userName }]) =>
                    `@${userName} the code changes every game, so wait until we get back to lobby for a new code`
            ),
            map(([{ userName }, { code, server, mode } = {}]) => {
                const serverMsg = `server: ${server || 'NAE'}`
                const modeMsg = mode || 'Duos Fill - SOLO QUEUE ONLY'
                const codeMsg = `code: ${code}`
                const message = `${serverMsg} :: ${modeMsg} :: ${codeMsg}`

                return { message: `@${userName} ${message}`, userName }
            }),
            tap(({ userName }) =>
                logger.extend(`${userName} requested a code.`)
            ),
            tap(moderator.whisper)
        )
        .subscribe()
