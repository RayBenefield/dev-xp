import {
    tap,
    map,
    skip,
    filter,
    groupBy,
    mergeMap,
    debounceTime,
} from 'rxjs/operators'

export default ({ logger, moderator }) =>
    moderator.entryChanges$.pipe(
        debounceTime(1),
        skip(1),
        filter(({ type }) => type === 'modified'),
        groupBy(change => change.doc.id),
        mergeMap(entrant$ => entrant$.pipe(debounceTime(3000))),
        map(({ doc }) => doc.data()),
        filter(({ name }) => name !== 'raybenefield'),
        tap(({ entries, name }) => {
            logger.extend(`${name}: ${entries} entries`)
            moderator.whisper({
                userName: name,
                message: `You now have [${entries}] #FeverFam entries for giveaways.`,
            })
        })
    )
