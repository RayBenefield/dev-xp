import repoCreator from '@fever/giveaway-repo'
import { map, mergeMap, withLatestFrom } from 'rxjs/operators'

export default ({ moderator, db, prefix, logger: baseLogger }) => {
    const logger = baseLogger.child({ plugin: '@fever/give' })
    const currentGiveaway$ = db.onDocumentChange('giveaways/current')
    const createRepo = repoCreator({ db, logger })

    const startOrUpdate = ({ repo, slots }) => data =>
        !data
            ? repo.startGiveaway(slots)
            : repo.updateCurrentGiveaway(data.slots + slots)

    const startGiveaway = ({ repo, slots }) =>
        repo
            .getGiveaway()
            .then(startOrUpdate({ repo, slots }))
            .then(() => repo.updateCurrentGiveaway())

    moderator
        .command$('give', { streamer: true })
        .pipe(
            withLatestFrom(currentGiveaway$),
            moderator.gate(
                ([, { giveaway }]) => !giveaway,
                ([, { giveaway }]) =>
                    `You are already running a [${giveaway}] giveaway.`
            ),
            moderator.gate(
                ([{ args }]) => args.length > 0,
                `You've given no arguments for a giveaway.`
            ),
            map(([{ args }]) => {
                let giveaway = null
                let entryPool = prefix
                const slots = 1

                if (args.length === 1) giveaway = args[0]

                if (args.length === 2) {
                    giveaway = args[0]
                    entryPool = args[1]
                }
                return { giveaway, entryPool, slots }
            }),
            map(({ giveaway, entryPool, slots }) => ({
                repo: createRepo({ giveaway, entryPool }),
                slots,
            })),
            mergeMap(startGiveaway)
        )
        .subscribe()
}
