import { filter } from 'rxjs/operators'
import createCommandStream from '@rampant-giveaway/commands'

export default ({ moderator, db, prefix, logger: baseLogger }) => {
    const logger = baseLogger.child({ plugin: '@fever/give' })
    const command$ = createCommandStream(moderator)

    command$
        .pipe(
            filter(
                ({ user_name, command }) =>
                    command === 'give' &&
                    user_name.toLowerCase() === 'raybenefield'
            )
        )
        // eslint-disable-next-line complexity
        .subscribe(({ args }) => {
            let giveaway = null
            let entryPool = prefix
            const slots = 1

            if (args.length === 0) {
                console.log('No arguments given for giveaway.')
            }

            if (args.length === 1) {
                giveaway = args[0]
            }
            if (args.length === 2) {
                giveaway = args[0]
                entryPool = args[1]
            }
            db.set('giveaways/current', { entryPool, giveaway })
            logger.extend(
                `Starting a giveaway with ${entryPool}-entries for ${giveaway} giveaway with ${slots} winner${
                    slots > 1 ? 's' : ''
                }`
            )
        })
}
