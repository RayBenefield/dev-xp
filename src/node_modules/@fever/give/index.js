import { tap, map, filter, withLatestFrom } from 'rxjs/operators'
import createCommandStream from '@rampant-giveaway/commands'

export default ({ moderator, db, prefix, logger: baseLogger }) => {
    const logger = baseLogger.child({ plugin: '@fever/give' })
    const command$ = createCommandStream(moderator)
    const currentGiveaway$ = db.onDocumentChange('giveaways/current')

    command$
        .pipe(
            filter(
                ({ user_name, command }) =>
                    command === 'give' &&
                    user_name.toLowerCase() === 'raybenefield'
            ),
            withLatestFrom(currentGiveaway$),
            tap(
                ([, { giveaway }]) =>
                    giveaway &&
                    moderator.whisper(
                        'raybenefield',
                        `You are already running a [${giveaway}] giveaway.`
                    )
            ),
            filter(([, { giveaway }]) => !giveaway),
            map(([{ args }]) => {
                let giveaway = null
                let entryPool = prefix

                if (args.length === 0) {
                    console.log('No arguments given for giveaway.')
                }

                if (args.length === 1) {
                    giveaway = args[0]
                }
                if (args.length === 2) {
                    giveaway = args[0]
                    entryPool = args[1]
                }
                return { giveaway, entryPool }
            })
        )
        // eslint-disable-next-line complexity
        .subscribe(({ giveaway, entryPool }) => {
            const slots = 1
            db.set('giveaways/current', { entryPool, giveaway })
            logger.extend(
                `Starting a giveaway with ${entryPool}-entries for ${giveaway} giveaway with ${slots} winner${
                    slots > 1 ? 's' : ''
                }`
            )
        })
}
