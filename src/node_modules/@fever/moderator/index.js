import filterCommand from '@fever/filter-command'
import { filter, share } from 'rxjs/operators'
import createCommandStream from '@rampant-giveaway/commands'

const cache = {}

export default ({ chat, streamer }) => {
    const command$ = createCommandStream(chat)

    const intent$ = intent => {
        if (intent in cache) return cache[intent]
        const stream = command$.pipe(
            filter(({ command }) => command === intent),
            share()
        )
        cache[intent] = stream
        return stream
    }

    return {
        whisper: ({ userName, message }) => chat.whisper(userName, message),
        message: chat.message,
        whisperStreamer: msg => chat.whisper(streamer, msg),
        command$: (intent, options) => {
            if (!options) return intent$(intent)
            return intent$(intent).pipe(filter(filterCommand))
        },
    }
}
