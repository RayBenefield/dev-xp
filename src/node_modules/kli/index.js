import TS from 'trie-search';
import { inspect } from 'util';

export const jsonRenderer = obj =>
    console.log(inspect(obj, { showHidden: false, depth: null }));

const configureKli = ({ defaultRenderer = console.log } = {}) => (
    { commands = [] } = {},
) => {
    if (!Array.isArray(commands)) throw new Error('Commands must be an array');
    if (commands.length === 0) throw new Error('No commands defined');

    commands.forEach(c => {
        if (typeof c.run !== 'function')
            throw new Error('All commands must have a run method');
    });

    const parsedCommands = commands.map(command => ({
        ...command,
        tokens: [command.name, ...(command.aliases || [])].join(' '),
    }));

    const searcher = new TS(['tokens']);
    searcher.addAll(parsedCommands);

    return {
        execute: args => {
            if (commands.length === 1) return commands[0].run();
            const command = searcher.get(args[0])[0];
            const results = command.run();
            if (!results) return true;
            if (typeof results.then === 'function') {
                return results.then(defaultRenderer);
            }
            return defaultRenderer(results);
        },
    };
};

export const configure = configureKli;
export default configureKli({ defaultRenderer: console.log });
