import log from '@dev-xp/log'
import keyBy from 'lodash.keyby'
import sanitizer from '@kli-tool/sanitizer'
import createDecider from '@kli-tool/decider'
import createExecutor from '@kli-tool/executor'

const configureKli = ({ style = {}, renderer = log } = {}) => ({
    default: proposedDefault,
    config = {},
    commands: rawCommands = [],
    cleanse = {},
} = {}) => {
    sanitizer(rawCommands)
    const commands = keyBy(rawCommands, 'name')

    const decider = createDecider({ commands, proposedDefault, log: renderer })
    const execute = createExecutor({
        config,
        defaultStyle: style,
        defaultRenderer: renderer,
        decider,
        cleanse,
    })

    return { execute }
}

export const configure = configureKli
export const kli = configureKli()

export default configureKli()
