import fs from 'fs'
import { resolve } from 'path'

import promisify from 'es6-promisify'

const lstat = promisify(fs.lstat)

// eslint-disable-next-line complexity
export default async ({
    name,
    root = '.',
    structure: { srcDir = '.' } = {},
    manifest: { main, bin, version } = {},
} = {}) => {
    const checks = {}

    try {
        const readmeFile = resolve(root, srcDir, 'readme.md')
        const readme = await lstat(readmeFile)
        checks['has readme file'] = !!readme.isFile
    } catch (err) {
        checks['has readme file'] = false
    }

    try {
        if (main || !bin) {
            const mainFilePath = resolve(root, srcDir, main || 'index.js')
            const mainFile = await lstat(mainFilePath)
            checks['has main and/or all bin files'] = !!mainFile.isFile
        }

        if (bin) {
            const bins = Object.values(bin)
            const binFiles = await Promise.all(
                bins.map(b => resolve(root, srcDir, b)).map(async b => lstat(b))
            )
            const notFile = file => !file.isFile
            checks['has main and/or all bin files'] = !binFiles.some(notFile)
        }
    } catch (err) {
        checks['has main and/or all bin files'] = false
    }

    checks['has a version number'] = !!version

    const failed = check => !check

    if (Object.values(checks).some(failed)) {
        return {
            [name]: {
                ...checks,
                publishable: false,
            },
        }
    }

    return { [name]: { ...checks, publishable: true } }
}
