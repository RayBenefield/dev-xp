import collapse from '@kikd/collapse'

export default ({ plugins = {} }) => ({
    packageNames = [],
    rootManifest,
    dependencies,
    structures,
    manifests,
    types,
} = {}) =>
    Promise.all(
        packageNames
            .map(
                name =>
                    types[name] !== 'unknown'
                        ? /* eslint-disable indent */
                          [
                              name,
                              plugins[types[name]].config({
                                  rootManifest,
                                  dependencies: dependencies[name],
                                  structure: structures[name],
                                  manifest: manifests[name],
                              }),
                          ]
                        : [name, {}]
            )
            .map(([name, maybe]) =>
                Promise.resolve(maybe).then(config => ({ [name]: config }))
            )
    ).then(configs => configs.reduce(collapse, {}))
