import configureGit from 'simple-git/promise';

const git = configureGit().outputHandler((command, stdout, stderr) => {
    stdout.pipe(process.stdout);
    stderr.pipe(process.stderr);
});

export default () => {
    const { GH_USER, GH_EMAIL, GH_REPO, GH_TOKEN } = process.env;

    if (!GH_USER) throw new Error('The GH_USER env variable must be set!');
    if (!GH_EMAIL) throw new Error('The GH_EMAIL env variable must be set!');
    if (!GH_REPO) throw new Error('The GH_REPO env variable must be set!');
    if (!GH_TOKEN) throw new Error('The GH_TOKEN env variable must be set!');

    console.log('Setting committer...');
    return git
        .addConfig('user.name', GH_USER)
        .then(() => git.addConfig('user.email', GH_EMAIL))
        .then(() => console.log('Setting up branch...'))
        .then(() =>
            git.addRemote(
                'origin-deploy',
                `https://${GH_TOKEN}@github.com/${GH_REPO}.git`,
            ),
        )
        .then(() => git.fetch('origin-deploy', 'master'))
        .then(() =>
            git.checkout([
                '-B',
                'deploy-master',
                '--track',
                'origin-deploy/master',
            ]),
        )
        .then(() => git.reset(['--hard', 'origin-deploy/master']));
};
