import git from '@kikd/git'
import log from '@dev-xp/log'

export default () => {
    const { GH_USER, GH_EMAIL, GH_REPO, GH_TOKEN } = process.env

    log('Setting committer...')
    return git
        .addConfig('user.name', GH_USER)
        .then(() => git.addConfig('user.email', GH_EMAIL))
        .then(() => log('Setting up branch...'))
        .then(() =>
            git.addRemote(
                'origin-deploy',
                `https://${GH_TOKEN}@github.com/${GH_REPO}.git`
            )
        )
        .then(() => git.fetch('origin-deploy', 'master'))
        .then(() =>
            git.checkout([
                '-B',
                'deploy-master',
                '--track',
                'origin-deploy/master',
            ])
        )
        .then(() => git.reset(['--hard', 'origin-deploy/master']))
}
