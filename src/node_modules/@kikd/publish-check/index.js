import has from 'lodash.has'
import every from 'lodash.every'
import partial from 'lodash.partial'
import collapse from '@kikd/collapse'

const requiredProps = [
    'description',
    'homepage',
    'author',
    'repository',
    'bugs',
    'license',
    'dependencies',
]
const isIn = obj => partial(has, obj)

export default ({ plugins = {} } = {}) => ({
    rootStructure: { files = [] } = {},
    rootManifest = {},
    packageNames = [],
    types = {},
    structures = {},
    manifests = {},
} = {}) =>
    Promise.all(
        packageNames.map(name => {
            const noChecks = { [name]: {} }
            if (!plugins[types[name]]) return noChecks
            if (!plugins[types[name]].check) return noChecks

            return plugins[types[name]]
                .check({
                    structure: structures[name],
                    manifest: manifests[name],
                })
                .then(checks => ({ [name]: checks }))
        })
    )
        .then(checks => checks.reduce(collapse, {}))
        .then(packageChecks => ({
            root: {
                'has root license': files.includes('LICENSE'),
                'has required props': every(requiredProps, isIn(rootManifest)),
            },
            packages: packageChecks,
        }))
