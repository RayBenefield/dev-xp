/* eslint-disable global-require, import/no-dynamic-require */
import { readdirSync as readDir } from 'fs'
import { resolve } from 'path'

import describe from 'kape'
import collapse from '@kikd/collapse'
import publishCheck from '@kikd/publish-check'

describe('Publish Check', publishCheck, snapshot => {
    process.chdir(resolve(__dirname, 'fixtures'))
    const repo = dir => {
        const modules = readDir(resolve(__dirname, 'fixtures', dir)).filter(
            f => f !== 'LICENSE' && f !== 'package.json'
        )
        return {
            root: dir,
            rootStructure: {
                files: readDir(resolve(__dirname, 'fixtures', dir)),
            },
            rootManifest: require(resolve(
                __dirname,
                `fixtures/${dir}/package.json`
            )),
            packageNames: modules,
            structures: modules
                .map(mod => ({
                    [mod]: {
                        srcDir: mod,
                        files: readDir(
                            resolve(__dirname, `fixtures/${dir}/${mod}`)
                        ),
                    },
                }))
                .reduce(collapse, {}),
            manifests: modules
                .map(mod => ({
                    [mod]: require(resolve(
                        __dirname,
                        `fixtures/${dir}/${mod}/package.json`
                    )),
                }))
                .reduce(collapse, {}),
        }
    }

    snapshot(
        [],
        [repo('no-license')],
        [repo('has-license')],
        [repo('has-license-with-props')]
    )
})
