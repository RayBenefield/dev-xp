import { relative, resolve } from 'path'

import { readDir } from '@dev-xp/fs'
import collapse from '@kikd/collapse'

const cache = {}

const getStructure = ({ root, name }) => {
    if (name in cache) return { [name]: cache[name] }

    const srcDir = relative(root, resolve(root, 'src/node_modules', name))
    const destDir = relative(root, resolve(root, 'dist', name))
    const files = readDir(resolve(root, srcDir))
    const structure = { name, root, srcDir, destDir, files }
    cache[structure.name] = structure

    return { [name]: structure }
}

export default ({ root, packageNames = [] }) =>
    packageNames.map(name => getStructure({ root, name })).reduce(collapse, {})
