import transmute from 'transmutation'
import uniq from 'lodash.uniq'
import collapse from '@kikd/collapse'
import detective from '@kikd/dependency-detective'
import findPackages from '@kikd/find-packages'
import getStructures from '@kikd/package-structure'
import getPackageDetails from '@kikd/package-details'
import getTypes from '@kikd/package-types'

export default config => async ({ root, exclude, packageNames = [] } = {}) => {
    if (!root) return {}
    if (packageNames.length <= 0) return {}

    const packageBasics = transmute({ root, exclude })
        .extend('packageNames', findPackages)
        .extend('structures', getStructures)
        .extend('types', getTypes(config))
        .extend('manifests', getPackageDetails(config))

    const { packageNames: locals, structures, manifests } = await packageBasics

    const findDependencies = detective({ root, locals, structures, manifests })
    return Promise.all(
        packageNames.map(name =>
            findDependencies(name)
                .then(deps =>
                    Object.entries(deps).reduce(function addDeps(
                        list,
                        [dep, depsOfDep]
                    ) {
                        return [
                            ...list,
                            dep,
                            ...Object.entries(depsOfDep).reduce(addDeps, []),
                        ]
                    },
                    [])
                )
                .then(uniq)
                .then(deps => ({
                    [name]: {
                        local: deps.filter(dep => locals.includes(dep)),
                        external: deps.filter(dep => !locals.includes(dep)),
                    },
                }))
        )
    ).then(results => results.reduce(collapse, {}))
}
