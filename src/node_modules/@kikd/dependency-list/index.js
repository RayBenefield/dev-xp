import uniq from 'lodash.uniq'
import collapse from '@kikd/collapse'
import detective from '@kikd/dependency-detective'
import findPackages from '@kikd/find-packages'

export default async ({
    root,
    exclude,
    packageNames = [],
    structures = {},
    manifests = {},
} = {}) => {
    if (!root) return {}
    if (packageNames.length <= 0) return {}

    const locals = await findPackages({ root, exclude })
    const findDependencies = detective({ root, locals, structures, manifests })
    return Promise.all(
        packageNames.map(name =>
            findDependencies(name)
                .then(deps =>
                    Object.entries(deps).reduce(function addDeps(
                        list,
                        [dep, depsOfDep]
                    ) {
                        return [
                            ...list,
                            dep,
                            ...Object.entries(depsOfDep).reduce(addDeps, []),
                        ]
                    },
                    [])
                )
                .then(uniq)
                .then(deps => ({
                    [name]: {
                        local: deps.filter(dep => locals.includes(dep)),
                        external: deps.filter(dep => !locals.includes(dep)),
                    },
                }))
        )
    ).then(results => results.reduce(collapse, {}))
}
