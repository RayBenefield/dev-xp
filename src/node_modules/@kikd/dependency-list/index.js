import uniq from 'lodash.uniq';
import collapsePackages from '@kikd/collapse';
import detective from '@kikd/dependency-detective';

export default ({ root, packages = [] } = {}) => {
    if (!root) return {};
    if (packages.length <= 0) return {};

    const findDependencies = detective(root);
    return Promise.all(
        packages.filter(({ name }) => name).map(({ name }) =>
            findDependencies(name)
                .then(deps =>
                    Object.entries(deps).reduce(function addDeps(
                        list,
                        [dep, depsOfDep],
                    ) {
                        return [
                            ...list,
                            dep,
                            ...Object.entries(depsOfDep).reduce(addDeps, []),
                        ];
                    },
                    []),
                )
                .then(uniq)
                .then(deps => ({ [name]: deps })),
        ),
    ).then(results => results.reduce(collapsePackages, {}));
};
