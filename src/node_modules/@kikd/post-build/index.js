import fs from 'fs'
import { resolve } from 'path'

import pick from 'lodash.pick'
import { write } from '@dev-xp/json'
import promisify from 'es6-promisify'

const copy = promisify(fs.copyFile)
const requiredProps = [
    'description',
    'homepage',
    'author',
    'repository',
    'bugs',
    'license',
]

export default ({ root, rootManifest, config }) =>
    Promise.all([
        copy(
            resolve(root, 'LICENSE'),
            resolve(root, config.destDir, 'LICENSE')
        ),
        copy(
            resolve(root, config.srcDir, 'readme.md'),
            resolve(root, config.destDir, 'readme.md')
        ),
        write(resolve(root, config.destDir, 'package.json'), {
            name: config.name,
            ...config.packageConfig,
            ...pick(rootManifest, requiredProps),
            dependencies: {
                ...config.packageConfig.dependencies,
                ...config.dependencyVersions,
            },
        }),
    ])
