import log from '@dev-xp/log'
import { NOFN } from '@dev-xp/noop'

export default ({ plug = NOFN } = {}) => ({
    root,
    rootManifest,
    configs = {},
} = {}) => {
    const allConfigs = [].concat(...Object.values(configs))

    const buildPackages = () =>
        Promise.all(
            allConfigs
                .map(config => ({ root, config, type: config.type }))
                .map(plug('build'))
        )
    const postBuildPackages = () =>
        Promise.all(
            allConfigs
                .map(config => ({
                    root,
                    rootManifest,
                    config: config.post,
                    type: config.type,
                }))
                .map(plug('postBuild'))
        )

    return buildPackages().then(postBuildPackages)
}
