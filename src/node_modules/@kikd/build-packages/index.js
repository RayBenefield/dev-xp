import { resolve } from 'path'

import rimraf from 'rimraf'
import promisify from 'es6-promisify'

const removeDir = promisify(rimraf)

export default ({ plugins = [] }) => {
    const finalPlugins = plugins.reduce(
        (all, plugin) => ({ ...all, [plugin.type]: plugin }),
        {}
    )
    return ({ root, baseConfig, configs = [] } = {}) =>
        removeDir(resolve(root, 'dist')).then(() =>
            Promise.all(
                configs.map(config =>
                    finalPlugins[config.type].build({ root, config }).then(() =>
                        finalPlugins[config.type].postBuild({
                            root,
                            baseConfig,
                            config: config.post,
                        })
                    )
                )
            )
        )
}
