import { resolve } from 'path'

import rimraf from 'rimraf'
import promisify from 'es6-promisify'

const removeDir = promisify(rimraf)

export default ({ plugins = {} } = {}) => ({
    root,
    rootManifest,
    configs = {},
} = {}) => {
    const allConfigs = [].concat(...Object.values(configs))

    const buildPackage = config => plugins[config.type].build({ root, config })
    const postBuildPackage = config =>
        plugins[config.type].postBuild({
            root,
            rootManifest,
            config: config.post,
        })

    return removeDir(resolve(root, 'dist')).then(() =>
        Promise.all(allConfigs.map(buildPackage)).then(() =>
            Promise.all(allConfigs.map(postBuildPackage))
        )
    )
}
