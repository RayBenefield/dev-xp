import { resolve } from 'path'

import log from '@dev-xp/log'
import rimraf from 'rimraf'
import { NOFN } from '@dev-xp/noop'
import promisify from 'es6-promisify'

const removeDir = promisify(rimraf)

export default ({ plug = NOFN } = {}) => ({
    root,
    rootManifest,
    configs = {},
} = {}) => {
    const allConfigs = [].concat(...Object.values(configs))

    const buildPackages = () =>
        Promise.all(
            allConfigs
                .map(config => ({ root, config, type: config.type }))
                .map(plug('build'))
        )
    const postBuildPackages = () =>
        Promise.all(
            allConfigs
                .map(config => ({
                    root,
                    rootManifest,
                    config: config.post,
                    type: config.type,
                }))
                .map(plug('postBuild'))
        )

    return removeDir(resolve(root, 'dist'))
        .then(buildPackages)
        .then(postBuildPackages)
}
