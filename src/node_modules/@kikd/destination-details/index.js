import execa from 'execa';
import { resolve } from 'path';
import collapsePackages from '@kikd/collapse';

const fields = ['version'];

export default ({ root, publishable }) =>
    Promise.all(
        publishable.map(({ name, distDir }) =>
            Promise.all([
                execa('npm', ['view', name, ...fields])
                    .then(result => result.stdout)
                    .catch(() => null),
                new Promise(res => {
                    try {
                        return res(
                            // eslint-disable-next-line global-require, import/no-dynamic-require
                            require(resolve(root, distDir, 'package.json'))
                                .version,
                        );
                    } catch (e) {
                        throw e;
                    }
                }).catch(() => null),
            ]).then(([destVersion, srcVersion]) => ({
                [name]: { destVersion, srcVersion },
            })),
        ),
    ).then(results => results.reduce(collapsePackages, {}));
