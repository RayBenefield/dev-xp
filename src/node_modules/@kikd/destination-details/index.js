import { resolve } from 'path'

import execa from 'execa'
import collapsePackages from '@kikd/collapse'

const fields = ['version']

export default ({ root, packages }) =>
    Promise.all(
        packages.map(({ name, dir }) =>
            Promise.all([
                execa('npm', ['view', name, ...fields])
                    .then(result => result.stdout)
                    .catch(() => null),
                new Promise(res => {
                    try {
                        const packageJson = resolve(root, dir, 'package.json')
                        // eslint-disable-next-line global-require, import/no-dynamic-require
                        return res(require(packageJson).version)
                    } catch (e) {
                        throw e
                    }
                }).catch(() => null),
            ]).then(([destVersion, srcVersion]) => ({
                [name]: { destVersion, srcVersion },
            }))
        )
    ).then(results => results.reduce(collapsePackages, {}))
