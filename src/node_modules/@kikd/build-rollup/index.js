import { resolve } from 'path'

import log from '@dev-xp/log'
import { rollup } from 'rollup'

const paths = (obj, props = [], root) =>
    props.reduce(
        (finalPaths, prop) => ({
            ...finalPaths,
            [prop]: resolve(root, obj[prop]),
        }),
        {}
    )

export default ({ root, config }) =>
    rollup({ ...config.in, ...paths(config.in, ['input'], root) }).then(
        bundle =>
            Promise.all(
                config.out.map(output =>
                    bundle.write({
                        ...output,
                        ...paths(output, ['file'], root),
                    })
                )
            )
    )
