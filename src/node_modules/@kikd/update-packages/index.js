import { resolve } from 'path';
import jsonFile from 'jsonfile';
import { promisify } from 'util';

const readJson = promisify(jsonFile.readFile);
const writeJson = promisify(jsonFile.writeFile);

export default ({ root, updates, filtered }) =>
    Promise.all(
        filtered.filter(pkg => pkg.name in updates).map(({ name, dir }) =>
            readJson(resolve(root, dir, 'package.json'))
                .then(config => ({ ...config, version: updates[name].new }))
                .then(config =>
                    writeJson(resolve(root, dir, 'package.json'), config, {
                        spaces: 4,
                    }),
                ),
        ),
    );
