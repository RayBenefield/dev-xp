```js
import transmute from 'transmutation'
import findPackages from '@kikd/find-packages'
import publishCheck from '@kikd/publish-check'
import getChanges from '@semcom/command-changes'
import getPackageDetails from '@kikd/package-details'

export default config => snowball => {
    const { packageNames, onlyPublishable, allPackages, onlyChanged } = config

    if (allPackages) return findPackages(snowball)

    if (Array.isArray(packageNames) && packageNames.length > 0)
        return packageNames

    if (onlyPublishable)
        return transmute(snowball)
            .extend('packageNames', findPackages)
            .extend('packages', getPackageDetails)
            .extend('checks', publishCheck)
            .extend('publishable', ({ packages, checks }) =>
                packages.filter(pkg => checks.packages[pkg.name].publishable)
            )
            .then(obj => obj.publishable.map(pkg => pkg.name))

    if (onlyChanged)
        return getChanges()
            .extend('names', findPackages)
            .then(({ names, changes }) =>
                names.filter(pkg =>
                    changes.some(({ scopes }) => scopes.includes(pkg))
                )
            )

    return findPackages(snowball)
}
```
