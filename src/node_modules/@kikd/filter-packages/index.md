```js
import transmute from 'transmutation'
import getPublishing from '@kikd/publishing'
import findPackages from '@kikd/find-packages'
import publishCheck from '@kikd/publish-check'
import getChanges from '@semcom/command-changes'
import getDependencies from '@kikd/dependency-list'
import getPackageDetails from '@kikd/package-details-js'
import destinationDetails from '@kikd/destination-details'

export default config => snowball => {
    const {
        packageNames,
        onlyPublishable,
        allPackages,
        onlyChanged,
        changedAndPublishable,
        needsPublishing,
    } = config

    if (allPackages) return findPackages(snowball)

    if (Array.isArray(packageNames) && packageNames.length > 0)
        return packageNames

    if (needsPublishing)
        return transmute(snowball)
            .extend('packageNames', findPackages)
            .extend('packages', getPackageDetails)
            .extend('checks', publishCheck)
            .extend('publishable', ({ packages, checks }) =>
                packages.filter(pkg => checks.packages[pkg.name].publishable)
            )
            .extend('destination', snowball =>
                destinationDetails({
                    ...snowball,
                    packages: snowball.publishable,
                })
            )
            .extend('publishing', getPublishing)
            .then(({ publishing }) => publishing)

    if (changedAndPublishable)
        return transmute(snowball)
            .extend(getChanges)
            .extend('packageNames', findPackages)
            .extend('packages', getPackageDetails)
            .extend('dependencies', getDependencies)
            .extend(
                'changed',
                ({ packageNames: names, dependencies, changes }) =>
                    names.filter(pkg =>
                        changes.some(
                            ({ scopes = [] }) =>
                                scopes.includes(pkg) ||
                                scopes.some(scope =>
                                    dependencies[pkg].local.includes(scope)
                                )
                        )
                    )
            )
            .extend('checks', publishCheck)
            .then(({ changed: names, checks }) =>
                names.filter(pkg => checks.packages[pkg].publishable)
            )

    if (onlyPublishable)
        return transmute(snowball)
            .extend('packageNames', findPackages)
            .extend('packages', getPackageDetails)
            .extend('checks', publishCheck)
            .extend('publishable', ({ packages, checks }) =>
                packages.filter(pkg => checks.packages[pkg.name].publishable)
            )
            .then(obj => obj.publishable.map(pkg => pkg.name))

    if (onlyChanged)
        return transmute(snowball)
            .extend(getChanges)
            .extend('packageNames', findPackages)
            .extend('packages', getPackageDetails)
            .extend('dependencies', getDependencies)
            .then(({ packageNames: names, dependencies, changes }) =>
                names.filter(pkg =>
                    changes.some(
                        ({ scopes }) =>
                            scopes.includes(pkg) ||
                            scopes.some(scope =>
                                dependencies[pkg].local.includes(scope)
                            )
                    )
                )
            )

    return findPackages(snowball)
}
```
