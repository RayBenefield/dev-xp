```js
import transmute from 'transmutation'
import getPublishing from '@kikd/publishing'
import findPackages from '@kikd/find-packages'
import publishCheck from '@kikd/publish-check'
import getChanges from '@semcom/command-changes'
import getDependencies from '@kikd/dependency-list'
import getPackageDetails from '@kikd/package-details'
import getPackageStructures from '@kikd/package-structure'
import destinationDetails from '@kikd/destination-details'

export default config => snowball => {
    const {
        packageNames,
        onlyPublishable,
        allPackages,
        onlyChanged,
        changedAndPublishable,
        needsPublishing,
    } = config

    if (allPackages) return findPackages(snowball)

    if (Array.isArray(packageNames) && packageNames.length > 0)
        return packageNames

    if (needsPublishing)
        return transmute(snowball)
            .extend('packageNames', findPackages)
            .extend('structures', getPackageStructures)
            .extend('manifests', getPackageDetails)
            .extend('checks', publishCheck)
            .extend('publishable', ({ packageNames, checks }) =>
                packageNames.filter(name => checks.packages[name].publishable)
            )
            .extend('destination', snowball =>
                destinationDetails({
                    ...snowball,
                    packages: snowball.publishable,
                })
            )
            .extend('publishing', getPublishing)
            .then(({ publishing }) => publishing)

    if (changedAndPublishable)
        return transmute(snowball)
            .extend(getChanges)
            .extend('packageNames', findPackages)
            .extend('structures', getPackageStructures)
            .extend('manifests', getPackageDetails)
            .extend('dependencies', getDependencies)
            .extend('changed', ({ packageNames, dependencies, changes }) =>
                packageNames.filter(name =>
                    changes.some(
                        ({ scopes = [] }) =>
                            scopes.includes(name) ||
                            scopes.some(scope =>
                                dependencies[name].local.includes(scope)
                            )
                    )
                )
            )
            .extend('checks', publishCheck)
            .then(({ changed: names, checks }) =>
                names.filter(pkg => checks.packages[pkg].publishable)
            )

    if (onlyPublishable)
        return transmute(snowball)
            .extend('packageNames', findPackages)
            .extend('structures', getPackageStructures)
            .extend('manifests', getPackageDetails)
            .extend('checks', publishCheck)
            .then(({ packageNames, checks }) =>
                packageNames.filter(name => checks.packages[name].publishable)
            )

    if (onlyChanged)
        return transmute(snowball)
            .extend(getChanges)
            .extend('packageNames', findPackages)
            .extend('structures', getPackageStructures)
            .extend('manifests', getPackageDetails)
            .extend('dependencies', getDependencies)
            .then(({ packageNames, dependencies, changes }) =>
                packageNames.filter(name =>
                    changes.some(
                        ({ scopes }) =>
                            scopes.includes(name) ||
                            scopes.some(scope =>
                                dependencies[name].local.includes(scope)
                            )
                    )
                )
            )

    return findPackages(snowball)
}
```
