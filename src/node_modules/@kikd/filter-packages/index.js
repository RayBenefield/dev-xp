import transmute from 'transmutation'
import getPublishing from '@kikd/publishing'
import findPackages from '@kikd/find-packages'
import publishCheck from '@kikd/publish-check'
import getChanges from '@semcom/command-changes'
import getDependencies from '@kikd/dependency-list'
import getPackageDetails from '@kikd/package-details'
import getPackageStructures from '@kikd/package-structure'
import destinationDetails from '@kikd/destination-details'
import getTypes from '@kikd/package-types'

// eslint-disable-next-line complexity
export default config => snowball => {
    const {
        packageNames,
        allPackages,
        onlyPublishable,
        onlyChanged,
        changedAndPublishable,
        needsPublishing,
    } = config

    if (allPackages) return findPackages(snowball)

    if (Array.isArray(packageNames) && packageNames.length > 0)
        return packageNames

    if (
        !needsPublishing &&
        !changedAndPublishable &&
        !onlyPublishable &&
        !onlyChanged
    )
        return findPackages(snowball)

    const packageBasics = transmute(snowball)
        .extend('packageNames', findPackages)
        .extend('structures', getPackageStructures)
        .extend('types', getTypes(config))
        .extend('manifests', getPackageDetails(config))

    if (needsPublishing)
        return packageBasics
            .extend('checks', publishCheck(config))
            .extend('publishable', ({ packageNames: names, checks }) =>
                names.filter(name => checks.packages[name].publishable)
            )
            .extend('destination', destinationSnowball =>
                destinationDetails({
                    ...destinationSnowball,
                    packages: destinationSnowball.publishable,
                })
            )
            .extend('publishing', getPublishing)
            .then(({ publishing }) => publishing)

    if (onlyPublishable)
        return packageBasics
            .extend('checks', publishCheck(config))
            .then(({ packageNames: names, checks }) =>
                names.filter(name => checks.packages[name].publishable)
            )

    const packageChanges = packageBasics
        .extend(() => getChanges(config))
        .extend('dependencies', getDependencies(config))
        .extend('changed', ({ packageNames: names, dependencies, changes }) =>
            names.filter(name =>
                changes.some(
                    ({ scopes = [] }) =>
                        scopes.includes(name) ||
                        // eslint-disable-next-line max-nested-callbacks
                        scopes.some(scope =>
                            dependencies[name].local.includes(scope)
                        )
                )
            )
        )

    if (changedAndPublishable)
        return packageChanges
            .extend('checks', publishCheck(config))
            .then(({ changed: names, checks }) =>
                names.filter(pkg => checks.packages[pkg].publishable)
            )

    if (onlyChanged) return packageChanges.then(({ changed }) => changed)

    return findPackages(snowball)
}
