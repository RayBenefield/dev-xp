import { isolate } from 'transmutation'
import template from '@kikd/template-building'
import getPackages, { packageFilters } from '@kikd/command-list'
import buildPackages from '@kikd/build-packages'
import deps from '@kikd/command-deps'
import buildConfigs from '@kikd/build-configs'

const filter = ({ allPackages, changedAndPublishable, needsPublishing }) =>
    !allPackages && !changedAndPublishable && !needsPublishing
        ? { onlyPublishable: true }
        : {}

export default function build(config) {
    const newConfig = { ...config, ...filter(config) }

    return getPackages(newConfig)
        .extend('dependencies', deps(newConfig).then(isolate('dependencies')))
        .extendEach('configs', 'packageNames', buildConfigs(newConfig))
}

export const command = () => ({
    name: 'build',
    run: build,
    template,
    effect: buildPackages,
    args: packageFilters,
})
