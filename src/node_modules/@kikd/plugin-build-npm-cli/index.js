import build from '@kikd/build-rollup'
import postBuild from '@kikd/post-build'
import exec from 'rollup-plugin-executable'
import { input, output, postInfo, commonPlugins } from '@kikd/rollup-utils'

const banner = '#!/usr/bin/env node'
const type = 'npm-cli-tool'
const plugins = [...commonPlugins, exec()]

export default {
    type,
    filter: pkg => pkg.bin && pkg.bin.constructor === Object,
    config: ({ baseConfig, dependencies }) => p =>
        Object.values(p.bin)
            .map(file => ({ ...p, file }))
            .map(pkg => ({
                type,
                in: input({
                    pkg,
                    dependencies,
                    plugins: plugins({ executable: true }),
                }),
                out: [output({ format: 'cjs', pkg, banner })],
                post: postInfo({ pkg, baseConfig, dependencies }),
            })),
    build,
    postBuild,
}
