import exec from 'rollup-plugin-executable'
import build from '@kikd/build-rollup'
import postBuild from '@kikd/post-build'
import rollup, { commonPlugins } from '@kikd/rollup-utils'
import { packageJson } from '@kikd/plugin-build-npm-package'

const banner = '#!/usr/bin/env node'
const type = 'npm-cli-tool'
const plugins = [...commonPlugins, exec()]
const rollupConfig = { type, plugins, banner, format: 'cjs' }

export default {
    type,
    filter: ({ srcDir = '.', files = [] }) => {
        const config = packageJson(srcDir, files)
        return config ? config.bin && config.bin.constructor === Object : false
    },
    config: snowball =>
        Object.values(snowball.manifest.bin).map(file =>
            rollup({ ...rollupConfig, ...snowball, file })
        ),
    build,
    postBuild,
}
