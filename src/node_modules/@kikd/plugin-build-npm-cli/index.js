import { resolve } from 'path'

import exec from 'rollup-plugin-executable'
import build from '@kikd/build-rollup'
import postBuild from '@kikd/post-build'
import { input, output, postInfo, commonPlugins } from '@kikd/rollup-utils'

const banner = '#!/usr/bin/env node'
const type = 'npm-cli-tool'
const plugins = [...commonPlugins, exec()]

export default {
    type,
    filter: ({ srcDir = '.', files = [] }) => {
        if (!files.includes('package.json')) return false
        // eslint-disable-next-line global-require, import/no-dynamic-require
        const manifest = require(resolve(srcDir, 'package.json'))
        return manifest.bin && manifest.bin.constructor === Object
    },
    config: ({ baseConfig, dependencies, structure, manifest }) =>
        Object.values(manifest.bin).map(file => ({
            type,
            in: input({ file, dependencies, structure, plugins }),
            out: [output({ structure, file, format: 'cjs', banner })],
            post: postInfo({ structure, manifest, dependencies, baseConfig }),
        })),
    build,
    postBuild,
}
