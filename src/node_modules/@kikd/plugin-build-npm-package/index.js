import { resolve } from 'path'

import build from '@kikd/build-rollup'
import postBuild from '@kikd/post-build'
import rollup, { commonPlugins } from '@kikd/rollup-utils'

const type = 'npm-package'
const rollupConfig = { type, plugins: commonPlugins, format: 'cjs' }

export const packageJson = (srcDir, files) =>
    files.includes('package.json')
        ? // eslint-disable-next-line global-require, import/no-dynamic-require
          require(resolve(srcDir, 'package.json'))
        : false

export default {
    type,
    filter: ({ srcDir = '.', files = [] }) => {
        const manifest = packageJson(srcDir, files)
        return manifest
            ? !manifest.bin && (manifest.main || files.includes('index.js'))
            : false
    },
    config: snowball =>
        rollup({
            ...rollupConfig,
            ...snowball,
            file: snowball.manifest.main || 'index.js',
        }),
    build,
    postBuild,
}
