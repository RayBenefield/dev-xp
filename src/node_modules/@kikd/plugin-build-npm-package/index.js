import { resolve, extname } from 'path'

import fix from '@kikd/fix-node'
import build from '@kikd/build-rollup'
import check from '@kikd/check-package'
import postBuild from '@kikd/post-build'
import getJsDetails from '@kikd/package-details-js'
import rollup, { commonPlugins } from '@kikd/rollup-utils'
import create, { preCreate, createTemplate } from '@kikd/create-package'

const type = 'npm-package'
const rollupConfig = { type, plugins: commonPlugins, format: 'cjs' }

export default {
    type,
    filter: ({ root = '.', srcDir = '.', files = [] }) => {
        if (files.includes('package.json')) {
            // eslint-disable-next-line global-require, import/no-dynamic-require
            const manifest = require(resolve(root, srcDir, 'package.json'))
            if (!manifest.main) return files.includes('index.js')
            return (
                extname(manifest.main) === '.js' || files.includes('index.js')
            )
        }
        return files.includes('index.js')
    },
    manifest: getJsDetails,
    config: snowball =>
        rollup({
            ...rollupConfig,
            ...snowball,
            file: snowball.manifest.main || 'index.js',
            exports: 'named',
        }),
    build,
    postBuild,
    check,
    fix,
    preCreate,
    create,
    createTemplate,
}
