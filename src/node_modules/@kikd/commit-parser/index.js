/* eslint-disable indent */
const regex = /^([^A-Z]*)\(((?:[^A-Z*]*)|\*)\): ([^a-z].*\.)$/;

const toHeaderOrBody = ({ body, matches: [, type, scopes, subject] }) =>
    type
        ? {
              type,
              scopes: scopes.split(',').map(s => s.trim()),
              subject,
          }
        : { body };

const intoSingleCommit = (combined, line) =>
    combined.body && line.body
        ? {
              ...combined,
              body: [combined.body, line.body].join('\n'),
          }
        : {
              ...combined,
              ...line,
          };

export default ({ commits = [] } = {}) =>
    Array.prototype.concat(
        ...commits.map(commit => commit.split(/\r?\n/)).map(lines =>
            lines
                .map(line => ({
                    body: line,
                    matches: line.match(regex) || [],
                }))
                .map(toHeaderOrBody)
                .reduce(intoSingleCommit, {}),
        ),
    );
