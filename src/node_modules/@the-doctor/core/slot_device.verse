
using. /Verse.org/Assets
using. /Verse.org/Random
using. /Fortnite.com/Devices
using. /Verse.org/Simulation
using. /Fortnite.com/Devices/CreativeAnimation
using. /UnrealEngine.com/Temporary/SpatialMath
using. /Fortnite.com/Devices/CreativeAnimation/InterpolationTypes

using. TheDoctor.Materials
using. FantasyWarriorHUD.HUD
using. FantasyWarriorHUD.Icons_Resources
using. Anima
using. Tableau
using. TableauDevice
using. TableauEffect
using. TableauResource
using. Vertex

place_slot_fn := class():
    Prop:creative_prop_asset
    FN<public>(Position:vector3)<suspends>:void=
        MaybeProp := SpawnProp(Prop, Position, IdentityRotation())(0)
        if (P := MaybeProp?, Anim := P.GetAnimationController[]):
            Invisible := Frame(ScaleTo(0.1))
            Visible := Frame(ScaleTo(1.0)).SetTime(0.75).SetEasing(EaseOut)
            Anim.SetAnimation(array. Invisible.Delta(), ?Mode:=animation_mode.OneShot)
            Anim.Play()
            Sleep(0.0)
            Anim.SetAnimation(array. Visible.Delta(P.GetTransform()), ?Mode:=animation_mode.OneShot)
            Anim.Play()

place_item_fn := class():
    Prop:creative_prop_asset
    Mat:M_Item_material
    FN<public>(Position:vector3)<suspends>:void=
        Sleep(2.0)
        MaybeProp := SpawnProp(Prop, Position + vector3{ X := -0.1, Y := 0.0, Z := 0.0 }, IdentityRotation())(0)
        if (P := MaybeProp?, Anim := P.GetAnimationController[]):
            P.SetMaterial(Mat)
            Invisible := Frame(ScaleTo(0.1))
            Visible := Frame(ScaleTo(1.0)).SetTime(0.75).SetEasing(EaseOut)
            Anim.SetAnimation(array. Invisible.Delta(), ?Mode:=animation_mode.OneShot)
            Anim.Play()
            Sleep(0.0)
            Anim.SetAnimation(array. Visible.Delta(P.GetTransform()), ?Mode:=animation_mode.OneShot)
            Anim.Play()

change_item_fn := class():
    Mat:M_Item_material
    ItemTypes:[string]texture
    DefaultItemTexture:texture
    FN<public>(ItemType:string):void=
        set Mat.ItemTexture = ItemTypes[ItemType] or DefaultItemTexture

CreateSlotResource<constructor>(X:int, Y:int, Offset:vector3, Item:string) := resource:
    ID := "{X},{Y}"
    Type := "Slot"
    Props := map:
        "Item Type" => prop_str. Default := Item
        "Location" => prop_vec3. Default := Offset + vector3{ X := 0.0, Y := (Y-1) * 96.0, Z := (X-1) * -96.0 }

slot_device<public> := class(creative_device, config_device, side_effect_device):
    @editable TypeID:string = "Slot"
    @editable SlotProp:creative_prop_asset = DefaultCreativePropAsset
    @editable ItemProp:creative_prop_asset = DefaultCreativePropAsset
    DefaultItemTexture:texture = SPR_HUD_FantasyWarrior_Icon_Tooltip01
    ItemTypes:[string]texture = map:
        "Book_01" => ICON_SM_Item_Book_01
        "Book_02" => ICON_SM_Item_Book_02
        "Book_03" => ICON_SM_Item_Book_03
        "Bottle_02_Bonus" => ICON_SM_Item_Bottle_02_Bonus
        "Bottle_03" => ICON_SM_Item_Bottle_03
        "Bottle_03_Bonus" => ICON_SM_Item_Bottle_03_Bonus
        "Bottle_04" => ICON_SM_Item_Bottle_04
        "Bottle_05" => ICON_SM_Item_Bottle_05
        "Bottle_06" => ICON_SM_Item_Bottle_06
        "Bottle_09" => ICON_SM_Item_Bottle_09
        "Bottle_10" => ICON_SM_Item_Bottle_10
        "Bottle_11" => ICON_SM_Item_Bottle_11
        "Bottle_12" => ICON_SM_Item_Bottle_12
        "Bottle_13" => ICON_SM_Item_Bottle_13
        "Bottle_14" => ICON_SM_Item_Bottle_14
        "Bottle_15" => ICON_SM_Item_Bottle_15
        "Bottle_16" => ICON_SM_Item_Bottle_16
        "Bottle_Clear_01" => ICON_SM_Item_Bottle_Clear_01
        "Bottle_Clear_Labelled_01" => ICON_SM_Item_Bottle_Clear_Labelled_01
        "Bottle_Clear_Labelled_02" => ICON_SM_Item_Bottle_Clear_Labelled_02
        "Bottle_Clear_Labelled_03" => ICON_SM_Item_Bottle_Clear_Labelled_03
        "Bottle_Clear_Labelled_04" => ICON_SM_Item_Bottle_Clear_Labelled_04
        "Bottle_Clear_Labelled_05" => ICON_SM_Item_Bottle_Clear_Labelled_05
        "Bottle_Clear_Labelled_06" => ICON_SM_Item_Bottle_Clear_Labelled_06
        "Bracelet_01" => ICON_SM_Item_Bracelet_01
        "Bracelet_02" => ICON_SM_Item_Bracelet_02
        "Bracelet_03" => ICON_SM_Item_Bracelet_03
        "Crystal_03" => ICON_SM_Item_Crystal_03
        "Crystal_04" => ICON_SM_Item_Crystal_04
        "Crystal_05" => ICON_SM_Item_Crystal_05
        "Envelope_01" => ICON_SM_Item_Envelope_01
        "Eye_01" => ICON_SM_Item_Eye_01
        "Feather_01" => ICON_SM_Item_Feather_01
        "Feather_Pen_02" => ICON_SM_Item_Feather_Pen_02
        "FloatingFlower_01" => ICON_SM_Item_FloatingFlower_01
        "Gem_01" => ICON_SM_Item_Gem_01
        "Gem_03" => ICON_SM_Item_Gem_03
        "Gem_04" => ICON_SM_Item_Gem_04
        "Gem_05" => ICON_SM_Item_Gem_05
        "Goblet_01" => ICON_SM_Item_Goblet_01
        "Hammer_01" => ICON_SM_Item_Hammer_01
        "Hammer_02" => ICON_SM_Item_Hammer_02
        "Hammer_03" => ICON_SM_Item_Hammer_03
        "Hammer_04" => ICON_SM_Item_Hammer_04
        "Hammer_05" => ICON_SM_Item_Hammer_05
        "HoneyJar_01" => ICON_SM_Item_HoneyJar_01
        "Horn_01" => ICON_SM_Item_Horn_01
        "Horseshoe_01" => ICON_SM_Item_Horseshoe_01
        "Ingot_Gold_01" => ICON_SM_Item_Ingot_Gold_01
        "Ingot_Iron_01" => ICON_SM_Item_Ingot_Iron_01
        "Jar_01" => ICON_SM_Item_Jar_01
        "Jar_02" => ICON_SM_Item_Jar_02
        "Jar_03" => ICON_SM_Item_Jar_03
        "Jar_04" => ICON_SM_Item_Jar_04
        "Jar_05" => ICON_SM_Item_Jar_05
        "Jug_01" => ICON_SM_Item_Jug_01
        "Jug_02" => ICON_SM_Item_Jug_02
        "Kettle_01" => ICON_SM_Item_Kettle_01
        "Meat_Ribs_01" => ICON_SM_Item_Meat_Ribs_01
        "Meat_Salami_01" => ICON_SM_Item_Meat_Salami_01
        "Meat_Salami_02" => ICON_SM_Item_Meat_Salami_02
        "Meat_Steak_Cooked_01" => ICON_SM_Item_Meat_Steak_Cooked_01
        "Meat_Steak_Raw_01" => ICON_SM_Item_Meat_Steak_Raw_01
        "Meat_Turkey_Cooked_01" => ICON_SM_Item_Meat_Turkey_Cooked_01
        "Meat_Turkey_Raw_01" => ICON_SM_Item_Meat_Turkey_Raw_01
        "Mortar_01" => ICON_SM_Item_Mortar_01
        "Mug_Tankard_01" => ICON_SM_Item_Mug_Tankard_01
        "Mushroom_01" => ICON_SM_Item_Mushroom_01
        "Ring_10" => ICON_SM_Item_Ring_10
        "Rock_01" => ICON_SM_Item_Rock_01
        "Root_01" => ICON_SM_Item_Root_01
        "Saw_01" => ICON_SM_Item_Saw_01
        "Shovel_01" => ICON_SM_Item_Shovel_01
        "Tongs_01" => ICON_SM_Item_Tongs_01
        "Wood_01" => ICON_SM_Item_Wood_01
        "Wood_02" => ICON_SM_Item_Wood_02
        "Bag_Explorer_01" => ICON_SM_Prop_Bag_Explorer_01

    GetResources<override>():[]resource=
        Offset := GetTransform().Translation
        ItemTypeNames := ItemTypes.Keys()
        for (X := 1..5, Y := 1..5, RandomItem := GetRandomInt(0, ItemTypeNames.Length-1)):
            CreateSlotResource(X, Y, Offset, ItemTypeNames[RandomItem] or "NONE")

    GetResourceID<override>()<computes>:?string= false
    GetPerType<override>()<computes>:?string= option. TypeID
    GetPerSubType<override>()<computes>:?string= false
    GetSideEffects<override>(State:scoped_state)<suspends>:[]side_effect=
        Sleep(0.2)
        Mat := M_Item_material{}
        PlaceSlot := place_slot_fn. Prop := SlotProp
        PlaceItem := place_item_fn{ Prop := ItemProp, Mat := Mat }
        ChangeItem := change_item_fn{ Mat := Mat, ItemTypes := ItemTypes, DefaultItemTexture := DefaultItemTexture }
        array:
            PushSusVec3("Location", PlaceSlot.FN)
            PushSusVec3("Location", PlaceItem.FN)
            PushStr("Item Type", ChangeItem.FN)
            # Debug("Location", "{State.Source} Location")
