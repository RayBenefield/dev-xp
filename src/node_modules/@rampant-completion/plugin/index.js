import get from '@rampant/get'
import { map } from 'rxjs/operators'
import createSearcher from '@kli-tool/searcher'

export default () => {
    const commands = { intent: [] }
    const searchers = { intent: undefined }
    return {
        processIntent: ({ name, aliases }) => {
            commands.intent = [...commands.intent, { name, aliases }]
            searchers.intent = createSearcher({ commands: commands.intent })
        },
        extensions: {
            autocomplete: ({ searcher: searchName, key, value }) =>
                map(payload => {
                    const searcher = searchers[searchName]
                    const command = get({ $: payload }, value)
                    const results = searcher.get(command)
                    if (results.length <= 0)
                        return { ...payload, [key]: 'Unknown' }

                    const result = results[0].name
                    return { ...payload, [key]: result }
                }),
        },
    }
}
