using { Tableau }
using { TableauParticipant }

resource_mutator<public> := class(mutator):
    GameState<public>:game_state
    Repo<public>:resource_repository
    ParticipantRepository<public>:participant_repository

    ApplyEvents<override>(Events:[]domain_event):void=
        for(Ev:Events):
            Handler := case(Ev.Event.Name()):
                "Resource Added" => spawn. AddResource(Ev.EntityID)
                "Resource Renamed" => spawn. RenameResource(Ev.EntityID)
                "Participant Added" => spawn. AddParticipantResource(Ev.EntityID)
                "Property Updated" => spawn. UpdateProperty(Ev.EntityID)
                _ => {}

    AddResource(ResourceID:int)<suspends>:void=
        if (InitialResource := Repo.GetByID[ResourceID]):
            GameState.AddResource(InitialResource)

    RenameResource(ResourceID:int)<suspends>:void=
        Resource := GameState.AwaitResource(ResourceID)
        if (Res := Repo.GetByID[ResourceID]):
            Resource.Name.Set(Res.Name)

    AddParticipantResource(ParticipantID:int)<suspends>:void=
        Participant := GameState.AwaitParticipant(ParticipantID)
        Resources := Repo.GetAll()
        for:
            Resource:Resources
            Count := ParticipantRepository.GetByID[ParticipantID].GetResource(Resource.ID)
        do:
            Participant.AddResource(Resource.ID, Count)

    UpdateProperty(ResourceID:int)<suspends>:void=
        Resource := GameState.AwaitResource(ResourceID)

        if (Res := Repo.GetByID[ResourceID]):
            for:
                PropertyID->PropValues:Res.PropertyValues
                ParticipantID->Value:PropValues
                Property := Resource.Properties[PropertyID]
            do:
                Property.ValueFor(ParticipantID).Set(Value)
