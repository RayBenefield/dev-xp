using { /Verse.org/Simulation }

using { Tableau }

CopyResource<constructor>(Old:resource)<transacts> := resource:
    ID := Old.ID
    StatProps := Old.StatProps
    Props := Old.Props
    Abilities:= Old.Abilities
    PropTypes := Old.PropTypes
    PropNums := Old.PropNums
    PropStrs := Old.PropStrs
    PropFloats := Old.PropFloats

ability<public> := class<concrete>():
    @editable ID<public>:string = ""
    @editable Effects<public>:[]effect = array{}

props<public> := class<concrete>:
    @editable Nums<public>:[]prop_num = array{}
    @editable Strs<public>:[]prop_str = array{}
    @editable Floats<public>:[]prop_float = array{}

prop_type<public> := enum:
    Num
    Str
    Float
    StatNum
    StatStr
    StatFloat
    CompNum
    CompStr
    CompFloat

ToString<public>(Type:prop_type):string = case(Type):
    prop_type.Num => "Num"
    prop_type.Str => "Str"
    prop_type.Float => "Float"
    prop_type.StatNum => "StatNum"
    prop_type.StatStr => "StatStr"
    prop_type.StatFloat => "StatFloat"
    prop_type.CompNum => "CompNum"
    prop_type.CompStr => "CompStr"
    prop_type.CompFloat => "CompFloat"

resource<public> := class<unique><concrete>():
    @editable ID<public>:string = ""
    @editable StatProps<public>:props = props{}
    @editable Props<public>:props = props{}
    @editable Abilities<public>:[]ability = array{}
    var PropTypes<public>:[string]prop_type = map{}
    var PropNums<public>:[string][string]num = map{}
    var PropStrs<public>:[string][string]string = map{}
    var PropFloats<public>:[string][string]float = map{}

    SetProperty<public>(PropertyID:string, ParticipantID:string, Value:num)<decides><transacts>:resource=
        var NewValues:[string][string]num = Self.PropNums
        if (not NewValues[PropertyID]):
            var NewProperty:[string]num = map{}
            if:
                set NewProperty[ParticipantID] = Value
                set NewValues[PropertyID] = NewProperty
        else:
            if (set NewValues[PropertyID][ParticipantID] = Value) {}

        return resource:
            CopyResource<constructor>(Self)
            PropNums := NewValues

    SetProperty<public>(PropertyID:string, ParticipantID:string, Value:string)<decides><transacts>:resource=
        var NewValues:[string][string]string = Self.PropStrs
        if (not NewValues[PropertyID]):
            var NewProperty:[string]string = map{}
            if:
                set NewProperty[ParticipantID] = Value
                set NewValues[PropertyID] = NewProperty
        else:
            if (set NewValues[PropertyID][ParticipantID] = Value) {}

        return resource:
            CopyResource<constructor>(Self)
            PropStrs := NewValues

    SetProperty<public>(PropertyID:string, ParticipantID:string, Value:float)<decides><transacts>:resource=
        var NewValues:[string][string]float = Self.PropFloats
        if (not NewValues[PropertyID]):
            var NewProperty:[string]float = map{}
            if:
                set NewProperty[ParticipantID] = Value
                set NewValues[PropertyID] = NewProperty
        else:
            if (set NewValues[PropertyID][ParticipantID] = Value) {}

        return resource:
            CopyResource<constructor>(Self)
            PropFloats := NewValues

    block:
        for(P:StatProps.Floats). if:
            set PropTypes[P.ID] = prop_type.StatFloat
        for(P:StatProps.Nums). if:
            set PropTypes[P.ID] = prop_type.StatNum
        for(P:StatProps.Strs). if:
            set PropTypes[P.ID] = prop_type.StatStr
        for(P:Props.Floats). if:
            set PropTypes[P.ID] = prop_type.Float
        for(P:Props.Nums). if:
            set PropTypes[P.ID] = prop_type.Num
        for(P:Props.Strs). if:
            set PropTypes[P.ID] = prop_type.Str

