
using. /Verse.org/Simulation
using. /UnrealEngine.com/Temporary/Diagnostics
using. /UnrealEngine.com/Temporary/SpatialMath

using. Goo
using. Numb
using. Tableau
using. Vertex

resource_vm<public> := class():
    State<public>:game_state
    Resource<public>:resource
    var Abilities<public>:[string]action_maker = map{}

    Init<public>():void =
        for (AbilityID->Effects:Resource.Abilities):
            if. set Abilities[AbilityID] = action_maker:
                State := State
                Subject := Resource.ID
                Effects := Effects

    # ValidateProp(PropID:string, Prop:prop):void=
    #     if (Prop.FN <> ""). ProjectLog("{Prop.Type}[{Prop.FN}] does not exist for {Resource.ID}.{PropID}", log_level.Warning)

    GetPropType<public>(PropID:string)<transacts>:prop_type= Resource.GetPropType(PropID)

action_maker<public> := class():
    State<public>:game_state
    Subject<public>:string
    Effects<public>:[]effect

    ActionFor<public>(NewTarget:string):action=
        action:
            State := State
            Subject := Subject
            Target := NewTarget
            Effects := Effects

action<public> := class():
    State<public>:game_state
    Subject<public>:string
    Target<public>:string
    Effects<public>:[]effect

    ExecuteEmpty<public>():void= spawn. Run()
    ExecuteAgentFloat<public>(Agent:agent, Float:float):void= spawn. Run()

    Run()<suspends>:void=
        var Iterator:int = 0
        loop:
            if (Effect := Effects[Iterator]):
                if (Effector := State.EffectorProvider.Get[Effect.FN]):
                    Focus := State.ResolvePath(Subject, Effect.Focus, Target)
                    Tweak := State.ResolvePath(Subject, Effect.Tweak, Target)

                    Commands := Effector.Play(Subject, Target, Focus, Tweak)

                    if (not Commands?). break
                    set Iterator += 1
                else:
                    ProjectLog("[{Effect.FN}] not found", log_level.Warning)
                    break
            else. break
