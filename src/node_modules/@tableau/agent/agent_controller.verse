using { /Verse.org/Simulation }

using { Tableau }

agent_controller<public> := class(controller):
    Dispatcher<public>:dispatcher
    AgentService<public>:agent_service
    Devices<public>:[]possession_device

    Triage<override>()<suspends>:void =
        loop:
            # race:
                # Commands
                Command_Possess()

    Command_Possess()<suspends>:void=
        Commands := for(Device:Devices). Device.PossessCommand

        MaybeCommand := Commands.Race()
        if:
            Command := MaybeCommand?
            NewAgent := Command(0)
            NewParticipant := Command(1)
        then:
            Dispatcher.Dispatch(AgentService.PossessParticipant(NewAgent, NewParticipant))