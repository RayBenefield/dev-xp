
using { /Fortnite.com/Devices }
using { /Verse.org/Simulation }

using { Tableau }

producer_pos_hud_device<public> := class(creative_device, tableau_device):
    @editable ProducerIDs:[]int = array{}

    Init<override>(GameState:game_state)<suspends>:void=
        ProducerPOSHUDManager := producer_pos_hud_manager. GameState := GameState

        loop:
            ID := GameState.ParticipantAdded.Await()
            spawn. ProducerPOSHUDManager.ManageParticipant(ID, ProducerIDs)

producer_pos_hud_manager := class():
    GameState:game_state
    ToMessage<localizes>(Res:string, Count:string):message := "{Res}: {Count}"

    ManageParticipant(ID:int, ProducerIDs:[]int)<suspends>:void =
        if (Participant := GameState.Participants[ID]):
            loop:
                MaybeAgent := Participant.Agent.UpdatedEvent().Await()
                if (Agent := MaybeAgent?):
                    VMs := for:
                        ProducerID:ProducerIDs
                        Producer := GameState.Producers[ProducerID]
                        ProducerParticipant := Producer.Participants[ID]
                        Cost := ProducerParticipant.Cost
                        Count := ProducerParticipant.Count
                    do:
                        VM := producer_pos_vm:
                            ID := ProducerID
                            Name := Producer.Name
                            Cost := Cost
                            Count := Count

                    ProducerPosUI := producer_pos_ui. VMs := VMs
                    if (Player := player[Agent]). ProducerPosUI.AddForPlayer(Player)
