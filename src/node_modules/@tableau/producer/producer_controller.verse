using { Tableau }
using { TableauAgent }

producer_controller<public> := class(controller):
    Dispatcher<public>:dispatcher
    ProducerService<public>:producer_service
    CollectionDevices<public>:[]collection_device
    Effect<public>:buy_producer_effect

    Triage<override>()<suspends>:void =
        if (CollectionDevices.Length <= 0). return
        loop:
            race:
                # Commands
                Command_Buy()
                Command_Collect()

    Command_Buy()<suspends>:void=
        Command := Effect.BuyProducerCommand.Await()
        if:
            ProducerID := Command.Subjects[0]
            BuyerID := Command.Targets[0]
        then:
            Dispatcher.Dispatch(ProducerService.Buy(ProducerID, BuyerID))

    Command_Collect()<suspends>:void=
        Commands := for(Device:CollectionDevices). Device.CollectCommand
        MaybeCommand := Commands.Race()
        if:
            Command := MaybeCommand?
        then:
            Dispatcher.Dispatch(ProducerService.Collect())
