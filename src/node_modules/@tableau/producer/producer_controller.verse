using { Tableau }
using { TableauAgent }

producer_controller<public> := class(controller):
    Dispatcher<public>:dispatcher
    ProducerService<public>:producer_service
    Devices<public>:[]producer_location_device
    CollectionDevices<public>:[]collection_device

    Triage<override>()<suspends>:void =
        if (Devices.Length <= 0 and CollectionDevices.Length <= 0). return
        loop:
            race:
                # Commands
                Command_Buy()
                Command_Collect()

    Command_Buy()<suspends>:void=
        BuyCommands := for(Device:Devices). Device.BuyCommand

        MaybeCommand := BuyCommands.Race()
        if:
            Command := MaybeCommand?
            ProducerID := Command.Subjects[0]
            BuyerID := Command.Targets[0]
        then:
            Dispatcher.Dispatch(ProducerService.Buy(ProducerID, BuyerID))

    Command_Collect()<suspends>:void=
        Commands := for(Device:CollectionDevices). Device.CollectCommand
        MaybeCommand := Commands.Race()
        if:
            Command := MaybeCommand?
        then:
            Dispatcher.Dispatch(ProducerService.Collect())
