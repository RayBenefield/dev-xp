using { Tableau }
using { TableauAgent }

producer_controller<public> := class(controller):
    Dispatcher<public>:dispatcher
    ProducerService<public>:producer_service
    BuyEffect<public>:buy_producer_effect
    ProduceEffect<public>:produce_effect

    Triage<override>()<suspends>:void =
        loop:
            race:
                # Commands
                Command_Buy()
                Command_Produce()

    Command_Buy()<suspends>:void=
        Command := BuyEffect.BuyProducerCommand.Await()
        if:
            ProducerID := Command.Subjects[0]
            BuyerID := Command.Targets[0]
        then:
            Dispatcher.Dispatch(ProducerService.Buy(ProducerID, BuyerID))

    Command_Produce()<suspends>:void=
        Command := ProduceEffect.ProduceCommand.Await()
        if:
            ProducerID := Command.Subjects[0]
            ParticipantID:= Command.Targets[0]
        then:
            Dispatcher.Dispatch(ProducerService.Produce(ProducerID, ParticipantID))
