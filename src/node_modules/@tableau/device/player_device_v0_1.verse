
using. /Verse.org/Simulation
using. /Fortnite.com/Characters

using. Tableau

player_controller_v0_1<public> := class():
    var Agent<public>:?agent = false
    var Visible<public>:logic = false
    var AllowTurning<public>:logic = false
    var AllowFalling<public>:logic = false
    var AllowEmotes<public>:logic = false

    SetVisibility<public>(Value:logic):void=
        set Visible = Value; ApplySettings();
    SetTurning<public>(Value:logic):void=
        set AllowTurning = Value; ApplySettings();
    SetFalling<public>(Value:logic):void=
        set AllowFalling = Value; ApplySettings();
    SetEmotes<public>(Value:logic):void=
        set AllowEmotes = Value; ApplySettings();
    SetAgent<public>(Value:?agent):void=
        set Agent = Value; ApplySettings();

    ApplySettings<public>():void= if (A := Agent?):
        ApplyStasis(A)
        ApplyVisibility(A)
    ApplyStasis<public>(A:agent):void= if (Char := A.GetFortCharacter[]):
        StasisArgs := stasis_args:
            AllowTurning := AllowTurning
            AllowFalling := AllowFalling
            AllowEmotes := AllowEmotes
        Char.PutInStasis(StasisArgs)
    ApplyVisibility<public>(A:agent):void= if (Char := A.GetFortCharacter[]):
        if(Visible?). Char.Show() else. Char.Hide()

player_device_v0_1 := class(tableau_device):
    DeviceType<override>:string = "PLAYER"

    @editable Visible:bool_plug = bool_plug{}
    @editable AllowTurning:bool_plug = bool_plug{}
    @editable AllowFalling:bool_plug = bool_plug{}
    @editable AllowEmotes:bool_plug = bool_plug{}

    GetResources<override>():[]resource= array. resource:
        Type := ResourceID
        Props := map:
            "Possessed By" => NoAgent()
            "Visible" => Bool of Visible
            "Allow Turning" => Bool of AllowTurning
            "Allow Falling" => Bool of AllowFalling
            "Allow Emotes" => Bool of AllowEmotes

    GetSideEffects<override>(State:scoped_state)<suspends>:[]side_effect=
        Controller := player_controller_v0_1{}
        array:
            PushAgent("Possessed By", Controller.SetAgent)
            PushBool("Visible", Controller.SetVisibility)
            PushBool("Allow Turning", Controller.SetTurning)
            PushBool("Allow Falling", Controller.SetFalling)
            PushBool("Allow Emotes", Controller.SetEmotes)
