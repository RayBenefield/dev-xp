
using { /Verse.org/Assets }
using { /Verse.org/Simulation }
using { /Fortnite.com/Devices }
using { /UnrealEngine.com/Assets }
using { /UnrealEngine.com/Temporary/SpatialMath }

using { Tableau }

spawn_vfx_fn := class():
    VFX:particle_system
    Position:vector3
    FN<public>():void= SpawnParticleSystem(VFX, Position)

spawn_vfx_device<public> := class(creative_device, tableau_device):
    @editable ResourceID:string = ""
    @editable PropertyID:string = ""
    @editable GuardPropertyID:?string = false
    @editable RefPosition:creative_prop = creative_prop{}
    @editable Offset:vector3 = vector3{}
    VFX<public>:?particle_system = false

    Init<override>(GameState:game_state)<suspends>:void=
        Watcher := participant_watcher{ GameState := GameState, OnPossessed := HandleVFX }
        spawn. Watcher.Start()

    HandleVFX(GameState:game_state, ParticipantID:string, Agent:agent)<suspends>:void=
        if (Guard := GuardPropertyID?). GameState.AfterTrue(ResourceID, Guard, ParticipantID)

        if (V := VFX?):
            Position := RefPosition.GetTransform().Translation + Offset
            SpawnVFX := spawn_vfx_fn{ VFX := V, Position := Position }
            GameState.OnUpdated(ResourceID, PropertyID, ParticipantID, SpawnVFX.FN)
