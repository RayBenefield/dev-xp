
using. /Verse.org/Simulation
using. /Fortnite.com/Devices

using. Vertex

watched_property_v0_1 := class<concrete>():
    @editable PropertyID:string = "Property"
    @editable PropertyType:prop_type = prop_type.UnknownType
    @editable PropertySource:prop_path = prop_path{}

generator_device_v0_1<public> := class(tableau_device):
    DeviceType<override>:string = "GENERATOR"

    @editable ResourceToGenerate:string = "Type"
    @editable IDSource:prop_path = prop_path{}
    @editable OnCreateActions:[]prop_path = array{}
    @editable WatchedProperties:[]watched_property_v0_1 = array{}
    @editable AutoGenerate:bool_plug = bool_plug{}

    GetResources<override>():[]resource= array. resource:
        Props := map:
            "AutoGenerate" => Bool of AutoGenerate
        Actions := map:
            "Create {ResourceToGenerate}" => Action()

    GetSideEffects<override>()<suspends>:[]side_effect=
        Hydrator := hydrator{ Resource := hydrated_resource. Type := ResourceToGenerate }
        BaseSideEffects := array:
            Generate(Hydrator.GenerateResourceEvent)
            Push("Create {ResourceToGenerate}", Hydrator.TriggerGenerate)
            PushBool("AutoGenerate", Hydrator.SyncAutoGenerate)
            PushStr(IDSource, Hydrator.SyncID)
        AttachedActions := for(Create:OnCreateActions). Attach(Create, Hydrator.GeneratedResourceEvent)
        Watched := for(Property:WatchedProperties, ID := Property.PropertyID, Source := Property.PropertySource). case(Property.PropertyType):
            prop_type.IntegerType => PushInt(Source, Hydrator.SyncInt(ID).SetFN)
            prop_type.StrType => PushStr(Source, Hydrator.SyncString(ID).SetFN)
            prop_type.Vec3Type => PushVec3(Source, Hydrator.SyncVec3(ID).SetFN)
            _ => Debug(Source)

        # TODO: Changing the order of these is a problem for some reason
        CombineAllArrays(AttachedActions, BaseSideEffects, Watched)
