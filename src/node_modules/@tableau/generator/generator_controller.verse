using { Tableau }
using { TableauAgent }

generator_controller<public> := class(controller):
    Dispatcher<public>:dispatcher
    GeneratorService<public>:generator_service
    Devices<public>:[]generator_location_device
    CollectionDevices<public>:[]collection_device

    Triage<override>()<suspends>:void =
        if (Devices.Length <= 0 and CollectionDevices.Length <= 0). return
        loop:
            race:
                # Commands
                Command_Buy()
                Command_Collect()

    Command_Buy()<suspends>:void=
        BuyCommands := for(Device:Devices). Device.BuyCommand

        MaybeCommand := BuyCommands.Race()
        if:
            Command := MaybeCommand?
            GeneratorID := Command.Subjects[0]
            BuyerID := Command.Targets[0]
        then:
            Dispatcher.Dispatch(GeneratorService.Buy(GeneratorID, BuyerID))

    Command_Collect()<suspends>:void=
        Commands := for(Device:CollectionDevices). Device.CollectCommand
        MaybeCommand := Commands.Race()
        if:
            Command := MaybeCommand?
        then:
            Dispatcher.Dispatch(GeneratorService.Collect())
