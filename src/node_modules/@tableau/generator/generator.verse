using { /Verse.org/Simulation }

using { Tableau }
using { TableauAction }

cost<public> := class<concrete>:
    @editable Amount:num = num{}
    @editable Type:int = 0

CopyGenerator<constructor><public>(Old:generator)<transacts> := generator:
    ID := Old.ID
    Production := Old.Production
    MaxCount := Old.MaxCount
    ResourceID := Old.ResourceID
    Cost := Old.Cost
    Counts := Old.Counts
    Abilities := Old.Abilities

generator_int_lenses := enum:
    ID
    # MaxCount
    AllOwners
    ResourceID
    # OwnerCount
    # Counts

generator_num_lenses := enum:
    # Production
    ProductionRate

generator_ability<public> := class<concrete>:
    @editable Subjects:generator_int_lenses = generator_int_lenses.AllOwners
    @editable Targets:generator_int_lenses = generator_int_lenses.ResourceID
    @editable Magnitudes:generator_num_lenses = generator_num_lenses.ProductionRate
    @editable AfterEffects:[]effect_type = array. effect_type.AddResources

# TODO: Initialize all counts to not be higher than the MaxCount
# TODO: HasAny function to check if a participant has any of this generator
generator<public> := class<concrete>():
    @editable ID<public>:int = 0
    @editable Production<public>:num = num. Value := 1.67
    @editable MaxCount<public>:int = 1
    @editable ResourceID<public>:?int = false
    @editable Cost<public>:?cost = false
    Counts<public>:[int]int = map{}
    CommandMaker<public>:?command_maker = false
    @editable Abilities<public>:[]generator_ability = array{}

    GetCount<public>(CounterID:int)<computes>:int = Counts[CounterID] or 0
    IsMaxed<public>(CounterID:int)<decides><transacts>:void = GetCount(CounterID) >= MaxCount

    GetProductionRate<public>(ParticipantID:int):num=
        Count := GetCount(ParticipantID)
        if (Count = 0). return num{}
        Production * Count

    IncreaseCount<public>(CounterID:int)<decides><transacts>:generator=
        if(IsMaxed[CounterID]). false?

        var NewCounts:[int]int = Self.Counts
        if (set NewCounts[CounterID] = NewCounts[CounterID] + 1 or 1) {}

        return generator:
            CopyGenerator<constructor>(Self)
            Counts := NewCounts

ToString<public>(Gen:generator):string=
    var Result:string = "\n"
    set Result += "  Generator #{Gen.ID}:\n"
    set Result += "\t- Max Count: {Gen.MaxCount}\n"
    set Result += "\t- Production Rate: {Gen.Production}\n"
    set Result += "\t- Counts ({Gen.Counts.Length}):\n"

    for (ID->Count:Gen.Counts). set Result += "\t\t{ID} -> {Count}\n"

    return Result
