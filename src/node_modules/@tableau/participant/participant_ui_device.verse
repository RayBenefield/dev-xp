
using { /Fortnite.com/Devices }
using { /Verse.org/Simulation }
using { /UnrealEngine.com/Temporary/Diagnostics }
using { /Verse.org/Simulation/Tags }

using { Tableau }
using { TableauAgent }
using { TableauProducer }

participant_ui_tag := class(tag){}
participant_ui_device<public> := class(creative_device, updatable):

    # Entity State Management
    var CurrentAgent:?agent = false
    var ProducerRepository:?producer_repository = false
    var AgentRepository:?agent_repository = false
    var CurrentState:?string = false

    # Device Properties
    @editable HUD:hud_message_device = hud_message_device{}

    # Messages
    NotAParticipant<localizes><private>():message := "Not a Participant"
    Participant<localizes><private>(ID:string, ProducerCount:int):message := "Participant ID: {ID}\nProducers: {ProducerCount}"

    Subscriptions<override>()<transacts>:[]event_subscription = array:
        event_subscription:
            SubjectType := entity_participant{}
    ClearState<override>():void= set CurrentState = false
    Update<override>()<suspends>:void=
        # No Animation Update
        if:
            Agent := CurrentAgent?
            ID := AgentRepository?.GetParticipant[Agent]?
            ProdRepo := ProducerRepository?
        then:
            Producers := ProdRepo.GetOwnedProducers(ID)
            HUD.SetText(Participant(ID, Producers.Length))
            set CurrentState = option. ID
        else:
            HUD.SetText(NotAParticipant())
            set CurrentState = false

    Initialize<public>(
        ProducerRepo:producer_repository,
        AgentRepo:agent_repository
    )<suspends>:void=
        set CurrentAgent = option. GetPlayspace().GetPlayers()[0]

        set ProducerRepository = option. ProducerRepo
        set AgentRepository = option. AgentRepo
        spawn. FreshUpdate()

LoadParticipantUIDevices<public>():[]participant_ui_device=
    TaggedDevices := GetCreativeObjectsWithTag(participant_ui_tag{})
    for(Index -> Tagged : TaggedDevices, Device := participant_ui_device[Tagged]). Device
