
using { /Fortnite.com/Devices }
using { /Verse.org/Simulation }
using { /UnrealEngine.com/Temporary/Diagnostics }
using { /Verse.org/Simulation/Tags }

using { Tableau }
using { TableauAgent }
using { TableauResource }
using { TableauProducer }

participant_board_tag := class(tag){}
participant_board_device<public> := class(creative_device, updatable):

    # Entity State Management
    @editable ParticipantID:string = ""
    var ResourceRepository:?resource_repository = false
    var ProducerRepository:?producer_repository = false
    var ParticipantRepository:?participant_repository = false

    # Device Properties
    @editable Board:billboard_device = billboard_device{}

    # Messages
    ParticipantLabel<localizes><private>(ID:string):message := "Participant ID: {ID}"
    ProducerCount<localizes><private>(Count:int):message := "Producers: {Count}"
    ResourceCount<localizes><private>(Resource:string, Count:string):message := "{Resource}: {Count}"

    Subscriptions<override>()<transacts>:[]event_subscription = array:
        event_subscription:
            SubjectType := entity_participant{}
            Subject := option. ParticipantID
    ClearState<override>():void= {}
    Update<override>()<suspends>:void=
        if:
            ProdRepo := ProducerRepository?
            Participant := ParticipantRepository?.GetByID[ParticipantID]
            Resources := Participant.Resources
        then:
            Producers := ProdRepo.GetOwnedProducers(ParticipantID)
            var Text:message = ParticipantLabel(ParticipantID) + NL()
            set Text = Text + ProducerCount(Producers.Length) + NL()
            for (ResourceID->Count:Resources, Resource := ResourceRepository?.GetByID[ResourceID]):
                set Text = Text + ResourceCount(Resource.Name, "{Count}") + NL()
            Board.SetText(Text)

    Initialize<public>(
        ResourceRepo:resource_repository,
        ProducerRepo:producer_repository,
        ParticipantRepo:participant_repository
    )<suspends>:void=
        set ResourceRepository = option. ResourceRepo
        set ProducerRepository = option. ProducerRepo
        set ParticipantRepository = option. ParticipantRepo
        spawn. FreshUpdate()

LoadParticipantBoardDevices<public>():[]participant_board_device=
    TaggedDevices := GetCreativeObjectsWithTag(participant_board_tag{})
    for(Index -> Tagged : TaggedDevices, Device := participant_board_device[Tagged]). Device
