import '@dev-xp/config'
import createDb from '@rampant/db'
import weekOf from '@rampant-giveaway/week-of'
import { createLogger } from '@rampant/logger'
import createMixerChat from '@rampant-mixer/chat'
import selection from '@rampant-giveaway/selection'

const {
    MIXER_CLIENT_ID: clientId,
    DATABASE_ID: dbId,
    LOG_LEVEL,
    STREAMER_ID: userId,
    CHANNEL_ID: channelId,
} = process.env

const logger = createLogger({ level: LOG_LEVEL })
const db = createDb({ id: dbId, logger })
const mixerChat = createMixerChat({ clientId, db })
mixerChat({ channelId, userId }).then(moderator => {
    logger.platform(`Chat setup for [${channelId}] as [${userId}]`)

    const sunday = weekOf(new Date(), 0)
    const week = `${sunday.getFullYear()}-${sunday.getMonth() +
        1}-${sunday.getDate()}`
    logger.platform(`Collecting entries for the week of: ${week}`)
    selection({ prefix: week, db, moderator, logger })
})
