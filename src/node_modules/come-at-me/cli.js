import { resolve } from 'path'

import { config } from 'dotenv'
import createDb from '@rampant-firebase/db'
import weekOf from '@rampant-giveaway/week-of'
import { createLogger } from '@rampant/logger'
import createMixerChat from '@rampant-mixer/chat'
import comeAtMe from '@rampant-giveaway/come-at-me'
import { sync as root } from '@kikd/find-repo-root'
import selection from '@rampant-giveaway/selection'

config({ path: resolve(root(), '.env') })

const {
    MIXER_CLIENT_ID: clientId,
    DATABASE_ID: dbId,
    LOG_LEVEL,
    STREAMER_ID: userId,
    CHANNEL_ID: channelId,
} = process.env

const logger = createLogger({ level: LOG_LEVEL })
const db = createDb({ id: dbId, logger })
const mixerChat = createMixerChat({ clientId, db })
mixerChat({ channelId, userId }).then(moderator => {
    logger.platform(`Chat setup for [${channelId}] as [${userId}]`)

    const monday = weekOf(new Date(), 0)
    const week = `${monday.getFullYear()}-${monday.getMonth() +
        1}-${monday.getDate()}`
    logger.platform(`Collecting entries for the week of: ${week}`)
    comeAtMe({ prefix: `${week}-`, db, logger, moderator })
    selection({ prefix: `${week}-`, db, moderator, logger })
})
