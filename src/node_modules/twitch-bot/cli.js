import '@dev-xp/config'
import createDb from '@rampant/db'
import { tap } from 'rxjs/operators'
import createCrypto from '@dev-xp/crypto'
import createRepo from '@rampant-auth/repo'
// import weekOf from '@rampant-giveaway/week-of'
import { createLogger } from '@rampant/logger'
import createTwitchChat from '@rampant-twitch/chat'
// import selection from '@rampant-giveaway/selection'

const {
    TWITCH_CLIENT_ID: id,
    TWITCH_CLIENT_SECRET: secret,
    DATABASE_ID: dbId,
    LOG_LEVEL,
    STREAMER_ID: userId,
    ENCRYPTION_KEY: encryptionKey,
} = process.env

const logger = createLogger({ level: LOG_LEVEL })
const db = createDb({ id: dbId, logger })
const crypto = createCrypto(encryptionKey)
const authRepo = createRepo({ db, crypto })
const chatCreator = createTwitchChat({ id, secret, authRepo })

chatCreator({ userId, channelId: userId }).then(chat =>
    chat
        .pipe(
            tap(({ channel, user, text, details }) =>
                db.push('twitch-chat-log', {
                    channel,
                    user,
                    text,
                    details,
                })
            ),
            tap(({ user, text }) => console.log(`[${user}]: ${text}`))
        )
        .subscribe()
)
