import log from '@dev-xp/log'
import gitStatus from '@semcom/git-status'
import { silent as git } from '@dev-xp/git'
import resetVsAdd from '@semcom/reset-vs-add'
import relevantDiffs from '@semcom/relevant-diffs'
import requestCommit from '@semcom/request-commit'
import transmute, { isolate } from 'transmutation'

export default function status() {
    return transmute({})
        .extend('files', () => git.status().then(isolate('files')))
        .extend('statusFiles', gitStatus)
        .extend('filesToCommit', ({ statusFiles }) =>
            requestCommit(statusFiles)
        )
        .extend('resetVsAdd', ({ statusFiles, filesToCommit }) =>
            resetVsAdd({ statusFiles, filesToCommit })
        )
        .extend('diffs', () => git.diff())
        .extend('diffsForCommit', relevantDiffs())
}

export const command = () => ({
    name: 'commit',
    aliases: ['ci'],
    run: status,
})
