import parse from '@semcom/commit-parser'
import configureGit from 'simple-git/promise'

const git = configureGit()

// https://git-scm.com/docs/pretty-formats
export default ({ from, to = 'HEAD' } = {}) =>
    git
        .log({
            from,
            to,
            format: {
                hash: '%H',
                message: '%B',
            },
        })
        .then(({ all }) =>
            Promise.all(
                all.map(commit =>
                    git
                        .show(['--pretty=', '--name-only', commit.hash])
                        .then(files => files.trim().split('\n'))
                        .then(files => ({ ...commit, files }))
                )
            )
        )
        .then(commits => ({ commits }))
        .then(parse)
